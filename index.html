<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>六爻天机 - 东方命理美学</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 3. Lunar.js -->
    <script src="https://unpkg.com/lunar-javascript@1.6.12/lunar.js"></script>
    
    <!-- 4. Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- [新增] 引入运势数据库 -->
    <script src="fortunes.js"></script>
    
    <!-- 5. 不蒜子 -->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap');
        
        :root {
            --bg-paper: #f9f7f2;
            --ink-primary: #2b2b2b;
            --cinnabar: #c02c38;
        }

        body {
            font-family: 'Lora', 'Noto Serif SC', serif;
            background-color: #e5e5e5;
            color: var(--ink-primary);
            -webkit-font-smoothing: antialiased;
            /* 桌面端背景纹理 */
            background-image: radial-gradient(#d4d4d4 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        /* 核心应用容器 */
        #app-frame {
            background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='64' height='64' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M8 16c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm0-2c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zm33.414-6l5.95-5.95L45.95.636 40 6.586 34.05.636 32.636 2.05 38.586 8l-5.95 5.95 1.414 1.414L40 9.414l5.95 5.95 1.414-1.414L41.414 8zM40 4.828l4.536 4.536L40 13.899l-4.536-4.536L40 4.828zM16 48c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm0-2c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zM8 32c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm0-2c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zm33.414 32l5.95-5.95L45.95 48.636 40 54.586 34.05 48.636 32.636 50.05 38.586 56l-5.95 5.95 1.414 1.414L40 57.414l5.95 5.95 1.414-1.414L41.414 56zM40 52.828l4.536 4.536L40 61.899l-4.536-4.536L40 52.828z' fill='%23d6d3cd' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
            
            /* 基础样式 */
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* === 视图模式控制 === */
        
        /* 手机模式 (强制窄屏) */
        .mode-mobile {
            width: 100%;
            height: 100vh;
            max-width: 430px;
            margin: 0 auto;
            border-left: 1px solid rgba(0,0,0,0.05);
            border-right: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
        }
        /* 如果屏幕够大，手机模式也要有边距 */
        @media (min-width: 450px) {
            .mode-mobile {
                height: 92vh;
                border-radius: 24px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
        }

        /* 桌面模式 (宽屏) */
        .mode-desktop {
            width: 100%;
            height: 100vh;
            max-width: 1024px; /* 更宽的桌面体验 */
            margin: 0 auto;
        }
        @media (min-width: 1040px) {
            .mode-desktop {
                height: 92vh;
                border-radius: 20px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
        }

        /* 隐藏滚动条 */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* 六爻 - Grid 布局 */
        .grid-hex-row {
            display: grid;
            align-items: center;
            grid-template-columns: 2.5rem 2.5rem 3.5rem 1fr 2rem;
            gap: 0.5rem;
        }
        .grid-hex-row.is-en {
            grid-template-columns: 4.5rem 4.5rem 3.5rem 1fr 3.5rem;
        }

        /* 组件样式 */
        .yang-stroke { 
            height: 10px; width: 100%; 
            background: linear-gradient(180deg, #d63031 0%, #c0392b 100%);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(192, 57, 43, 0.3);
        }
        .yin-stroke-wrapper { display: flex; justify-content: space-between; width: 100%; }
        .yin-stroke { 
            height: 10px; width: 42%; 
            background: linear-gradient(180deg, #636e72 0%, #2d3436 100%);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(45, 52, 54, 0.3);
        }

        /* 铜钱 */
        .coin-wrapper { perspective: 1000px; width: 72px; height: 72px; }
        .coin-3d {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .coin-face, .coin-back {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 4px 6px rgba(0,0,0,0.3);
            background: radial-gradient(circle at 30% 30%, #fdf5e6, #e6c17b, #b8860b);
            border: 2px solid #b8860b;
        }
        .coin-back { transform: rotateY(180deg); }
        .coin-hole {
            width: 24px; height: 24px; background: #2b2b2b;
            border: 1px solid #b8860b; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.8);
            position: absolute; z-index: 10;
        }
        .qian-long {
            position: absolute; width: 100%; height: 100%;
            font-family: 'Ma Shan Zheng', cursive;
            font-weight: bold; color: #5c4013;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4), inset 0 1px 1px rgba(0,0,0,0.8);
        }
        .char-top { position: absolute; top: 4px; left: 50%; transform: translateX(-50%); font-size: 14px; }
        .char-bottom { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); font-size: 14px; }
        .char-right { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 14px; }
        .char-left { position: absolute; left: 4px; top: 50%; transform: translateY(-50%); font-size: 14px; }
        .manchu-squiggle {
            width: 10px; height: 20px; border-left: 2px solid #5c4013; border-radius: 50%; position: absolute;
        }
        .is-spinning { animation: spinCoin 0.6s infinite linear; }
        @keyframes spinCoin {
            0% { transform: rotateY(0deg) rotateX(0deg); }
            100% { transform: rotateY(1080deg) rotateX(360deg); }
        }

        /* 侧边栏 (Fixed定位) */
        .history-drawer-wrapper { position: absolute; inset: 0; z-index: 100; overflow: hidden; pointer-events: none; }
        .history-drawer-wrapper.is-open { pointer-events: auto; }
        
        .history-drawer {
            position: absolute; top: 0; left: 0; bottom: 0;
            width: 85%; max-width: 320px;
            background: rgba(253, 251, 247, 0.98);
            backdrop-filter: blur(12px);
            box-shadow: 10px 0 40px rgba(0,0,0,0.15);
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; z-index: 102;
        }
        .is-open .history-drawer { transform: translateX(0); }
        .history-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 101;
            opacity: 0; transition: opacity 0.3s;
        }
        .is-open .history-overlay { opacity: 1; }
        .history-item {
            background: white; border: 1px solid #f0f0f0; padding: 12px; margin-bottom: 8px;
            border-radius: 8px; border-left: 3px solid #d4d4d4; transition: all 0.2s;
        }
        .history-item:active { transform: scale(0.98); background: #fafafa; }
        .history-tag-liuyao { border-left-color: var(--cinnabar); }
        .history-tag-bazi { border-left-color: var(--ink-primary); }

        /* 卡片风格 */
        .card-neo {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 10px 15px -3px rgba(0, 0, 0, 0.03);
            backdrop-filter: blur(10px); border-radius: 16px;
        }
        .bazi-pillar-card {
            background: linear-gradient(to bottom, #ffffff, #fdfbf7);
            border: 1px solid #efebe4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 12px 0; transition: all 0.3s;
        }
        /* Desktop模式下八字卡片优化 */
        .mode-desktop .bazi-pillar-card { padding: 24px 0; font-size: 1.1em; }

        .dayun-capsule {
            min-width: 3.8rem; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0.6rem 0; border-radius: 12px; font-size: 0.75rem;
            background: #ffffff; border: 1px solid #e5e5e5; color: #595959;
            transition: all 0.2s;
        }
        .dayun-selected {
            background: linear-gradient(135deg, #c02c38, #a9232e) !important;
            border-color: #a9232e !important; color: white !important;
            box-shadow: 0 4px 10px rgba(192, 44, 56, 0.3); transform: translateY(-2px);
        }
        .dayun-selected * { color: white !important; }
        .dayun-current-border { border: 1.5px solid #c02c38; background-color: #fff5f5; }

        .btn-primary {
            background: var(--ink-primary); color: #f7f5f0;
            border-radius: 12px; box-shadow: 0 4px 12px rgba(43, 43, 43, 0.25);
            transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-action-wechat { background: #07C160; color: white; box-shadow: 0 4px 10px rgba(7, 193, 96, 0.3); }
        .btn-action-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }
        
        .tab-switcher {
            background: #e8e6e1; padding: 4px; border-radius: 14px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-item { border-radius: 10px; transition: all 0.3s ease; color: #787878; font-weight: 500; }
        .tab-active { background: white; color: var(--cinnabar); box-shadow: 0 2px 5px rgba(0,0,0,0.08); font-weight: 700; }

        .wx-wood { color: #2d6a4f; } .wx-fire { color: #d63031; } .wx-earth { color: #a0522d; } 
        .wx-metal { color: #636e72; } .wx-water { color: #0984e3; } 
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active { transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .slide-up-enter-from { opacity: 0; transform: translateY(20px); }
        .slide-up-enter-to { opacity: 1; transform: translateY(0); }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s; }
        .toast-enter-from, .toast-leave-to { transform: translateY(-100%); opacity: 0; }

        /* 新增：数据库内容样式 */
        .db-meaning-box {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .db-label {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
            display: block;
        }
        .db-text {
            font-size: 14px;
            color: #444;
            line-height: 1.6;
            font-family: 'Lora', 'Noto Serif SC', serif;
        }
        .db-desc {
            font-style: italic;
            color: #666;
            margin-top: 8px;
            font-size: 13px;
        }
    </style>
</head>
<body>

<div id="app" class="w-full flex justify-center">

    <!-- 动态绑定的容器，根据 viewMode 切换 class -->
    <div :class="viewMode === 'mobile' ? 'mode-mobile' : 'mode-desktop'" id="app-frame">

        <!-- History Drawer Container -->
        <div class="history-drawer-wrapper" :class="{ 'is-open': historyOpen }">
            <div class="history-overlay" @click="historyOpen = false"></div>
            <aside class="history-drawer p-5">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-stone-200">
                    <h3 class="font-serif font-bold text-xl text-stone-800 flex items-center gap-2">
                        <i class="ph-bold ph-scroll text-[#c02c38] leading-none"></i> {{ t('history_title') }}
                    </h3>
                    <button @click="historyOpen = false" class="text-stone-400 hover:text-stone-600 p-2">
                        <i class="ph-bold ph-x text-2xl leading-none"></i>
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-3 no-scrollbar">
                    <div v-if="historyList.length === 0" class="text-center text-stone-400 text-xs py-10 italic leading-relaxed font-serif">
                        {{ t('history_empty') }}<br>Glimpses of fate appear here
                    </div>
                    
                    <div v-for="(item, idx) in historyList" :key="item.id" 
                         @click="loadRecord(item)"
                         class="history-item cursor-pointer shadow-sm hover:shadow-md"
                         :class="item.type === 'liuyao' ? 'history-tag-liuyao' : 'history-tag-bazi'">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-stone-700 text-sm font-serif">
                                {{ item.type === 'liuyao' ? item.title : t('history_bazi') }}
                            </span>
                            <span class="text-[10px] text-stone-400 font-mono">{{ formatDateSimple(item.timestamp) }}</span>
                        </div>
                        <div class="text-xs text-stone-500 truncate mb-2 font-serif">{{ item.question || t('history_no_q') }}</div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] bg-stone-100 px-1.5 py-0.5 rounded text-stone-400 uppercase tracking-wider font-sans">{{ item.type }}</span>
                            <button @click.stop="deleteRecord(item.id)" class="text-stone-300 hover:text-red-400 p-1">
                                <i class="ph-bold ph-trash leading-none"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Toast -->
        <transition name="toast">
            <div v-if="toast.show" class="absolute top-6 left-0 right-0 z-50 flex justify-center pointer-events-none">
                <div class="bg-stone-900/90 backdrop-blur text-white px-4 py-2.5 rounded-full shadow-xl text-sm flex items-center gap-2 pointer-events-auto">
                    <i v-if="toast.type === 'success'" class="ph-fill ph-check-circle text-green-400 text-lg leading-none"></i>
                    <i v-else class="ph-fill ph-info text-blue-400 text-lg leading-none"></i>
                    <span class="font-medium font-sans">{{ toast.message }}</span>
                </div>
            </div>
        </transition>

        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-5 shrink-0 sticky top-0 z-40 bg-[#f9f7f2]/80 backdrop-blur-md border-b border-stone-200/60">
            <!-- Left: History Button -->
            <button @click="historyOpen = true" class="w-9 h-9 flex items-center justify-center rounded-full bg-white border border-stone-200 shadow-sm active:scale-90 transition text-stone-600 hover:text-[#c02c38]">
                <i class="ph-bold ph-clock-counter-clockwise text-lg leading-none"></i>
            </button>
            
            <!-- Center: Title -->
            <div class="flex flex-col items-center">
                <!-- 修复：不再使用书法字体，改用宋体 -->
                <h1 class="font-serif font-bold text-xl tracking-[0.15em] text-[#c02c38]">
                    {{ t('app_title') }}
                </h1>
            </div>
            
            <!-- Right: View Mode & Lang -->
            <div class="flex items-center gap-2">
                <button @click="toggleViewMode" class="w-9 h-9 flex items-center justify-center rounded-full bg-white border border-stone-200 shadow-sm active:scale-90 transition text-stone-600 hover:text-[#c02c38]" :title="viewMode==='mobile' ? 'Switch to Desktop' : 'Switch to Mobile'">
                    <i v-if="viewMode === 'mobile'" class="ph-bold ph-desktop text-lg leading-none"></i>
                    <i v-else class="ph-bold ph-device-mobile text-lg leading-none"></i>
                </button>

                <button @click="toggleLang" class="w-9 h-9 flex items-center justify-center rounded-full bg-white border border-stone-200 shadow-sm active:scale-90 transition text-stone-600 font-bold text-xs hover:text-[#c02c38] font-sans">
                    {{ currentLang === 'zh' ? 'EN' : '中' }}
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden p-5 pb-24 relative scroll-smooth no-scrollbar" ref="scrollContainer">
            
            <!-- Phase 1: 入口 -->
            <transition name="fade" mode="out-in">
                <div v-if="step === 1" key="step1" class="flex flex-col h-full w-full max-w-lg mx-auto">
                    
                    <div class="tab-switcher flex mb-8">
                        <button @click="switchMode('liuyao')" class="flex-1 py-2.5 text-sm tab-item font-serif" :class="mode === 'liuyao' ? 'tab-active' : ''">{{ t('tab_liuyao') }}</button>
                        <button @click="switchMode('bazi')" class="flex-1 py-2.5 text-sm tab-item font-serif" :class="mode === 'bazi' ? 'tab-active' : ''">{{ t('tab_bazi') }}</button>
                    </div>

                    <div class="text-center space-y-2 mb-8 mt-4">
                        <div class="relative inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-white border border-stone-100 shadow-sm mb-2">
                            <i v-if="mode==='liuyao'" class="ph-fill ph-hands-praying text-4xl text-[#c02c38] leading-none"></i>
                            <i v-else class="ph-fill ph-scroll text-4xl text-[#c02c38] leading-none"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-stone-800 tracking-wide font-serif">{{ t(mode + '_title') }}</h2>
                        <p class="text-stone-400 text-[10px] tracking-[0.2em] uppercase font-sans">{{ t(mode + '_subtitle') }}</p>
                    </div>

                    <div class="w-full space-y-6 flex-1">
                        <div v-if="mode === 'liuyao'" class="space-y-5">
                            <div class="relative group">
                                <textarea v-model="question" rows="4" :placeholder="t('step1_placeholder')" 
                                    class="w-full p-5 bg-white border border-stone-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#c02c38]/20 transition shadow-sm text-stone-700 text-lg leading-relaxed placeholder:text-stone-300 resize-none font-serif"></textarea>
                                <div class="absolute bottom-3 right-3 text-stone-300">
                                    <i class="ph-bold ph-pencil-simple-line text-lg leading-none"></i>
                                </div>
                            </div>
                        </div>

                        <div v-else class="space-y-5">
                            <div class="flex gap-4">
                                <label class="flex-1 flex items-center justify-center gap-2 p-4 bg-white border border-stone-100 rounded-2xl cursor-pointer hover:shadow-md transition-all" :class="baziInput.gender==='1'?'ring-2 ring-blue-100 bg-blue-50/30':''">
                                    <input type="radio" v-model="baziInput.gender" value="1" class="hidden">
                                    <i class="ph-bold ph-gender-male text-lg text-blue-600 leading-none"></i>
                                    <span class="text-sm font-bold text-stone-700 font-sans">{{ t('gender_male') }}</span>
                                </label>
                                <label class="flex-1 flex items-center justify-center gap-2 p-4 bg-white border border-stone-100 rounded-2xl cursor-pointer hover:shadow-md transition-all" :class="baziInput.gender==='0'?'ring-2 ring-pink-100 bg-pink-50/30':''">
                                    <input type="radio" v-model="baziInput.gender" value="0" class="hidden">
                                    <i class="ph-bold ph-gender-female text-lg text-pink-600 leading-none"></i>
                                    <span class="text-sm font-bold text-stone-700 font-sans">{{ t('gender_female') }}</span>
                                </label>
                            </div>
                            <div class="bg-white border border-stone-100 rounded-2xl p-5 space-y-4 shadow-sm">
                                <div class="flex items-center justify-between border-b border-stone-100 pb-2">
                                    <label class="text-xs text-stone-400 font-bold tracking-wide uppercase font-sans">{{ t('label_birth_date') }}</label>
                                    <input type="date" v-model="baziInput.date" class="bg-transparent text-right font-mono font-bold text-stone-800 focus:outline-none text-base">
                                </div>
                                <div class="flex items-center justify-between pt-1">
                                    <label class="text-xs text-stone-400 font-bold tracking-wide uppercase font-sans">{{ t('label_birth_time') }}</label>
                                    <input type="time" v-model="baziInput.time" class="bg-transparent text-right font-mono font-bold text-stone-800 focus:outline-none text-base">
                                </div>
                            </div>
                            <input v-model="question" type="text" :placeholder="t('bazi_question_ph')" class="w-full p-4 bg-white border border-stone-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#c02c38]/20 transition shadow-sm text-stone-700 placeholder:text-stone-300 font-serif">
                        </div>
                        
                        <button @click="nextStep" :disabled="!canProceed" class="w-full py-4 btn-primary text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4 font-sans">
                            <span>{{ t('btn_start') }}</span>
                            <i class="ph-bold ph-arrow-right text-lg leading-none"></i>
                        </button>
                        
                        <div class="text-center mt-6">
                             <p class="text-[10px] text-stone-400 font-serif italic">{{ t('step1_footer') }}</p>
                        </div>
                    </div>
                </div>

                <!-- Phase 2: 摇卦 -->
                <div v-else-if="step === 2 && mode === 'liuyao'" key="step2" class="flex flex-col h-full justify-center w-full max-w-lg mx-auto">
                    <div class="text-center mb-10 animate-fade-in">
                        <div class="text-[10px] text-stone-400 uppercase tracking-widest mb-2 font-bold font-sans">{{ t('label_question') }}</div>
                        <div class="font-serif font-bold text-xl text-stone-800 px-4 leading-relaxed line-clamp-2">{{ question }}</div>
                        <div class="w-8 h-1 bg-[#c02c38] mx-auto mt-4 rounded-full opacity-80"></div>
                    </div>

                    <div class="flex flex-col items-center justify-center space-y-12">
                        <!-- Coins -->
                        <div class="h-28 flex items-center justify-center gap-6 perspective-1000 w-full">
                            <div v-for="c in 3" :key="c" class="coin-wrapper">
                                <div class="coin-3d" :class="{'is-spinning': isShaking}" :style="getCoinRotation(lastCoins[c-1])">
                                    <div class="coin-face">
                                        <div class="coin-hole"></div>
                                        <div class="qian-long">
                                            <span class="char-top">乾</span> <span class="char-bottom">隆</span> <span class="char-right">通</span> <span class="char-left">宝</span>
                                        </div>
                                    </div>
                                    <div class="coin-back">
                                        <div class="coin-hole"></div>
                                        <div class="manchu-squiggle" style="top:10px; left:30px;"></div> <div class="manchu-squiggle" style="bottom:10px; right:30px; transform:rotate(180deg)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center space-y-8 w-full">
                            <div class="relative inline-block">
                                 <button @click="shake" :disabled="isShaking" class="w-28 h-28 rounded-full bg-[#c02c38] text-white font-bold text-xl shadow-[0_10px_30px_rgba(192,44,56,0.4)] active:scale-90 transition-all flex flex-col items-center justify-center gap-1 z-10 relative overflow-hidden group border-4 border-[#e8e6e1]" :class="{'btn-shake': !isShaking && inputLines.length < 6}">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <i class="ph-fill ph-hand-waving text-3xl mb-1 group-hover:rotate-12 transition-transform leading-none"></i>
                                    <span class="text-sm font-medium tracking-widest font-sans">{{ inputLines.length < 6 ? t('btn_shake') : t('btn_finish') }}</span>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div class="font-mono text-[#c02c38] font-bold h-6 text-sm tracking-wider">{{ statusText }}</div>
                                <div class="flex justify-center gap-2">
                                    <div v-for="i in 6" :key="i" class="w-2 h-2 rounded-full transition-all duration-500" :class="inputLines.length >= i ? 'bg-[#c02c38] scale-125' : 'bg-stone-300 scale-100'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 3: 结果展示 -->
                <div v-else-if="step === 3" key="step3" class="space-y-6 pb-10 w-full max-w-3xl mx-auto">
                    
                    <!-- Hexagram Result -->
                    <template v-if="mode === 'liuyao'">
                        <div class="text-center pt-2">
                            <div class="text-sm text-stone-600 font-bold font-mono tracking-wide bg-white px-3 py-1 rounded-full shadow-sm inline-block border border-stone-100">{{ lunarInfo.dateStr }}</div>
                            <div class="text-[10px] text-stone-400 font-mono mt-2 font-serif">{{ t('label_void') }}: {{ lunarInfo.kongWang }}</div>
                        </div>

                        <transition appear name="slide-up">
                            <div class="card-neo p-5 relative overflow-hidden">
                                <div class="absolute left-0 top-4 bottom-4 w-1 bg-[#c02c38] rounded-r-full"></div>
                                <div class="flex justify-between items-end mb-6 px-2">
                                    <div>
                                        <span class="text-[10px] text-stone-400 font-bold tracking-widest uppercase mb-1 block font-sans">Present Energy</span>
                                        <h3 class="text-3xl font-bold text-[#c02c38] font-serif">{{ currentChart.main.name }}</h3>
                                        <span class="text-[10px] text-stone-500 bg-stone-100 px-2 py-0.5 rounded-md mt-2 inline-block font-medium font-serif">
                                            {{ currentChart.main.palace }}{{ t('label_palace') }} · {{ translateTerm(currentChart.main.element) }}
                                        </span>
                                    </div>
                                    <div class="text-5xl text-stone-100 font-serif absolute right-2 top-0 select-none -z-10" style="font-family: 'Ma Shan Zheng'">{{ t('label_main_bg') }}</div>
                                </div>

                                <div class="space-y-3 relative z-10 px-1">
                                    <div v-for="line in currentChart.main.lines" :key="'main-'+line.index" 
                                         class="grid-hex-row" :class="currentLang === 'en' ? 'is-en' : ''">
                                        
                                        <div class="text-stone-400 text-[10px] text-center font-medium font-serif leading-none">{{ translateTerm(line.beast) }}</div>
                                        <div class="font-bold text-xs text-center font-serif leading-none" :class="getRelationClass(line.relation)">{{ translateTerm(line.relation) }}</div>
                                        <div class="font-mono text-[10px] text-stone-500 text-center leading-none">{{ line.stem }}{{ line.branch }}{{ translateTerm(line.wuxing) }}</div>
                                        
                                        <div class="flex items-center px-2">
                                            <div v-if="line.isYang" class="yang-stroke relative w-full"><div v-if="line.isMoving" class="absolute -right-1 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-[#c02c38] animate-pulse shadow-[0_0_5px_#c02c38]"></div></div>
                                            <div v-else class="yin-stroke-wrapper relative w-full"><div class="yin-stroke"></div> <div class="yin-stroke"></div><div v-if="line.isMoving" class="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-[#c02c38] animate-pulse shadow-[0_0_5px_#c02c38]"></div></div>
                                        </div>
                                        
                                        <div class="flex justify-center">
                                            <span v-if="line.shi" class="text-white bg-[#c02c38] flex items-center justify-center shadow-sm shadow-red-200 text-[10px] font-bold" :class="currentLang === 'en' ? 'px-2 py-0.5 rounded-md whitespace-nowrap' : 'w-5 h-5 rounded-md'">{{ t('label_shi') }}</span>
                                            <span v-if="line.ying" class="text-[#c02c38] border border-[#c02c38] flex items-center justify-center opacity-60 text-[10px] font-bold" :class="currentLang === 'en' ? 'px-2 py-0.5 rounded-md whitespace-nowrap' : 'w-5 h-5 rounded-md'">{{ t('label_ying') }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 数据库补充内容 - 本卦 -->
                                <div v-if="currentChart.main.extra" class="db-meaning-box">
                                    <div class="flex items-center justify-between mb-2 border-b border-stone-200 pb-2">
                                        <span class="db-label text-[#c02c38] font-bold">卦辞解读</span>
                                        <span class="text-xl leading-none text-stone-800">{{ currentChart.main.extra.image }}</span>
                                    </div>
                                    <p class="db-text font-bold mb-1">{{ currentChart.main.extra.meaning }}</p>
                                    <p class="db-desc">{{ currentChart.main.extra.description }}</p>
                                    <div v-if="currentChart.main.extra.elements" class="mt-2 flex gap-1">
                                        <span v-for="el in currentChart.main.extra.elements" :key="el" class="text-[10px] px-1.5 py-0.5 bg-stone-100 rounded text-stone-500 border border-stone-200">{{ el }}</span>
                                    </div>
                                </div>
                            </div>
                        </transition>

                        <div v-if="currentChart.hasChange" class="flex justify-center -my-3 relative z-10 opacity-50"><div class="bg-stone-200 rounded-full p-1 border-4 border-[#f0f2f5]"><i class="ph-bold ph-arrow-down text-xl text-stone-500 leading-none"></i></div></div>

                        <transition appear name="slide-up" v-if="currentChart.hasChange">
                            <div class="card-neo p-5 relative overflow-hidden bg-[#ffffff]/60">
                                 <div class="absolute left-0 top-4 bottom-4 w-1 bg-stone-300 rounded-r-full"></div>
                                <div class="flex justify-between items-end mb-6 px-2">
                                    <div>
                                        <span class="text-[10px] text-stone-400 font-bold tracking-widest uppercase mb-1 block font-sans">Future Trend</span>
                                        <h3 class="text-2xl font-bold text-stone-600 font-serif">{{ currentChart.changed.name }}</h3>
                                    </div>
                                    <div class="text-5xl text-stone-100 font-serif absolute right-2 top-0 select-none -z-10" style="font-family: 'Ma Shan Zheng'">{{ t('label_change_bg') }}</div>
                                </div>
                                <div class="space-y-3 relative z-10 px-1 opacity-80">
                                    <div v-for="line in currentChart.changed.lines" :key="'changed-'+line.index" 
                                         class="grid-hex-row" :class="currentLang === 'en' ? 'is-en' : ''">
                                        <div class="text-stone-400 text-[10px] text-center font-serif leading-none">{{ translateTerm(line.beast) }}</div>
                                        <div class="font-bold text-xs text-center font-serif leading-none" :class="getRelationClass(line.relation)">{{ translateTerm(line.relation) }}</div>
                                        <div class="font-mono text-[10px] text-stone-500 text-center leading-none">{{ line.stem }}{{ line.branch }}{{ translateTerm(line.wuxing) }}</div>
                                        <div class="flex items-center px-2">
                                            <div v-if="line.isYang" class="yang-stroke !bg-none bg-stone-400 !box-shadow-none"></div>
                                            <div v-else class="yin-stroke-wrapper"><div class="yin-stroke !bg-none bg-stone-400 !box-shadow-none"></div> <div class="yin-stroke !bg-none bg-stone-400 !box-shadow-none"></div></div>
                                        </div>
                                        <div></div>
                                    </div>
                                </div>

                                <!-- 数据库补充内容 - 变卦 -->
                                <div v-if="currentChart.changed.extra" class="db-meaning-box opacity-90">
                                    <div class="flex items-center justify-between mb-2 border-b border-stone-200 pb-2">
                                        <span class="db-label text-stone-500 font-bold">变卦启示</span>
                                        <span class="text-xl leading-none text-stone-600">{{ currentChart.changed.extra.image }}</span>
                                    </div>
                                    <p class="db-text font-bold mb-1">{{ currentChart.changed.extra.meaning }}</p>
                                    <p class="db-desc">{{ currentChart.changed.extra.description }}</p>
                                </div>
                            </div>
                        </transition>
                    </template>

                    <!-- BaZi Result -->
                    <template v-else>
                        <transition appear name="slide-up">
                            <div class="card-neo p-5 relative overflow-hidden">
                                <div class="flex justify-between items-center mb-6 pb-3 border-b border-stone-100">
                                    <div class="flex items-center gap-2">
                                        <span class="w-1 h-4 bg-[#c02c38] rounded-full"></span>
                                        <div class="text-xs font-bold text-stone-700 font-serif">{{ baziChart.gender === '1' ? t('bazi_male') : t('bazi_female') }}</div>
                                    </div>
                                    <div class="text-[10px] text-stone-400 font-mono bg-stone-50 px-2 py-1 rounded">{{ baziChart.solarDate }}</div>
                                </div>
                                <div class="grid grid-cols-4 gap-2 mb-8">
                                    <div v-for="(col, idx) in ['year', 'month', 'day', 'hour']" :key="idx" class="text-center">
                                         <div class="text-[9px] text-stone-400 uppercase tracking-widest mb-1 font-sans">{{ t('col_'+col) }}</div>
                                         <div class="bazi-pillar-card">
                                             <div class="text-xl font-bold mb-1 font-serif" :class="getWuXingColor(baziChart.pillars[idx].stemWx)">{{ baziChart.pillars[idx].stem }}</div>
                                             <div class="text-xl font-bold mb-2 font-serif" :class="getWuXingColor(baziChart.pillars[idx].branchWx)">{{ baziChart.pillars[idx].branch }}</div>
                                             <div class="text-[9px] text-stone-400 font-mono">{{ t('wx_'+baziChart.pillars[idx].stemWx) }}</div>
                                         </div>
                                    </div>
                                </div>
                                <div class="bg-stone-50/80 rounded-xl p-4 border border-stone-100 mb-6">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="text-[10px] font-bold text-stone-500 uppercase tracking-wide flex items-center gap-1 font-sans"><i class="ph-fill ph-chart-line-up leading-none"></i> {{ t('label_luck_cycle') }}</div>
                                        <div class="text-[10px] text-[#c02c38] font-bold bg-red-50 px-2 py-0.5 rounded-md border border-red-100 font-serif">{{ t('label_start_luck') }}: {{ baziChart.startAge }} {{ t('label_age') }}</div>
                                    </div>
                                    <div class="flex overflow-x-auto gap-2 pb-2 mb-4 no-scrollbar">
                                        <div v-for="(dy, idx) in baziChart.dayun" :key="idx" @click="selectDaYun(idx)" class="dayun-capsule cursor-pointer shrink-0 relative" :class="[selectedDaYunIndex === idx ? 'dayun-selected' : '', (dy.isCurrent && selectedDaYunIndex !== idx) ? 'dayun-current-border' : '']">
                                            <div class="font-bold text-sm font-serif">{{ dy.ganZhi }}</div>
                                            <div class="text-[9px] opacity-70 mt-0.5 font-sans">{{ dy.startAge }}{{ t('label_age_short') }}</div>
                                            <div v-if="dy.isCurrent && selectedDaYunIndex !== idx" class="absolute -top-1 -right-1 w-2 h-2 bg-[#c02c38] rounded-full"></div>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-100 flex items-center justify-between relative overflow-hidden">
                                        <div class="flex flex-col relative z-10">
                                            <span class="text-[9px] text-stone-400 mb-1 flex items-center gap-1 font-sans"><i class="ph-bold ph-calendar-blank leading-none"></i> {{ t('label_analysis_date') }}</span>
                                            <input type="date" v-model="analysisDate" @change="updateAnalysis" class="bg-transparent font-mono text-xs font-bold text-stone-700 focus:outline-none p-0 m-0 border-b border-dashed border-stone-300 cursor-pointer">
                                        </div>
                                        <div class="text-right z-10">
                                            <div class="font-bold text-stone-800 text-sm font-serif">{{ baziChart.currentLiuNian }}</div>
                                            <div class="font-bold text-stone-400 text-xs font-serif">{{ baziChart.currentLiuRi }}</div>
                                        </div>
                                        <div class="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-stone-50 to-transparent pointer-events-none"></div>
                                    </div>
                                </div>
                                <div class="bg-stone-50/50 rounded-xl p-3 border border-stone-100">
                                    <div class="text-[10px] text-stone-400 mb-2 uppercase tracking-wider font-bold font-sans">{{ t('label_5_elements') }}</div>
                                    <div class="flex h-2.5 rounded-full overflow-hidden w-full mb-2">
                                        <div v-for="(count, wx) in baziChart.wuxingCount" :key="wx" :style="{width: (count/8*100) + '%', backgroundColor: getWuXingHex(wx)}" class="h-full transition-all duration-500"></div>
                                    </div>
                                    <div class="flex justify-between px-1">
                                        <div v-for="(count, wx) in baziChart.wuxingCount" :key="'txt'+wx" class="flex flex-col items-center">
                                            <span class="text-[10px] font-bold text-stone-600 font-sans">{{count}}</span>
                                            <span class="w-1.5 h-1.5 rounded-full mt-0.5" :style="{backgroundColor: getWuXingHex(wx)}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                        
                        <!-- 修复：八字核心解读卡片 -->
                        <transition appear name="slide-up">
                            <div v-if="baziChart && baziChart.interpretation" class="card-neo p-5 mt-4 relative overflow-hidden bg-white/80 border border-stone-100">
                                <div class="flex items-center gap-2 mb-3 border-b border-stone-100 pb-2">
                                    <i class="ph-fill ph-user-focus text-[#c02c38]"></i>
                                    <span class="text-xs font-bold text-[#c02c38] tracking-widest uppercase font-sans">本命特质 · Day Master</span>
                                </div>
                                
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-full bg-[#c02c38] text-white flex items-center justify-center font-serif text-2xl shadow-md shrink-0 border-2 border-red-100">
                                        {{ baziChart.interpretation.dm.name.substring(0,1) }}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-stone-800 font-serif text-lg">{{ baziChart.interpretation.dm.title }}</h4>
                                        <p class="text-xs text-stone-500 mt-1 leading-relaxed font-serif text-justify">
                                            {{ baziChart.interpretation.dm.desc }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </transition>

                        <!-- [新增] 每日运势卡片 (扩充功能) -->
                        <transition appear name="slide-up">
                            <div class="card-neo p-5 mt-4 mb-2 border-stone-100 relative overflow-hidden">
                                <div class="flex items-center justify-between mb-3 border-b border-stone-100 pb-2 relative z-10">
                                    <div class="flex items-center gap-2">
                                        <i class="ph-fill ph-sparkle text-[#c02c38]"></i>
                                        <span class="text-xs font-bold text-[#c02c38] tracking-widest uppercase font-sans">天机锦囊 · Daily Fortune</span>
                                    </div>
                                </div>
                                
                                <div v-if="dailyFortune" class="relative z-10">
                                    <div class="text-lg font-bold text-stone-700 font-serif mb-3 leading-relaxed">{{ dailyFortune.text }}</div>
                                    <div class="flex flex-wrap gap-2">
                                        <span v-if="dailyFortune.category" class="text-[10px] px-2 py-1 bg-[#c02c38]/10 text-[#c02c38] rounded font-bold">{{ dailyFortune.category }}</span>
                                        <span v-if="dailyFortune.lucky_number" class="text-[10px] px-2 py-1 bg-stone-100 text-stone-500 rounded font-mono">幸运数: {{ dailyFortune.lucky_number }}</span>
                                        <span v-if="dailyFortune.lucky_color" class="text-[10px] px-2 py-1 bg-stone-100 text-stone-500 rounded font-mono">幸运色: {{ dailyFortune.lucky_color }}</span>
                                        <span v-if="dailyFortune.five_element" class="text-[10px] px-2 py-1 bg-stone-100 text-stone-500 rounded font-mono">五行: {{ dailyFortune.five_element }}</span>
                                    </div>
                                </div>
                                
                                <div v-else class="text-center py-2 relative z-10">
                                    <p class="text-xs text-stone-400 mb-3 font-serif">心诚则灵，抽取今日专属运势指引</p>
                                    <button @click="drawFortune" class="btn-primary px-6 py-2 text-sm font-bold rounded-full shadow-lg hover:scale-105 transition-transform flex items-center justify-center gap-2 mx-auto">
                                        <i class="ph-bold ph-hand-pointing"></i> 抽取运势
                                    </button>
                                </div>
                                
                                <!-- 装饰背景 -->
                                <div class="absolute right-[-10px] bottom-[-10px] text-stone-100 text-8xl opacity-20 rotate-12 pointer-events-none">
                                    <i class="ph-fill ph-scroll"></i>
                                </div>
                            </div>
                        </transition>
                    </template>

                    <!-- CTA Section -->
                    <transition appear name="slide-up">
                        <div class="card-neo p-6 text-center space-y-5 mt-6 bg-gradient-to-b from-white to-[#f7f9f8] border-stone-100">
                            <div class="relative z-10">
                                <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600 shadow-sm">
                                    <i class="ph-fill ph-chats-circle text-2xl leading-none"></i>
                                </div>
                                <h3 class="text-lg font-bold text-stone-800 mb-2 font-serif tracking-wide">{{ t('cta_title') }}</h3>
                                <p class="text-xs text-stone-500 leading-relaxed px-2 font-serif">{{ t('cta_desc_1') }}<br>{{ t('cta_desc_2') }}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="contactWhatsApp" class="btn-action-whatsapp w-full py-3 rounded-xl font-bold text-sm active:scale-95 transition-all flex flex-col items-center justify-center gap-1 font-sans">
                                    <i class="ph-bold ph-whatsapp-logo text-xl leading-none"></i>
                                    <span>WhatsApp</span>
                                </button>
                                <button @click="contactWeChat" class="btn-action-wechat w-full py-3 rounded-xl font-bold text-sm active:scale-95 transition-all flex flex-col items-center justify-center gap-1 font-sans">
                                    <i class="ph-bold ph-wechat-logo text-xl leading-none"></i>
                                    <span>{{ t('btn_wechat') }}</span>
                                </button>
                            </div>
                            <div class="text-[10px] text-stone-400 bg-stone-50 py-2 px-4 rounded-full inline-flex items-center gap-2 border border-stone-100">
                                <span class="font-sans">{{ t('label_wechat_id') }}: <span class="font-mono font-bold select-all text-stone-600">{{ MY_WECHAT_ID }}</span></span>
                                <button @click="copyWeChatIDOnly" class="text-[#07C160] font-bold hover:underline font-sans">{{ t('btn_copy') }}</button>
                            </div>
                        </div>
                    </transition>

                    <div class="text-center pt-4 pb-6">
                        <button @click="resetAll" class="text-xs text-stone-400 hover:text-stone-600 flex items-center justify-center gap-1.5 mx-auto px-4 py-2 hover:bg-white hover:shadow-sm rounded-full transition-all">
                            <i class="ph-bold ph-arrow-counter-clockwise leading-none"></i>
                            <span class="font-serif">{{ t('btn_restart') }}</span>
                        </button>
                    </div>

                </div>
            </transition>

        </main>
    </div>
</div>

<script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    // --- 数据库 (Embeded data.json) ---
    const DB_DATA = {
        "hexagrams": {
            "1": { "name": "乾卦", "meaning": "大吉大利，事业发展顺利，充满创造力和领导力。", "description": "天行健，君子以自强不息。", "image": "☰", "elements": ["天", "天"] },
            "2": { "name": "坤卦", "meaning": "包容和顺，静待时机，适合稳扎稳打。", "description": "地势坤，君子以厚德载物。", "image": "☷", "elements": ["地", "地"] },
            "3": { "name": "屯卦", "meaning": "开始困难，但充满希望，需要耐心。", "description": "云雷屯，君子以经纶。", "image": "☳☵", "elements": ["水", "雷"] },
            "4": { "name": "蒙卦", "meaning": "启蒙教育，学习成长，寻求指导。", "description": "山下出泉，蒙。君子以果行育德。", "image": "☵☶", "elements": ["山", "水"] },
            "5": { "name": "需卦", "meaning": "等待时机，切勿急躁，静候佳音。", "description": "云上于天，需。君子以饮食宴乐。", "image": "☰☵", "elements": ["水", "天"] },
            "6": { "name": "讼卦", "meaning": "争讼不利，宜和为贵，化解矛盾。", "description": "天与水违行，讼。君子以作事谋始。", "image": "☵☰", "elements": ["天", "水"] },
            "7": { "name": "师卦", "meaning": "整顿内部，团结一致，共同进退。", "description": "地中有水，师。君子以容民畜众。", "image": "☷☵", "elements": ["地", "水"] },
            "8": { "name": "比卦", "meaning": "亲近互助，团结一致，和睦共处。", "description": "地上有水，比。先王以建万国，亲诸侯。", "image": "☵☷", "elements": ["水", "地"] },
            "9": { "name": "小畜卦", "meaning": "蓄势待发，循序渐进，稳中求进。", "description": "风行天上，小畜。君子以懿文德。", "image": "☰☴", "elements": ["风", "天"] },
            "10": { "name": "履卦", "meaning": "谨慎前行，循规蹈矩，稳健发展。", "description": "上天下泽，履。君子以辨上下，定民志。", "image": "☱☰", "elements": ["天", "泽"] },
            "11": { "name": "泰卦", "meaning": "通达顺遂，万事亨通，吉祥如意。", "description": "天地交泰，后以财成天地之道，辅相天地之宜。", "image": "☷☰", "elements": ["地", "天"] },
            "12": { "name": "否卦", "meaning": "闭塞不通，诸事不顺，需要忍耐。", "description": "天地不交，否。君子以俭德辟难，不可荣以禄。", "image": "☰☷", "elements": ["天", "地"] },
            "13": { "name": "同人卦", "meaning": "志同道合，团结协作，共同发展。", "description": "天与火同人。君子以类族辨物。", "image": "☰☲", "elements": ["天", "火"] },
            "14": { "name": "大有卦", "meaning": "丰收在望，大有收获，前途光明。", "description": "火在天上，大有。君子以遏恶扬善，顺天休命。", "image": "☲☰", "elements": ["火", "天"] },
            "15": { "name": "谦卦", "meaning": "谦虚谨慎，稳重自持，德行高尚。", "description": "地中有山，谦。君子以裒多益寡，称物平施。", "image": "☷☶", "elements": ["地", "山"] },
            "16": { "name": "豫卦", "meaning": "愉悦喜庆，心情舒畅，万事如意。", "description": "雷出地奋，豫。先王以作乐崇德，殷荐之上帝。", "image": "☳☷", "elements": ["雷", "地"] },
            "17": { "name": "随卦", "meaning": "随遇而安，顺势而为，适应变化。", "description": "泽中有雷，随。君子以向晦入宴息。", "image": "☱☳", "elements": ["泽", "雷"] },
            "18": { "name": "蛊卦", "meaning": "整顿革新，改革创新，克服困难。", "description": "山下有风，蛊。君子以振民育德。", "image": "☶☴", "elements": ["山", "风"] },
            "19": { "name": "临卦", "meaning": "监察督导，关注发展，稳步前进。", "description": "泽上有地，临。君子以教思无穷，容保民无疆。", "image": "☷☱", "elements": ["地", "泽"] },
            "20": { "name": "观卦", "meaning": "观察形势，明察秋毫，谨慎行事。", "description": "风行地上，观。先王以省方观民设教。", "image": "☴☷", "elements": ["风", "地"] },
            "21": { "name": "噬嗑卦", "meaning": "决断明确，雷厉风行，克服阻碍。", "description": "雷电噬嗑。君子以明罚敕法。", "image": "☳☲", "elements": ["火", "雷"] },
            "22": { "name": "贲卦", "meaning": "文质彬彬，优雅得体，修饰美化。", "description": "山下有火，贲。君子以明庶政，无敢折狱。", "image": "☶☲", "elements": ["山", "火"] },
            "23": { "name": "剥卦", "meaning": "衰落剥落，需要重新开始，谨慎行事。", "description": "山附于地，剥。上以厚下，安宅。", "image": "☶☷", "elements": ["山", "地"] },
            "24": { "name": "复卦", "meaning": "否极泰来，重新开始，充满希望。", "description": "雷在地中，复。先王以至日闭关。", "image": "☷☳", "elements": ["地", "雷"] },
            "25": { "name": "无妄卦", "meaning": "自然无妄，真诚本分，守正待时。", "description": "天下雷行，物与无妄。先王以茂对时，育万物。", "image": "☰☳", "elements": ["天", "雷"] },
            "26": { "name": "大畜卦", "meaning": "蓄养人才，厚积薄发，储备能量。", "description": "天在山中，大畜。君子以多识前言往行，以畜其德。", "image": "☰☶", "elements": ["天", "山"] },
            "27": { "name": "颐卦", "meaning": "修养身心，滋养生息，培养德行。", "description": "山下有雷，颐。君子以慎言语，节饮食。", "image": "☶☳", "elements": ["山", "雷"] },
            "28": { "name": "大过卦", "meaning": "勇于改革，大胆创新，突破常规。", "description": "泽灭木，大过。君子以独立不惧，遁世无闷。", "image": "☱☴", "elements": ["泽", "风"] },
            "29": { "name": "坎卦", "meaning": "险中求进，谨慎行事，克服困难。", "description": "水洊至，习坎。君子以常德行，习教事。", "image": "☵☵", "elements": ["水", "水"] },
            "30": { "name": "离卦", "meaning": "光明显达，文明礼仪，光辉灿烂。", "description": "明两作，离。大人以继明照于四方。", "image": "☲☲", "elements": ["火", "火"] },
            "31": { "name": "咸卦", "meaning": "感应交流，心心相印，互相影响。", "description": "山上有泽，咸。君子以虚受人。", "image": "☶☱", "elements": ["山", "泽"] },
            "32": { "name": "恒卦", "meaning": "持之以恒，永续发展，保持恒心。", "description": "雷风，恒。君子以立不易方。", "image": "☳☴", "elements": ["雷", "风"] },
            "33": { "name": "遁卦", "meaning": "暂时退避，韬光养晦，等待时机。", "description": "天下有山，遁。君子以远小人，不恶而严。", "image": "☰☶", "elements": ["天", "山"] },
            "34": { "name": "大壮卦", "meaning": "刚强壮大，积极进取，充满力量。", "description": "雷在天上，大壮。君子以非礼弗履。", "image": "☳☰", "elements": ["雷", "天"] },
            "35": { "name": "晋卦", "meaning": "步步高升，稳步前进，不断进步。", "description": "明出地上，晋。君子以自昭明德。", "image": "☷☲", "elements": ["地", "火"] },
            "36": { "name": "明夷卦", "meaning": "晦暗不明，内藏光明，韬光养晦。", "description": "明入地中，明夷。君子以莅众，用晦而明。", "image": "☲☷", "elements": ["火", "地"] },
            "37": { "name": "家人卦", "meaning": "家庭和睦，内外和谐，相亲相爱。", "description": "风自火出，家人。君子以言有物，而行有恒。", "image": "☴☲", "elements": ["风", "火"] },
            "38": { "name": "睽卦", "meaning": "背道而驰，异中求同，和而不同。", "description": "上火下泽，睽。君子以同而异。", "image": "☲☱", "elements": ["火", "泽"] },
            "39": { "name": "蹇卦", "meaning": "行动受阻，步履维艰，需要耐心。", "description": "山上有水，蹇。君子以反身修德。", "image": "☶☵", "elements": ["山", "水"] },
            "40": { "name": "解卦", "meaning": "解除困难，柳暗花明，渐入佳境。", "description": "雷雨作，解。君子以赦过宥罪。", "image": "☳☵", "elements": ["雷", "水"] },
            "41": { "name": "损卦", "meaning": "损益得当，取舍有度，适可而止。", "description": "山下有泽，损。君子以征忿窒欲。", "image": "☶☱", "elements": ["山", "泽"] },
            "42": { "name": "益卦", "meaning": "利益增长，日益月盛，蒸蒸日上。", "description": "风雷，益。君子以见善则迁，有过则改。", "image": "☴☳", "elements": ["风", "雷"] },
            "43": { "name": "夬卦", "meaning": "决断果断，坚定不移，破除障碍。", "description": "泽上于天，夬。君子以施禄及下，居德则忌。", "image": "☰☱", "elements": ["天", "泽"] },
            "44": { "name": "姤卦", "meaning": "邂逅相遇，意外之喜，机遇来临。", "description": "天下有风，姤。后以施命诰四方。", "image": "☰☴", "elements": ["天", "风"] },
            "45": { "name": "萃卦", "meaning": "聚集汇合，群策群力，共同进步。", "description": "泽上于地，萃。君子以除戎器，戒不虞。", "image": "☷☱", "elements": ["地", "泽"] },
            "46": { "name": "升卦", "meaning": "上升进步，节节高升，蒸蒸日上。", "description": "地中生木，升。君子以顺德，积小以高大。", "image": "☷☴", "elements": ["地", "风"] },
            "47": { "name": "困卦", "meaning": "困境逆境，坚持不懈，守待时机。", "description": "泽无水，困。君子以致命遂志。", "image": "☱☵", "elements": ["泽", "水"] },
            "48": { "name": "井卦", "meaning": "循序渐进，稳扎稳打，滋养生息。", "description": "木上有水，井。君子以劳民劝相。", "image": "☵☴", "elements": ["水", "风"] },
            "49": { "name": "革卦", "meaning": "改革创新，脱胎换骨，焕然一新。", "description": "泽中有火，革。君子以治历明时。", "image": "☱☲", "elements": ["泽", "火"] },
            "50": { "name": "鼎卦", "meaning": "鼎新革故，气象更新，转危为安。", "description": "火在木上，鼎。君子以正位凝命。", "image": "☲☴", "elements": ["火", "风"] },
            "51": { "name": "震卦", "meaning": "雷厉风行，震撼人心，奋发图强。", "description": "洊雷，震。君子以恐惧修省。", "image": "☳☳", "elements": ["雷", "雷"] },
            "52": { "name": "艮卦", "meaning": "稳重踏实，止于至善，不走极端。", "description": "兼山，艮。君子以思不出其位。", "image": "☶☶", "elements": ["山", "山"] },
            "53": { "name": "渐卦", "meaning": "循序渐进，稳步发展，水到渠成。", "description": "山上有木，渐。君子以居贤德善俗。", "image": "☶☴", "elements": ["山", "风"] },
            "54": { "name": "归妹卦", "meaning": "婚姻之象，喜结良缘，和谐美满。", "description": "泽上有雷，归妹。君子以永终知敝。", "image": "☱☳", "elements": ["泽", "雷"] },
            "55": { "name": "丰卦", "meaning": "丰富盛大，光明盛大，繁荣昌盛。", "description": "雷电皆至，丰。君子以折狱致刑。", "image": "☳☲", "elements": ["雷", "火"] },
            "56": { "name": "旅卦", "meaning": "行旅在外，谨慎小心，步步为营。", "description": "山上有火，旅。君子以明慎用刑，而不留狱。", "image": "☶☲", "elements": ["山", "火"] },
            "57": { "name": "巽卦", "meaning": "谦逊温和，随遇而安，顺势而为。", "description": "随风，巽。君子以申命行事。", "image": "☴☴", "elements": ["风", "风"] },
            "58": { "name": "兑卦", "meaning": "喜悦愉快，和悦温馨，心情舒畅。", "description": "丽泽，兑。君子以朋友讲习。", "image": "☱☱", "elements": ["泽", "泽"] },
            "59": { "name": "涣卦", "meaning": "分散流失，化解困难，柳暗花明。", "description": "风行水上，涣。先王以享于帝立庙。", "image": "☴☵", "elements": ["风", "水"] },
            "60": { "name": "节卦", "meaning": "节制适度，有所节制，不走极端。", "description": "泽上有水，节。君子以制数度，议德行。", "image": "☱☵", "elements": ["泽", "水"] },
            "61": { "name": "中孚卦", "meaning": "诚信中正，守信践诺，真诚待人。", "description": "泽上有风，中孚。君子以议狱缓死。", "image": "☱☴", "elements": ["泽", "风"] },
            "62": { "name": "小过卦", "meaning": "小心谨慎，不可大意，循序渐进。", "description": "山上有雷，小过。君子以行过乎恭，丧过乎哀，用过乎俭。", "image": "☶☳", "elements": ["山", "雷"] },
            "63": { "name": "既济卦", "meaning": "功成名就，圆满成功，水到渠成。", "description": "水在火上，既济。君子以思患而预防之。", "image": "☵☲", "elements": ["水", "火"] },
            "64": { "name": "未济卦", "meaning": "尚未完成，继续努力，未竟之业。", "description": "火在水上，未济。君子以慎辨物居方。", "image": "☲☵", "elements": ["火", "水"] }
        },
        "five_elements": {
            "金": ["申", "酉", "白色", "秋季", "7", "8", "9"],
            "木": ["寅", "卯", "绿色", "春季", "3", "4"],
            "水": ["子", "亥", "黑色", "冬季", "1", "2"],
            "火": ["巳", "午", "红色", "夏季", "5", "6"],
            "土": ["丑", "辰", "未", "戌", "黄色", "四季", "0"]
        },
        "zodiac_signs": ["鼠", "牛", "虎", "兔", "龙", "蛇", "马", "羊", "猴", "鸡", "狗", "猪"],
        "bazi_data": {
            "day_masters": {
                "甲": {"name": "甲木", "title": "参天大树", "desc": "性质刚健，虽有仁心但也容易固执。像大树一样，正直、向上，有领导欲望，不甘屈于人下。"},
                "乙": {"name": "乙木", "title": "花草之木", "desc": "性格柔顺，适应力强，能屈能伸。像藤蔓一样，善于依附和合作，内心坚韧，反应灵敏。"},
                "丙": {"name": "丙火", "title": "太阳之火", "desc": "热情开朗，光明磊落，但容易急躁。像太阳一样普照大地，不拘小节，喜好面子，富有感染力。"},
                "丁": {"name": "丁火", "title": "灯烛之火", "desc": "温和细腻，心思缜密，具有牺牲精神。像烛光一样，外弱内强，洞察力强，有时多愁善感。"},
                "戊": {"name": "戊土", "title": "城墙之土", "desc": "诚实厚重，沉稳镇静，但也容易迟钝。像高山一样，守信重诺，包容力强，喜静不喜动。"},
                "己": {"name": "己土", "title": "田园之土", "desc": "内心细腻，多才多艺，做事有条理。像田园一样，孕育万物，包容性强，但有时会优柔寡断。"},
                "庚": {"name": "庚金", "title": "刀剑之金", "desc": "刚毅果断，讲义气，好胜心强。像兵器一样，锐利直爽，不畏强权，但有时由于太直而伤人。"},
                "辛": {"name": "辛金", "title": "珠宝之金", "desc": "温润秀气，重感情，虚荣心稍重。像首饰一样，外表光鲜，自尊心强，不仅有些挑剔，还很敏感。"},
                "壬": {"name": "壬水", "title": "江河之水", "desc": "聪明理性，奔放不羁，善于把握机会。像大江一样，滔滔不绝，适应力极强，但也容易任性。"},
                "癸": {"name": "癸水", "title": "雨露之水", "desc": "温柔内敛，心思细腻，想象力丰富。像雨露一样，滋润万物，性格平静，但内心深沉不易捉摸。"}
            }
        }
    };

    // --- 配置 ---
    const MY_WHATSAPP_NUMBER = "8615382537862"; 
    const MY_WECHAT_ID = "Nobebaelaguaporfavor"; 

    // --- I18n ---
    const messages = {
        zh: {
            app_title: "六爻天机",
            tab_liuyao: "六爻占卜",
            tab_bazi: "八字命理",
            liuyao_title: "诚心求占",
            liuyao_subtitle: "I CHING DIVINATION",
            bazi_title: "八字排盘",
            bazi_subtitle: "FOUR PILLARS DESTINY",
            step1_placeholder: "请默念您的问题...\n例如：近期事业发展有无阻碍？",
            btn_start: "开始排盘",
            step1_footer: "• 心诚则灵 • 无事不占 •",
            label_question: "所占之事",
            coin_yang: "字",
            btn_shake: "点击摇卦",
            btn_finish: "查看结果",
            label_void: "空亡",
            label_solar: "公历",
            label_palace: "宫",
            label_main_bg: "本",
            label_shi: "世",
            label_ying: "应",
            label_change_trend: "未来趋势",
            label_change_bg: "变",
            label_no_change: "六爻安静，以本卦断吉凶",
            cta_title: "大师一对一详批",
            cta_desc_1: "天机深奥，需结合流年神煞综合推断。",
            cta_desc_2: "请选择下方任一方式联系大师。",
            btn_wechat: "微信联系",
            label_wechat_id: "微信号",
            btn_copy: "复制",
            btn_restart: "重新起卦",
            toast_copy_success: "信息已复制！正在打开微信...",
            toast_wechat_copy: "微信号已复制！",
            toast_fail: "复制失败",
            msg_intro: "大师您好，我诚心求测。",
            msg_q: "【问题】",
            msg_t: "【时间】",
            msg_g: "【卦象】",
            msg_bazi: "【八字】",
            msg_yun: "【大运流年】",
            msg_end: "请大师详批。",
            label_birth_date: "出生日期 (公历)",
            label_birth_time: "出生时间",
            gender_male: "男",
            gender_female: "女",
            bazi_question_ph: "想问大师关于命运的什么问题？(选填)",
            bazi_male: "乾造",
            bazi_female: "坤造",
            col_year: "年柱", col_month: "月柱", col_day: "日柱", col_hour: "时柱",
            label_5_elements: "五行能量分布",
            wx_wood: "木", wx_fire: "火", wx_earth: "土", wx_metal: "金", wx_water: "水",
            label_luck_cycle: "大运推演",
            label_start_luck: "起运",
            label_age: "岁",
            label_age_short: "岁",
            label_curr_year: "流年",
            label_curr_day: "流日",
            label_analysis_date: "推演日期",
            history_title: "卜筮记录",
            history_empty: "暂无记录",
            history_bazi: "八字命盘",
            history_no_q: "无具体问题"
        },
        en: {
            app_title: "Destiny Decoder",
            tab_liuyao: "Divination",
            tab_bazi: "BaZi Destiny",
            liuyao_title: "Ask Oracle",
            liuyao_subtitle: "I CHING DIVINATION",
            bazi_title: "BaZi Chart",
            bazi_subtitle: "FOUR PILLARS DESTINY",
            step1_placeholder: "Meditate on your question...\nEx: Will my career improve soon?",
            btn_start: "Analyze",
            step1_footer: "• Sincerity brings accuracy •",
            label_question: "Question",
            coin_yang: "Head",
            btn_shake: "Shake",
            btn_finish: "Finish",
            label_void: "Void",
            label_solar: "Solar",
            label_palace: " Palace",
            label_main_bg: "Base",
            label_shi: "Self",
            label_ying: "Other",
            label_change_trend: "Future Trend",
            label_change_bg: "Chg",
            label_no_change: "No moving lines.",
            cta_title: "Expert Interpretation",
            cta_desc_1: "Deep insight requires expert analysis.",
            cta_desc_2: "Contact Master for a detailed reading.",
            btn_wechat: "WeChat",
            label_wechat_id: "WeChat ID",
            btn_copy: "Copy",
            btn_restart: "Restart",
            toast_copy_success: "Copied! Opening WeChat...",
            toast_wechat_copy: "ID Copied!",
            toast_fail: "Copy failed",
            msg_intro: "Hello Master, I seek a reading.",
            msg_q: "[Question]",
            msg_t: "[Time]",
            msg_g: "[Hexagram]",
            msg_bazi: "[BaZi Chart]",
            msg_yun: "[Luck Cycles]",
            msg_end: "Please analyze.",
            label_birth_date: "Birth Date (Solar)",
            label_birth_time: "Birth Time",
            gender_male: "Male",
            gender_female: "Female",
            bazi_question_ph: "Specific question? (Optional)",
            bazi_male: "Male",
            bazi_female: "Female",
            col_year: "YEAR", col_month: "MONTH", col_day: "DAY", col_hour: "HOUR",
            label_5_elements: "5 Elements",
            wx_wood: "Wood", wx_fire: "Fire", wx_earth: "Earth", wx_metal: "Metal", wx_water: "Water",
            label_luck_cycle: "Luck Cycles",
            label_start_luck: "Start",
            label_age: "",
            label_age_short: "y.o.",
            label_curr_year: "Year",
            label_curr_day: "Day",
            label_analysis_date: "Analysis Date",
            history_title: "History",
            history_empty: "No records yet",
            history_bazi: "BaZi Chart",
            history_no_q: "No specific question"
        }
    };

    const terms = {
        zh: {},
        en: {
            '金': 'Metal', '木': 'Wood', '水': 'Water', '火': 'Fire', '土': 'Earth',
            '父母': 'Parent', '兄弟': 'Sibling', '子孙': 'Offspring', '妻财': 'Wealth', '官鬼': 'Official',
            '青龙': 'Dragon', '朱雀': 'Bird', '勾陈': 'Hook', '腾蛇': 'Snake', '白虎': 'Tiger', '玄武': 'Tortoise'
        }
    };

    const TRIGRAMS = { '111': {name:'乾',element:'金'}, '011': {name:'兑',element:'金'}, '101': {name:'离',element:'火'}, '001': {name:'震',element:'木'}, '110': {name:'巽',element:'木'}, '010': {name:'坎',element:'水'}, '100': {name:'艮',element:'土'}, '000': {name:'坤',element:'土'} };
    const PALACES = [['乾为天','天风姤','天山遁','天地否','风地观','山地剥','火地晋','火天大有'],['坎为水','水泽节','水雷屯','水火既济','泽火革','雷火丰','地火明夷','地水师'],['艮为山','山火贲','山天大畜','山泽损','火泽睽','天泽履','风泽中孚','风山渐'],['震为雷','雷地豫','雷水解','雷风恒','地风升','水风井','泽风大过','泽雷随'],['巽为风','风天小畜','风火家人','风雷益','天雷无妄','火雷噬嗑','山雷颐','山风蛊'],['离为火','火山旅','火风鼎','火水未济','山水蒙','风水涣','天水讼','天火同人'],['坤为地','地雷复','地泽临','地天泰','雷天大壮','泽天夬','水天需','水地比'],['兑为泽','泽水困','泽地萃','泽山咸','水山蹇','地山谦','雷山小过','雷泽归妹']];
    const NA_JIA = {'乾':['甲',['子','寅','辰'],'壬',['午','申','戌']],'震':['庚',['子','寅','辰'],'庚',['午','申','戌']],'坎':['戊',['寅','辰','午'],'戊',['申','戌','子']],'艮':['丙',['辰','午','申'],'丙',['戌','子','寅']],'坤':['乙',['未','巳','卯'],'癸',['丑','亥','酉']],'巽':['辛',['丑','亥','酉'],'辛',['未','巳','卯']],'离':['己',['卯','丑','亥'],'己',['酉','未','巳']],'兑':['丁',['巳','卯','丑'],'丁',['亥','酉','未']]};
    const WUXING_MAP = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    const LIU_SHEN_START = {'甲':0,'乙':0,'丙':1,'丁':1,'戊':2,'己':3,'庚':4,'辛':4,'壬':5,'癸':5};
    const LIU_SHEN_ORDER = ['青龙','朱雀','勾陈','腾蛇','白虎','玄武'];

    createApp({
        setup() {
            const currentLang = ref('zh');
            const viewMode = ref('mobile'); // 'mobile' or 'desktop'
            const mode = ref('liuyao');
            const step = ref(1); 
            const question = ref('');
            
            const inputLines = ref([]);
            const isShaking = ref(false);
            const lastCoins = ref([2,2,2]);
            const statusText = ref('');
            const currentChart = ref(null);
            
            const baziInput = reactive({ gender: '1', date: '', time: '' });
            const baziChart = ref(null);
            const analysisDate = ref(new Date().toISOString().split('T')[0]);
            const selectedDaYunIndex = ref(-1);
            
            const lunarInfo = ref({});
            const toast = reactive({ show: false, message: '', type: 'info' });
            // [新增] 运势功能状态
            const dailyFortune = ref(null);
            
            const drawFortune = () => {
                // 检查 fortunes.js 是否已加载
                if (typeof FORTUNES_DB !== 'undefined' && Array.isArray(FORTUNES_DB) && FORTUNES_DB.length > 0) {
                    const rnd = Math.floor(Math.random() * FORTUNES_DB.length);
                    dailyFortune.value = FORTUNES_DB[rnd];
                    // 自动保存到历史记录（可选）
                    // saveRecord('fortune', dailyFortune.value); 
                } else {
                    showToast('运势数据库未加载', 'error');
                    console.warn('请确保 fortunes.js 已放在同一目录下并在 HTML 中引用。');
                }
            };
            // History State
            const historyOpen = ref(false);
            const historyList = ref([]);

            const t = (key) => messages[currentLang.value][key] || key;
            const translateTerm = (term) => (currentLang.value === 'zh' ? term : (terms.en[term] || term));

            // Load History on Mount
            onMounted(() => {
                const saved = localStorage.getItem('liuyao_history');
                if (saved) {
                    try { historyList.value = JSON.parse(saved); } catch(e) {}
                }
            });

            const saveRecord = (type, data) => {
                const record = {
                    id: Date.now(),
                    type: type, // 'liuyao' or 'bazi'
                    timestamp: Date.now(),
                    question: question.value,
                    title: type === 'liuyao' ? data.main.name : '八字排盘',
                    data: data // Full chart data
                };
                historyList.value.unshift(record);
                localStorage.setItem('liuyao_history', JSON.stringify(historyList.value));
            };

            const loadRecord = (record) => {
                mode.value = record.type;
                question.value = record.question || '';
                
                if (record.type === 'liuyao') {
                    currentChart.value = record.data;
                    // Restore lunar info if saved, else recalc (simplified here)
                    step.value = 3;
                } else {
                    baziChart.value = record.data;
                    step.value = 3;
                }
                historyOpen.value = false;
            };

            const deleteRecord = (id) => {
                historyList.value = historyList.value.filter(item => item.id !== id);
                localStorage.setItem('liuyao_history', JSON.stringify(historyList.value));
            };

            const formatDateSimple = (ts) => {
                const d = new Date(ts);
                return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
            };

            const toggleLang = () => {
                currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh';
                if(step.value === 2 && mode.value === 'liuyao' && !isShaking.value && inputLines.value.length === 0) {
                    statusText.value = currentLang.value === 'zh' ? '点击按钮摇卦' : 'Tap button to shake';
                }
            };
            
            const toggleViewMode = () => {
                viewMode.value = viewMode.value === 'mobile' ? 'desktop' : 'mobile';
                const msg = viewMode.value === 'mobile' 
                    ? (currentLang.value === 'zh' ? '切换至手机视图' : 'Switched to Mobile View')
                    : (currentLang.value === 'zh' ? '切换至桌面视图' : 'Switched to Desktop View');
                showToast(msg, 'info');
            };

            const switchMode = (m) => {
                mode.value = m;
                step.value = 1;
                question.value = '';
                if(m === 'bazi' && !baziInput.date) {
                    const now = new Date();
                    baziInput.date = now.toISOString().split('T')[0];
                    baziInput.time = now.toTimeString().split(' ')[0].substring(0,5);
                }
            };

            const canProceed = computed(() => {
                if(mode.value === 'liuyao') return question.value.trim().length > 0;
                if(mode.value === 'bazi') return baziInput.date && baziInput.time;
                return false;
            });

            const nextStep = () => {
                if(mode.value === 'liuyao') {
                    if(question.value.trim()) {
                        step.value = 2;
                        statusText.value = currentLang.value === 'zh' ? t('btn_shake') : 'Tap button to shake';
                    }
                } else {
                    calcBaZi();
                    step.value = 3;
                }
            };

            const shake = () => {
                if(isShaking.value || inputLines.value.length >= 6) return;
                isShaking.value = true;
                statusText.value = currentLang.value === 'zh' ? '感应中...' : 'Divining...';
                
                setTimeout(() => {
                    const coins = [0,0,0].map(() => Math.random() > 0.5 ? 2 : 3);
                    const sum = coins.reduce((a,b)=>a+b, 0);
                    lastCoins.value = coins;
                    inputLines.value.push(sum);
                    
                    let txt = '';
                    if(sum===6) txt = currentLang.value==='zh' ? "老阴 X" : "Old Yin X"; 
                    if(sum===7) txt = currentLang.value==='zh' ? "少阳 |" : "Young Yang |";
                    if(sum===8) txt = currentLang.value==='zh' ? "少阴 ||" : "Young Yin ||"; 
                    if(sum===9) txt = currentLang.value==='zh' ? "老阳 O" : "Old Yang O";
                    
                    statusText.value = `${currentLang.value==='zh'?'第':'Line'} ${inputLines.value.length} ${currentLang.value==='zh'?'爻':''}: ${txt}`;
                    isShaking.value = false;

                    if(inputLines.value.length === 6) {
                        setTimeout(() => {
                            generateLiuYaoChart();
                            step.value = 3;
                        }, 600);
                    }
                }, 800);
            };
            
            // Helper for coin rotation
            const getCoinRotation = (val) => {
                // val 2 = Yang (Face/Qianlong), val 3 = Yin (Back/Manchu)
                // If isShaking, class handles it. If stopped:
                // Front is 0deg, Back is 180deg
                const deg = val === 2 ? 0 : 180;
                return { transform: `rotateY(${deg}deg)` };
            };

            // 新增：查找数据库中的卦象解释
            const matchHexagramData = (fullName) => {
                if (!fullName) return null;
                // 1. 尝试直接包含匹配 (去掉"卦"字)
                for (let key in DB_DATA.hexagrams) {
                    const item = DB_DATA.hexagrams[key];
                    const shortName = item.name.replace('卦', '');
                    // 检查 full name 是否包含 short name
                    // 例如 "天风姤" 包含 "姤"
                    if (fullName.includes(shortName)) {
                        return item;
                    }
                }
                return null;
            };

            const generateLiuYaoChart = () => {
                const now = new Date();
                const lunar = Lunar.fromDate(now);
                lunarInfo.value = {
                    dateStr: `${lunar.getYearInGanZhi()}年 ${lunar.getMonthInGanZhi()}月 ${lunar.getDayInGanZhi()}日 ${lunar.getTimeInGanZhi()}时`,
                    kongWang: lunar.getDayXunKong(),
                    solarTime: formatDate(now)
                };
                
                const mainBits = [], changedBits = [], movingLines = [];
                inputLines.value.forEach((val, idx) => {
                    if (val === 6) { mainBits.push(0); changedBits.push(1); movingLines.push(idx); }
                    else if (val === 7) { mainBits.push(1); changedBits.push(1); }
                    else if (val === 8) { mainBits.push(0); changedBits.push(0); }
                    else if (val === 9) { mainBits.push(1); changedBits.push(0); movingLines.push(idx); }
                });
                const mainInfo = identifyHexagram(mainBits);
                const changedInfo = identifyHexagram(changedBits);
                const mainDetails = mountHexagram(mainBits, mainInfo, movingLines, true);
                const changedDetails = mountHexagram(changedBits, changedInfo, movingLines, false, mainInfo.element);
                const dayStem = lunar.getDayInGanZhi().substring(0,1);
                const startIdx = LIU_SHEN_START[dayStem] || 0;
                mainDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                changedDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                
                // 匹配数据库解释
                const mainExtra = matchHexagramData(mainInfo.fullName);
                const changedExtra = matchHexagramData(changedInfo.fullName);

                const chartData = {
                    main: { 
                        name: mainInfo.fullName, 
                        palace: mainInfo.palace, 
                        element: mainInfo.element, 
                        lines: [...mainDetails.lines].reverse(),
                        extra: mainExtra // 附加信息
                    },
                    changed: { 
                        name: changedInfo.fullName, 
                        lines: [...changedDetails.lines].reverse(),
                        extra: changedExtra // 附加信息
                    },
                    hasChange: movingLines.length > 0
                };
                currentChart.value = chartData;
                saveRecord('liuyao', chartData);
            };

            const calcBaZi = () => {
                analysisDate.value = new Date().toISOString().split('T')[0];
                const dateParts = baziInput.date.split('-');
                if (dateParts.length !== 3) return;
                const timeParts = baziInput.time.split(':');
                if (timeParts.length !== 2) return;

                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);
                const h = parseInt(timeParts[0]);
                const min = parseInt(timeParts[1]);

                const solar = Solar.fromYmdHms(y, m, d, h, min, 0);
                const lunar = solar.getLunar();
                const eightChar = lunar.getEightChar();
                
                const wuxingCount = { 'gold':0, 'wood':0, 'water':0, 'fire':0, 'earth':0 };
                const pillars = [
                    {s: eightChar.getYearGan(), b: eightChar.getYearZhi()},
                    {s: eightChar.getMonthGan(), b: eightChar.getMonthZhi()},
                    {s: eightChar.getDayGan(), b: eightChar.getDayZhi()},
                    {s: eightChar.getTimeGan(), b: eightChar.getTimeZhi()}
                ];
                
                const getWx = (char) => {
                    if("甲乙寅卯".includes(char)) return 'wood';
                    if("丙丁巳午".includes(char)) return 'fire';
                    if("戊己辰戌丑未".includes(char)) return 'earth';
                    if("庚辛申酉".includes(char)) return 'metal';
                    if("壬癸亥子".includes(char)) return 'water';
                    return 'earth';
                };

                const processedPillars = pillars.map(p => {
                    const sWx = getWx(p.s);
                    const bWx = getWx(p.b);
                    wuxingCount[sWx === 'metal' ? 'gold' : sWx]++; 
                    return { stem: p.s, branch: p.b, stemWx: sWx, branchWx: bWx };
                });
                
                const counts = { 'wood':0, 'fire':0, 'earth':0, 'metal':0, 'water':0 };
                processedPillars.forEach(p => { counts[p.stemWx]++; counts[p.branchWx]++; });

                const gender = parseInt(baziInput.gender); 
                const yun = eightChar.getYun(gender);
                const daYunArr = yun.getDaYun();
                const startAge = (daYunArr && daYunArr.length > 0) ? daYunArr[0].getStartAge() : 0;
                
                const currentAge = new Date().getFullYear() - y + 1; 

                const processedDaYun = daYunArr.slice(0, 8).map(dy => {
                    const age = dy.getStartAge();
                    const isActive = currentAge >= age && currentAge < (age + 10);
                    return { ganZhi: dy.getGanZhi(), startAge: age, isCurrent: isActive };
                });

                const currentIdx = processedDaYun.findIndex(d => d.isCurrent);
                selectedDaYunIndex.value = currentIdx !== -1 ? currentIdx : 0;

                const chartData = {
                    gender: baziInput.gender,
                    solarDate: `${y}-${m}-${d} ${h}:${min}`,
                    pillars: processedPillars,
                    wuxingCount: counts,
                    startAge: startAge,
                    dayun: processedDaYun,
                    currentAge: currentAge,
                    currentLiuNian: '',
                    currentLiuRi: '',
                    interpretation: {
                        // eightChar.getDayGan() 获取日柱天干 (例如 "甲")
                        dm: DB_DATA.bazi_data.day_masters[eightChar.getDayGan()] || {name: '未知', title:'-', desc:'暂无数据'}
                    }
                };
                baziChart.value = chartData;
                updateAnalysis();
                saveRecord('bazi', chartData);
            };

            const updateAnalysis = () => {
                if(!baziChart.value) return;
                const dateParts = analysisDate.value.split('-');
                if (dateParts.length !== 3) return;
                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);
                const solar = Solar.fromYmd(y, m, d);
                const lunar = solar.getLunar();
                baziChart.value.currentLiuNian = lunar.getYearInGanZhi() + (currentLang.value==='zh'?'年':'');
                baziChart.value.currentLiuRi = lunar.getDayInGanZhi() + (currentLang.value==='zh'?'日':'');
            };

            const selectDaYun = (index) => { selectedDaYunIndex.value = index; };

            const formatDate = (date) => date.toLocaleString('zh-CN', {hour12:false});
            const getWuXingColor = (wx) => `wx-${wx}`;
            const getWuXingHex = (wx) => {
                const map = { wood:'#2d6a4f', fire:'#d63031', earth:'#a0522d', metal:'#636e72', water:'#0984e3' };
                return map[wx];
            };

            const getCopyText = () => {
                if(mode.value === 'liuyao') return getLiuYaoText();
                return getBaZiText();
            };

            const getLiuYaoText = () => {
                const c = currentChart.value;
                const isZh = currentLang.value === 'zh';
                const changeText = c.hasChange ? ` -> ${c.changed.name}` : '';
                let linesText = '';
                c.main.lines.forEach(line => {
                    const lineSymbol = line.isYang ? "====== " : "==  == ";
                    const movingMark = line.isMoving ? (line.isYang ? "O" : "X") : " "; 
                    const shiYing = line.shi ? (isZh?"(世)":"(Self)") : (line.ying ? (isZh?"(应)":"(Other)") : "    ");
                    linesText += `${lineSymbol}${movingMark} ${translateTerm(line.beast)} ${translateTerm(line.relation)} ${line.branch}${translateTerm(line.wuxing)} ${shiYing}\n`;
                });
                return `${t('msg_intro')}
${t('msg_q')} ${question.value}
${t('msg_t')} ${lunarInfo.value.dateStr}
${t('msg_g')} ${c.main.name} ${changeText}
------------------------
${linesText}------------------------
${t('msg_end')}`;
            };

            const getBaZiText = () => {
                const c = baziChart.value;
                const gender = c.gender === '1' ? t('bazi_male') : t('bazi_female');
                const p = c.pillars;
                const qText = question.value ? `\n${t('msg_q')} ${question.value}` : '';
                const selDy = c.dayun[selectedDaYunIndex.value];
                const dyText = selDy ? `${selDy.ganZhi} (${selDy.startAge}${t('label_age_short')})` : 'N/A';

                return `${t('msg_intro')}
${t('label_birth_date')}: ${c.solarDate}
${gender} (${c.currentAge}${t('label_age_short')})
${qText}

${t('msg_bazi')}
${t('col_year')}  ${t('col_month')}  ${t('col_day')}  ${t('col_hour')}
${p[0].stem}${p[0].branch}  ${p[1].stem}${p[1].branch}  ${p[2].stem}${p[2].branch}  ${p[3].stem}${p[3].branch}

${t('msg_yun')}
Focus: ${dyText}
${t('label_analysis_date')}: ${analysisDate.value}
${t('label_curr_year')}: ${c.currentLiuNian}
${t('label_curr_day')}: ${c.currentLiuRi}

${t('label_5_elements')}: 
${t('wx_metal')}:${c.wuxingCount.metal} ${t('wx_wood')}:${c.wuxingCount.wood} ${t('wx_water')}:${c.wuxingCount.water} ${t('wx_fire')}:${c.wuxingCount.fire} ${t('wx_earth')}:${c.wuxingCount.earth}

${t('msg_end')}`;
            };

            const contactWhatsApp = () => {
                const url = `https://wa.me/${MY_WHATSAPP_NUMBER}?text=${encodeURIComponent(getCopyText())}`;
                window.open(url, '_blank');
            };

            const contactWeChat = async () => {
                const text = getCopyText();
                copyToClipboard(text).then(() => {
                    showToast(t('toast_copy_success'), 'success');
                    setTimeout(() => window.location.href = 'weixin://', 1200);
                }).catch(() => showToast(t('toast_fail'), 'error'));
            };
            
            const copyToClipboard = (text) => {
                return new Promise((resolve, reject) => {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(resolve).catch(() => fallbackCopy(text, resolve, reject));
                    } else fallbackCopy(text, resolve, reject);
                });
            };
            const fallbackCopy = (text, resolve, reject) => {
                try {
                    const ta = document.createElement("textarea");
                    ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
                    document.body.appendChild(ta); ta.focus(); ta.select();
                    const s = document.execCommand('copy'); document.body.removeChild(ta);
                    if(s) resolve(); else reject();
                } catch(e) { reject(e); }
            };
            const copyWeChatIDOnly = () => {
                copyToClipboard(MY_WECHAT_ID).then(() => showToast(t('toast_wechat_copy'), 'success')).catch(() => showToast(t('toast_fail'), 'error'));
            };
            const showToast = (msg, type='info') => {
                toast.message = msg; toast.type = type; toast.show = true;
                setTimeout(() => toast.show = false, 3000);
            };
            const resetAll = () => {
                step.value = 1; inputLines.value = []; question.value = ''; statusText.value = '';
            };

            const identifyHexagram=(bits)=>{const lKey=''+bits[2]+bits[1]+bits[0],uKey=''+bits[5]+bits[4]+bits[3];const tian=bits[5]===bits[2],ren=bits[4]===bits[1],di=bits[3]===bits[0];let shi=0,pName='',isYou=false,isGui=false;const uName=TRIGRAMS[uKey].name,lName=TRIGRAMS[lKey].name;const inv=(k)=>k.split('').map(x=>x==='1'?'0':'1').join('');if(tian&&ren&&di){shi=6;pName=uName;}else if(tian&&ren&&!di){shi=1;pName=uName;}else if(tian&&!ren&&!di){shi=2;pName=uName;}else if(!tian&&!ren&&!di){shi=3;pName=uName;}else if(!tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;}else if(!tian&&ren&&di){shi=5;pName=TRIGRAMS[inv(lKey)].name;}else if(tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;isYou=true;}else if(!tian&&ren&&!di){shi=3;pName=lName;isGui=true;}const pEl=NA_JIA[pName]?TRIGRAMS[Object.keys(TRIGRAMS).find(k=>TRIGRAMS[k].name===pName)].element:'金';let oIdx=0;if(shi===6)oIdx=0;else if(shi===1)oIdx=1;else if(shi===2)oIdx=2;else if(shi===3&&!isGui)oIdx=3;else if(shi===4&&!isYou)oIdx=4;else if(shi===5)oIdx=5;else if(isYou)oIdx=6;else if(isGui)oIdx=7;let pIndex=['乾','坎','艮','震','巽','离','坤','兑'].indexOf(pName);if(pIndex===-1)pIndex=0;return{fullName:PALACES[pIndex][oIdx],palace:pName,palaceIndex:pIndex,element:pEl,shiIndex:shi-1,yingIndex:(shi-1+3)%6};};
            const mountHexagram=(bits,info,mov,isM,overrideEl)=>{const lName=TRIGRAMS[''+bits[2]+bits[1]+bits[0]].name,uName=TRIGRAMS[''+bits[5]+bits[4]+bits[3]].name;const lines=[],pEl=overrideEl||info.element;for(let i=0;i<6;i++){const isY=bits[i]===1,rule=i<3?NA_JIA[lName]:NA_JIA[uName];const st=i<3?rule[0]:rule[2],br=i<3?rule[1][i]:rule[3][i-3];const wx=WUXING_MAP[br],rel=getLiuQin(pEl,wx);lines.push({index:i,isYang:isY,stem:st,branch:br,wuxing:wx,relation:rel,shi:isM&&i===info.shiIndex,ying:isM&&i===info.yingIndex,isMoving:isM&&mov.includes(i),isMovingOrigin:!isM&&mov.includes(i)});}return{lines};};
            const getLiuQin=(p,l)=>{const gens={'木':'火','火':'土','土':'金','金':'水','水':'木'},cons={'木':'土','土':'水','水':'火','火':'金','金':'木'};if(p===l)return'兄弟';if(gens[l]===p)return'父母';if(gens[p]===l)return'子孙';if(cons[l]===p)return'官鬼';if(cons[p]===l)return'妻财';return'未知';};
            const getRelationClass = (r) => { if(r==='官鬼') return 'text-purple-700'; if(r==='妻财') return 'text-green-700'; if(r==='子孙') return 'text-blue-700'; if(r==='兄弟') return 'text-orange-700'; return 'text-stone-600'; };

            return { 
                mode, step, question, inputLines, isShaking, lastCoins, statusText, currentChart, lunarInfo, 
                baziInput, baziChart, analysisDate, selectedDaYunIndex, toast, viewMode, currentLang,
                // [新增] 导出运势相关变量
                dailyFortune, drawFortune,
                t, toggleLang, toggleViewMode, switchMode, nextStep, shake, resetAll, contactWhatsApp, contactWeChat, copyWeChatIDOnly, getRelationClass, translateTerm, getWuXingColor, getWuXingHex, canProceed, MY_WECHAT_ID,
                updateAnalysis, selectDaYun,
                historyOpen, historyList, loadRecord, deleteRecord, formatDateSimple, getCoinRotation,
                matchHexagramData
        
            };
        }
    }).mount('#app');
</script>
</body>
</html>
