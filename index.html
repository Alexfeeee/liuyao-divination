<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>六爻天机 - 东方命理美学</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 3. Lunar.js -->
    <script src="https://unpkg.com/lunar-javascript@1.6.12/lunar.js"></script>
    
    <!-- 4. Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- 5. 不蒜子 -->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&family=Ma+Shan+Zheng&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --bg-paper: #f9f7f2;
            --ink-primary: #2b2b2b;
            --cinnabar: #c02c38;
        }

        body {
            font-family: 'Inter', 'Noto Serif SC', serif;
            background-color: #f0f2f5;
            color: var(--ink-primary);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll;
        }

        /* 修复：将 app-frame 样式移到内部容器 */
        .app-frame-style {
            background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='64' height='64' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M8 16c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm0-2c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zm33.414-6l5.95-5.95L45.95.636 40 6.586 34.05.636 32.636 2.05 38.586 8l-5.95 5.95 1.414 1.414L40 9.414l5.95 5.95 1.414-1.414L41.414 8zM40 4.828l4.536 4.536L40 13.899l-4.536-4.536L40 4.828zM16 48c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm0-2c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zM8 32c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm0-2c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zm33.414 32l5.95-5.95L45.95 48.636 40 54.586 34.05 48.636 32.636 50.05 38.586 56l-5.95 5.95 1.414 1.414L40 57.414l5.95 5.95 1.414-1.414L41.414 56zM40 52.828l4.536 4.536L40 61.899l-4.536-4.536L40 52.828z' fill='%23d6d3cd' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
            min-height: 100vh;
            transition: max-width 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.5s ease;
            margin: 0 auto;
        }

        /* 模式切换类 */
        .mode-mobile { max-width: 430px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
        .mode-desktop { max-width: 800px; box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 20px 60px rgba(0,0,0,0.1); }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* 组件样式 */
        .yang-stroke { 
            height: 10px; width: 100%; 
            background: linear-gradient(180deg, #d63031 0%, #c0392b 100%);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(192, 57, 43, 0.3);
        }
        .yin-stroke-wrapper { display: flex; justify-content: space-between; width: 100%; }
        .yin-stroke { 
            height: 10px; width: 42%; 
            background: linear-gradient(180deg, #636e72 0%, #2d3436 100%);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(45, 52, 54, 0.3);
        }

        .coin {
            width: 72px; height: 72px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #f9e79f, #d4ac0d);
            box-shadow: inset 0 0 0 3px #b7950b, inset 0 0 0 5px #fcf3cf, 0 4px 8px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; font-weight: bold; color: #7d6608;
            position: relative; border: 1px solid #9a7d0a;
        }
        .coin::before { content: ''; position: absolute; width: 22px; height: 22px; background: #e8e6e1; border: 1px solid #b7950b; z-index: 1; }
        .coin-text { position: absolute; z-index: 2; font-family: 'Ma Shan Zheng', cursive; text-shadow: 0 1px 0 rgba(255,255,255,0.6); }

        .card-neo {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 10px 15px -3px rgba(0, 0, 0, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        .bazi-pillar-card {
            background: linear-gradient(to bottom, #ffffff, #fdfbf7);
            border: 1px solid #efebe4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 12px 0;
            transition: all 0.3s;
        }
        /* Desktop模式下八字卡片稍微大一点 */
        .mode-desktop .bazi-pillar-card { padding: 20px 0; }

        .dayun-capsule {
            min-width: 3.8rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0.6rem 0;
            border-radius: 12px;
            font-size: 0.75rem;
            background: #ffffff;
            border: 1px solid #e5e5e5;
            color: #595959;
            transition: all 0.2s;
        }
        .dayun-selected {
            background: linear-gradient(135deg, #c02c38, #a9232e) !important;
            border-color: #a9232e !important;
            color: white !important;
            box-shadow: 0 4px 10px rgba(192, 44, 56, 0.3);
            transform: translateY(-2px);
        }
        .dayun-selected * { color: white !important; }
        .dayun-current-border { border: 1.5px solid #c02c38; background-color: #fff5f5; }

        .btn-primary {
            background: #2b2b2b; color: #f7f5f0;
            border-radius: 12px; box-shadow: 0 4px 12px rgba(43, 43, 43, 0.25);
            transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-action-wechat { background: #07C160; color: white; box-shadow: 0 4px 10px rgba(7, 193, 96, 0.3); }
        .btn-action-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }

        .tab-switcher {
            background: #e8e6e1; padding: 4px; border-radius: 14px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-item { border-radius: 10px; transition: all 0.3s ease; color: #787878; font-weight: 500; }
        .tab-active { background: white; color: #c02c38; box-shadow: 0 2px 5px rgba(0,0,0,0.08); font-weight: 700; }

        .wx-wood { color: #2d6a4f; } .wx-fire { color: #d63031; } .wx-earth { color: #a0522d; } 
        .wx-metal { color: #636e72; } .wx-water { color: #0984e3; } 

        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active { transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .slide-up-enter-from { opacity: 0; transform: translateY(20px); }
        .slide-up-enter-to { opacity: 1; transform: translateY(0); }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s; }
        .toast-enter-from, .toast-leave-to { transform: translateY(-100%); opacity: 0; }

        @keyframes toss {
            0% { transform: translateY(0) rotateX(0) scale(1); }
            50% { transform: translateY(-150px) rotateX(1080deg) scale(1.2); }
            100% { transform: translateY(0) rotateX(2160deg) scale(1); }
        }
        .animate-toss { animation: toss 0.8s cubic-bezier(0.45, 0.05, 0.55, 0.95); }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-stone-100">

<div id="app" class="w-full flex justify-center">

    <!-- 修复：通过内部容器实现动态宽度 -->
    <div :class="viewMode === 'mobile' ? 'mode-mobile' : 'mode-desktop'" class="app-frame-style flex flex-col relative w-full">

        <!-- Toast -->
        <transition name="toast">
            <div v-if="toast.show" class="absolute top-6 left-0 right-0 z-50 flex justify-center pointer-events-none">
                <div class="bg-stone-900/90 backdrop-blur text-white px-4 py-2.5 rounded-full shadow-xl text-sm flex items-center gap-2 pointer-events-auto">
                    <i v-if="toast.type === 'success'" class="ph-fill ph-check-circle text-green-400 text-lg leading-none"></i>
                    <i v-else class="ph-fill ph-info text-blue-400 text-lg leading-none"></i>
                    <span class="font-medium">{{ toast.message }}</span>
                </div>
            </div>
        </transition>

        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-6 shrink-0 sticky top-0 z-40 bg-[#f9f7f2]/80 backdrop-blur-md border-b border-stone-200/60">
            <!-- 视图切换按钮 -->
            <button @click="toggleViewMode" class="w-9 h-9 flex items-center justify-center rounded-full bg-white border border-stone-200 shadow-sm active:scale-90 transition text-stone-600 hover:text-[#c02c38]" :title="viewMode==='mobile' ? 'Switch to Desktop' : 'Switch to Mobile'">
                <i v-if="viewMode === 'mobile'" class="ph-bold ph-desktop text-lg leading-none"></i>
                <i v-else class="ph-bold ph-device-mobile text-lg leading-none"></i>
            </button>
            
            <div class="flex flex-col items-center">
                <h1 class="font-serif font-bold text-xl tracking-[0.15em] text-[#c02c38]" style="font-family: 'Ma Shan Zheng', cursive;">
                    {{ t('app_title') }}
                </h1>
            </div>
            
            <!-- 语言切换按钮 -->
            <button @click="toggleLang" class="w-9 h-9 flex items-center justify-center rounded-full bg-white border border-stone-200 shadow-sm active:scale-90 transition text-stone-600 font-bold text-xs hover:text-[#c02c38]">
                {{ currentLang === 'zh' ? 'EN' : '中' }}
            </button>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden p-5 pb-24 relative scroll-smooth" ref="scrollContainer">
            
            <!-- Phase 1: 入口 -->
            <transition name="fade" mode="out-in">
                <div v-if="step === 1" key="step1" class="flex flex-col h-full max-w-lg mx-auto">
                    
                    <div class="tab-switcher flex mb-8">
                        <button @click="switchMode('liuyao')" class="flex-1 py-2.5 text-sm tab-item" :class="mode === 'liuyao' ? 'tab-active' : ''">{{ t('tab_liuyao') }}</button>
                        <button @click="switchMode('bazi')" class="flex-1 py-2.5 text-sm tab-item" :class="mode === 'bazi' ? 'tab-active' : ''">{{ t('tab_bazi') }}</button>
                    </div>

                    <div class="text-center space-y-2 mb-8 mt-4">
                        <div class="relative inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-white border border-stone-100 shadow-sm mb-2">
                            <i v-if="mode==='liuyao'" class="ph-fill ph-hands-praying text-4xl text-[#c02c38] leading-none"></i>
                            <i v-else class="ph-fill ph-scroll text-4xl text-[#c02c38] leading-none"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-stone-800 tracking-wide font-serif">{{ t(mode + '_title') }}</h2>
                        <p class="text-stone-400 text-[10px] tracking-[0.2em] uppercase font-sans">{{ t(mode + '_subtitle') }}</p>
                    </div>

                    <div class="w-full space-y-6 flex-1">
                        <div v-if="mode === 'liuyao'" class="space-y-5">
                            <div class="relative group">
                                <textarea v-model="question" rows="4" :placeholder="t('step1_placeholder')" 
                                    class="w-full p-5 bg-white border border-stone-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#c02c38]/20 transition shadow-sm text-stone-700 text-lg leading-relaxed placeholder:text-stone-300 resize-none"></textarea>
                                <div class="absolute bottom-3 right-3 text-stone-300">
                                    <i class="ph-bold ph-pencil-simple-line text-lg leading-none"></i>
                                </div>
                            </div>
                        </div>

                        <div v-else class="space-y-5">
                            <div class="flex gap-4">
                                <label class="flex-1 flex items-center justify-center gap-2 p-4 bg-white border border-stone-100 rounded-2xl cursor-pointer hover:shadow-md transition-all" :class="baziInput.gender==='1'?'ring-2 ring-blue-100 bg-blue-50/30':''">
                                    <input type="radio" v-model="baziInput.gender" value="1" class="hidden">
                                    <i class="ph-bold ph-gender-male text-lg text-blue-600 leading-none"></i>
                                    <span class="text-sm font-bold text-stone-700">{{ t('gender_male') }}</span>
                                </label>
                                <label class="flex-1 flex items-center justify-center gap-2 p-4 bg-white border border-stone-100 rounded-2xl cursor-pointer hover:shadow-md transition-all" :class="baziInput.gender==='0'?'ring-2 ring-pink-100 bg-pink-50/30':''">
                                    <input type="radio" v-model="baziInput.gender" value="0" class="hidden">
                                    <i class="ph-bold ph-gender-female text-lg text-pink-600 leading-none"></i>
                                    <span class="text-sm font-bold text-stone-700">{{ t('gender_female') }}</span>
                                </label>
                            </div>
                            <div class="bg-white border border-stone-100 rounded-2xl p-5 space-y-4 shadow-sm">
                                <div class="flex items-center justify-between border-b border-stone-100 pb-2">
                                    <label class="text-xs text-stone-400 font-bold tracking-wide uppercase">{{ t('label_birth_date') }}</label>
                                    <input type="date" v-model="baziInput.date" class="bg-transparent text-right font-mono font-bold text-stone-800 focus:outline-none text-base">
                                </div>
                                <div class="flex items-center justify-between pt-1">
                                    <label class="text-xs text-stone-400 font-bold tracking-wide uppercase">{{ t('label_birth_time') }}</label>
                                    <input type="time" v-model="baziInput.time" class="bg-transparent text-right font-mono font-bold text-stone-800 focus:outline-none text-base">
                                </div>
                            </div>
                            <input v-model="question" type="text" :placeholder="t('bazi_question_ph')" class="w-full p-4 bg-white border border-stone-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#c02c38]/20 transition shadow-sm text-stone-700 placeholder:text-stone-300">
                        </div>
                        
                        <button @click="nextStep" :disabled="!canProceed" class="w-full py-4 btn-primary text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4">
                            <span>{{ t('btn_start') }}</span>
                            <i class="ph-bold ph-arrow-right text-lg leading-none"></i>
                        </button>
                        
                        <div class="text-center mt-6">
                             <p class="text-[10px] text-stone-400 font-serif italic">{{ t('step1_footer') }}</p>
                        </div>
                    </div>
                </div>

                <!-- Phase 2: 摇卦 -->
                <div v-else-if="step === 2 && mode === 'liuyao'" key="step2" class="flex flex-col h-full justify-center max-w-lg mx-auto">
                    <div class="text-center mb-10 animate-fade-in">
                        <div class="text-[10px] text-stone-400 uppercase tracking-widest mb-2 font-bold">{{ t('label_question') }}</div>
                        <div class="font-serif font-bold text-xl text-stone-800 px-4 leading-relaxed line-clamp-2">{{ question }}</div>
                        <div class="w-8 h-1 bg-[#c02c38] mx-auto mt-4 rounded-full opacity-80"></div>
                    </div>

                    <div class="flex flex-col items-center justify-center space-y-12">
                        <div class="h-24 flex items-center justify-center gap-5 perspective-1000 w-full">
                            <div v-for="c in 3" :key="c" class="coin transform transition-all" :class="{'animate-toss': isShaking}">
                                <div class="coin-text" :class="lastCoins[c-1] === 3 ? 'top-[42%] left-[45%]' : 'top-[10%] left-[30%]'">
                                    <span v-if="!isShaking && lastCoins[c-1] === 2" class="text-sm scale-90 block">{{ t('coin_yang') }}</span>
                                    <i v-if="!isShaking && lastCoins[c-1] === 3" class="ph-fill ph-flower-lotus text-xs opacity-60 text-[#b7950b] leading-none"></i>
                                </div>
                            </div>
                        </div>
                        <div class="text-center space-y-8 w-full">
                            <div class="relative inline-block">
                                 <button @click="shake" :disabled="isShaking" class="w-28 h-28 rounded-full bg-[#c02c38] text-white font-bold text-xl shadow-[0_10px_30px_rgba(192,44,56,0.4)] active:scale-90 transition-all flex flex-col items-center justify-center gap-1 z-10 relative overflow-hidden group border-4 border-[#e8e6e1]" :class="{'btn-shake': !isShaking && inputLines.length < 6}">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <i class="ph-fill ph-hand-waving text-3xl mb-1 group-hover:rotate-12 transition-transform leading-none"></i>
                                    <span class="text-sm font-medium tracking-widest">{{ inputLines.length < 6 ? t('btn_shake') : t('btn_finish') }}</span>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div class="font-mono text-[#c02c38] font-bold h-6 text-sm tracking-wider">{{ statusText }}</div>
                                <div class="flex justify-center gap-2">
                                    <div v-for="i in 6" :key="i" class="w-2 h-2 rounded-full transition-all duration-500" :class="inputLines.length >= i ? 'bg-[#c02c38] scale-125' : 'bg-stone-300 scale-100'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 3: 结果展示 -->
                <div v-else-if="step === 3" key="step3" class="space-y-6 pb-10 max-w-2xl mx-auto">
                    
                    <!-- Hexagram Result -->
                    <template v-if="mode === 'liuyao'">
                        <div class="text-center pt-2">
                            <div class="text-sm text-stone-600 font-bold font-mono tracking-wide bg-white px-3 py-1 rounded-full shadow-sm inline-block border border-stone-100">{{ lunarInfo.dateStr }}</div>
                            <div class="text-[10px] text-stone-400 font-mono mt-2">{{ t('label_void') }}: {{ lunarInfo.kongWang }}</div>
                        </div>

                        <transition appear name="slide-up">
                            <div class="card-neo p-5 relative overflow-hidden">
                                <div class="absolute left-0 top-4 bottom-4 w-1 bg-[#c02c38] rounded-r-full"></div>
                                <div class="flex justify-between items-end mb-6 px-2">
                                    <div>
                                        <span class="text-[10px] text-stone-400 font-bold tracking-widest uppercase mb-1 block">Present Energy</span>
                                        <h3 class="text-3xl font-bold text-[#c02c38] font-serif">{{ currentChart.main.name }}</h3>
                                        <span class="text-[10px] text-stone-500 bg-stone-100 px-2 py-0.5 rounded-md mt-2 inline-block font-medium">
                                            {{ currentChart.main.palace }}{{ t('label_palace') }} · {{ translateTerm(currentChart.main.element) }}
                                        </span>
                                    </div>
                                    <div class="text-5xl text-stone-100 font-serif absolute right-2 top-0 select-none -z-10" style="font-family: 'Ma Shan Zheng'">{{ t('label_main_bg') }}</div>
                                </div>

                                <div class="space-y-3 relative z-10 px-1">
                                    <div v-for="line in currentChart.main.lines" :key="'main-'+line.index" class="flex items-center text-sm h-8 group">
                                        <!-- 修复：英文模式下六神和六亲列宽加倍，防止挤压 -->
                                        <div :class="currentLang === 'en' ? 'w-16' : 'w-10'" class="text-stone-400 text-[10px] text-center scale-90 font-medium transition-all">{{ translateTerm(line.beast) }}</div>
                                        <div :class="currentLang === 'en' ? 'w-16' : 'w-10'" class="font-bold text-xs text-center scale-90 transition-all" :class="getRelationClass(line.relation)">{{ translateTerm(line.relation) }}</div>
                                        
                                        <div class="w-12 font-mono text-[10px] text-stone-500 scale-90 origin-center text-center">{{ line.stem }}{{ line.branch }}{{ translateTerm(line.wuxing) }}</div>
                                        <div class="flex-1 px-3 flex items-center">
                                            <div v-if="line.isYang" class="yang-stroke relative"><div v-if="line.isMoving" class="absolute -right-1 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-[#c02c38] animate-pulse shadow-[0_0_5px_#c02c38]"></div></div>
                                            <div v-else class="yin-stroke-wrapper relative"><div class="yin-stroke"></div> <div class="yin-stroke"></div><div v-if="line.isMoving" class="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-[#c02c38] animate-pulse shadow-[0_0_5px_#c02c38]"></div></div>
                                        </div>
                                        <!-- 修复：英文模式下世应列宽加倍 -->
                                        <div :class="currentLang === 'en' ? 'w-12' : 'w-6'" class="text-[10px] font-bold text-center transition-all">
                                            <span v-if="line.shi" class="text-white bg-[#c02c38] flex items-center justify-center rounded-md shadow-sm shadow-red-200" :class="currentLang === 'en' ? 'px-2 py-0.5 w-auto' : 'w-5 h-5'">{{ t('label_shi') }}</span>
                                            <span v-if="line.ying" class="text-[#c02c38] border border-[#c02c38] flex items-center justify-center rounded-md opacity-60" :class="currentLang === 'en' ? 'px-2 py-0.5 w-auto' : 'w-5 h-5'">{{ t('label_ying') }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>

                        <div v-if="currentChart.hasChange" class="flex justify-center -my-3 relative z-10 opacity-50"><div class="bg-stone-200 rounded-full p-1 border-4 border-[#f0f2f5]"><i class="ph-bold ph-arrow-down text-xl text-stone-500 leading-none"></i></div></div>

                        <transition appear name="slide-up" v-if="currentChart.hasChange">
                            <div class="card-neo p-5 relative overflow-hidden bg-[#ffffff]/60">
                                 <div class="absolute left-0 top-4 bottom-4 w-1 bg-stone-300 rounded-r-full"></div>
                                <div class="flex justify-between items-end mb-6 px-2">
                                    <div>
                                        <span class="text-[10px] text-stone-400 font-bold tracking-widest uppercase mb-1 block">Future Trend</span>
                                        <h3 class="text-2xl font-bold text-stone-600 font-serif">{{ currentChart.changed.name }}</h3>
                                    </div>
                                    <div class="text-5xl text-stone-100 font-serif absolute right-2 top-0 select-none -z-10" style="font-family: 'Ma Shan Zheng'">{{ t('label_change_bg') }}</div>
                                </div>
                                <div class="space-y-3 relative z-10 px-1 opacity-80">
                                    <div v-for="line in currentChart.changed.lines" :key="'changed-'+line.index" class="flex items-center text-sm h-8">
                                        <div :class="currentLang === 'en' ? 'w-16' : 'w-10'" class="text-stone-400 text-[10px] text-center scale-90">{{ translateTerm(line.beast) }}</div>
                                        <div :class="currentLang === 'en' ? 'w-16' : 'w-10'" class="font-bold text-xs text-center scale-90" :class="getRelationClass(line.relation)">{{ translateTerm(line.relation) }}</div>
                                        <div class="w-12 font-mono text-[10px] text-stone-500 scale-90 origin-center text-center">{{ line.stem }}{{ line.branch }}{{ translateTerm(line.wuxing) }}</div>
                                        <div class="flex-1 px-3 flex items-center">
                                            <div v-if="line.isYang" class="yang-stroke !bg-none bg-stone-400 !box-shadow-none"></div>
                                            <div v-else class="yin-stroke-wrapper"><div class="yin-stroke !bg-none bg-stone-400 !box-shadow-none"></div> <div class="yin-stroke !bg-none bg-stone-400 !box-shadow-none"></div></div>
                                        </div>
                                        <div :class="currentLang === 'en' ? 'w-12' : 'w-6'"></div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </template>

                    <!-- BaZi Result -->
                    <template v-else>
                        <transition appear name="slide-up">
                            <div class="card-neo p-5 relative overflow-hidden">
                                <div class="flex justify-between items-center mb-6 pb-3 border-b border-stone-100">
                                    <div class="flex items-center gap-2">
                                        <span class="w-1 h-4 bg-[#c02c38] rounded-full"></span>
                                        <div class="text-xs font-bold text-stone-700">{{ baziChart.gender === '1' ? t('bazi_male') : t('bazi_female') }}</div>
                                    </div>
                                    <div class="text-[10px] text-stone-400 font-mono bg-stone-50 px-2 py-1 rounded">{{ baziChart.solarDate }}</div>
                                </div>
                                <div class="grid grid-cols-4 gap-2 mb-8">
                                    <div v-for="(col, idx) in ['year', 'month', 'day', 'hour']" :key="idx" class="text-center">
                                         <div class="text-[9px] text-stone-400 uppercase tracking-widest mb-1">{{ t('col_'+col) }}</div>
                                         <div class="bazi-pillar-card">
                                             <div class="text-xl font-bold mb-1 font-serif" :class="getWuXingColor(baziChart.pillars[idx].stemWx)">{{ baziChart.pillars[idx].stem }}</div>
                                             <div class="text-xl font-bold mb-2 font-serif" :class="getWuXingColor(baziChart.pillars[idx].branchWx)">{{ baziChart.pillars[idx].branch }}</div>
                                             <div class="text-[9px] text-stone-400 font-mono">{{ t('wx_'+baziChart.pillars[idx].stemWx) }}</div>
                                         </div>
                                    </div>
                                </div>
                                <div class="bg-stone-50/80 rounded-xl p-4 border border-stone-100 mb-6">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="text-[10px] font-bold text-stone-500 uppercase tracking-wide flex items-center gap-1"><i class="ph-fill ph-chart-line-up leading-none"></i> {{ t('label_luck_cycle') }}</div>
                                        <div class="text-[10px] text-[#c02c38] font-bold bg-red-50 px-2 py-0.5 rounded-md border border-red-100">{{ t('label_start_luck') }}: {{ baziChart.startAge }} {{ t('label_age') }}</div>
                                    </div>
                                    <div class="flex overflow-x-auto gap-2 pb-2 mb-4 no-scrollbar">
                                        <div v-for="(dy, idx) in baziChart.dayun" :key="idx" @click="selectDaYun(idx)" class="dayun-capsule cursor-pointer shrink-0 relative" :class="[selectedDaYunIndex === idx ? 'dayun-selected' : '', (dy.isCurrent && selectedDaYunIndex !== idx) ? 'dayun-current-border' : '']">
                                            <div class="font-bold text-sm font-serif">{{ dy.ganZhi }}</div>
                                            <div class="text-[9px] opacity-70 mt-0.5">{{ dy.startAge }}{{ t('label_age_short') }}</div>
                                            <div v-if="dy.isCurrent && selectedDaYunIndex !== idx" class="absolute -top-1 -right-1 w-2 h-2 bg-[#c02c38] rounded-full"></div>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-100 flex items-center justify-between relative overflow-hidden">
                                        <div class="flex flex-col relative z-10">
                                            <span class="text-[9px] text-stone-400 mb-1 flex items-center gap-1"><i class="ph-bold ph-calendar-blank leading-none"></i> {{ t('label_analysis_date') }}</span>
                                            <input type="date" v-model="analysisDate" @change="updateAnalysis" class="bg-transparent font-mono text-xs font-bold text-stone-700 focus:outline-none p-0 m-0 border-b border-dashed border-stone-300 cursor-pointer">
                                        </div>
                                        <div class="text-right z-10">
                                            <div class="font-bold text-stone-800 text-sm font-serif">{{ baziChart.currentLiuNian }}</div>
                                            <div class="font-bold text-stone-400 text-xs font-serif">{{ baziChart.currentLiuRi }}</div>
                                        </div>
                                        <div class="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-stone-50 to-transparent pointer-events-none"></div>
                                    </div>
                                </div>
                                <div class="bg-stone-50/50 rounded-xl p-3 border border-stone-100">
                                    <div class="text-[10px] text-stone-400 mb-2 uppercase tracking-wider font-bold">{{ t('label_5_elements') }}</div>
                                    <div class="flex h-2.5 rounded-full overflow-hidden w-full mb-2">
                                        <div v-for="(count, wx) in baziChart.wuxingCount" :key="wx" :style="{width: (count/8*100) + '%', backgroundColor: getWuXingHex(wx)}" class="h-full transition-all duration-500"></div>
                                    </div>
                                    <div class="flex justify-between px-1">
                                        <div v-for="(count, wx) in baziChart.wuxingCount" :key="'txt'+wx" class="flex flex-col items-center">
                                            <span class="text-[10px] font-bold text-stone-600">{{count}}</span>
                                            <span class="w-1.5 h-1.5 rounded-full mt-0.5" :style="{backgroundColor: getWuXingHex(wx)}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </template>

                    <!-- CTA Section -->
                    <transition appear name="slide-up">
                        <div class="card-neo p-6 text-center space-y-5 mt-6 bg-gradient-to-b from-white to-[#f7f9f8] border-stone-100">
                            <div class="relative z-10">
                                <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600 shadow-sm">
                                    <i class="ph-fill ph-chats-circle text-2xl leading-none"></i>
                                </div>
                                <h3 class="text-lg font-bold text-stone-800 mb-2 font-serif tracking-wide">{{ t('cta_title') }}</h3>
                                <p class="text-xs text-stone-500 leading-relaxed px-2">{{ t('cta_desc_1') }}<br>{{ t('cta_desc_2') }}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="contactWhatsApp" class="btn-action-whatsapp w-full py-3 rounded-xl font-bold text-sm active:scale-95 transition-all flex flex-col items-center justify-center gap-1">
                                    <i class="ph-bold ph-whatsapp-logo text-xl leading-none"></i>
                                    <span>WhatsApp</span>
                                </button>
                                <button @click="contactWeChat" class="btn-action-wechat w-full py-3 rounded-xl font-bold text-sm active:scale-95 transition-all flex flex-col items-center justify-center gap-1">
                                    <i class="ph-bold ph-wechat-logo text-xl leading-none"></i>
                                    <span>{{ t('btn_wechat') }}</span>
                                </button>
                            </div>
                            <div class="text-[10px] text-stone-400 bg-stone-50 py-2 px-4 rounded-full inline-flex items-center gap-2 border border-stone-100">
                                <span>{{ t('label_wechat_id') }}: <span class="font-mono font-bold select-all text-stone-600">{{ MY_WECHAT_ID }}</span></span>
                                <button @click="copyWeChatIDOnly" class="text-[#07C160] font-bold hover:underline">{{ t('btn_copy') }}</button>
                            </div>
                        </div>
                    </transition>

                    <div class="text-center pt-4 pb-6">
                        <button @click="resetAll" class="text-xs text-stone-400 hover:text-stone-600 flex items-center justify-center gap-1.5 mx-auto px-4 py-2 hover:bg-white hover:shadow-sm rounded-full transition-all">
                            <i class="ph-bold ph-arrow-counter-clockwise leading-none"></i>
                            <span>{{ t('btn_restart') }}</span>
                        </button>
                    </div>

                </div>
            </transition>

        </main>
    </div>
</div>

<script>
    const { createApp, ref, reactive, computed } = Vue;

    // --- 配置 ---
    const MY_WHATSAPP_NUMBER = "8615382537862"; 
    const MY_WECHAT_ID = "Nobebaelaguaporfavor"; 

    // --- I18n ---
    const messages = {
        zh: {
            app_title: "六爻天机",
            tab_liuyao: "六爻占卜",
            tab_bazi: "八字命理",
            liuyao_title: "诚心求占",
            liuyao_subtitle: "I CHING DIVINATION",
            bazi_title: "八字排盘",
            bazi_subtitle: "FOUR PILLARS DESTINY",
            step1_placeholder: "请默念您的问题...\n例如：近期事业发展有无阻碍？",
            btn_start: "开始排盘",
            step1_footer: "• 心诚则灵 • 无事不占 •",
            label_question: "所占之事",
            coin_yang: "字",
            btn_shake: "点击摇卦",
            btn_finish: "查看结果",
            label_void: "空亡",
            label_solar: "公历",
            label_palace: "宫",
            label_main_bg: "本",
            label_shi: "世",
            label_ying: "应",
            label_change_trend: "未来趋势",
            label_change_bg: "变",
            label_no_change: "六爻安静，以本卦断吉凶",
            cta_title: "大师一对一详批",
            cta_desc_1: "天机深奥，需结合流年神煞综合推断。",
            cta_desc_2: "请选择下方任一方式联系大师。",
            btn_wechat: "微信联系",
            label_wechat_id: "微信号",
            btn_copy: "复制",
            btn_restart: "重新起卦",
            toast_copy_success: "信息已复制！正在打开微信...",
            toast_wechat_copy: "微信号已复制！",
            toast_fail: "复制失败",
            msg_intro: "大师您好，我诚心求测。",
            msg_q: "【问题】",
            msg_t: "【时间】",
            msg_g: "【卦象】",
            msg_bazi: "【八字】",
            msg_yun: "【大运流年】",
            msg_end: "请大师详批。",
            label_birth_date: "出生日期 (公历)",
            label_birth_time: "出生时间",
            gender_male: "男",
            gender_female: "女",
            bazi_question_ph: "想问大师关于命运的什么问题？(选填)",
            bazi_male: "乾造",
            bazi_female: "坤造",
            col_year: "年柱", col_month: "月柱", col_day: "日柱", col_hour: "时柱",
            label_5_elements: "五行能量分布",
            wx_wood: "木", wx_fire: "火", wx_earth: "土", wx_metal: "金", wx_water: "水",
            label_luck_cycle: "大运推演",
            label_start_luck: "起运",
            label_age: "岁",
            label_age_short: "岁",
            label_curr_year: "流年",
            label_curr_day: "流日",
            label_analysis_date: "推演日期"
        },
        en: {
            app_title: "Destiny Decoder",
            tab_liuyao: "Divination",
            tab_bazi: "BaZi Destiny",
            liuyao_title: "Ask Oracle",
            liuyao_subtitle: "I CHING DIVINATION",
            bazi_title: "BaZi Chart",
            bazi_subtitle: "FOUR PILLARS DESTINY",
            step1_placeholder: "Meditate on your question...\nEx: Will my career improve soon?",
            btn_start: "Analyze",
            step1_footer: "• Sincerity brings accuracy •",
            label_question: "Question",
            coin_yang: "Head",
            btn_shake: "Shake",
            btn_finish: "Finish",
            label_void: "Void",
            label_solar: "Solar",
            label_palace: " Palace",
            label_main_bg: "Base",
            label_shi: "Self",
            label_ying: "Other",
            label_change_trend: "Future Trend",
            label_change_bg: "Chg",
            label_no_change: "No moving lines.",
            cta_title: "Expert Interpretation",
            cta_desc_1: "Deep insight requires expert analysis.",
            cta_desc_2: "Contact Master for a detailed reading.",
            btn_wechat: "WeChat",
            label_wechat_id: "WeChat ID",
            btn_copy: "Copy",
            btn_restart: "Restart",
            toast_copy_success: "Copied! Opening WeChat...",
            toast_wechat_copy: "ID Copied!",
            toast_fail: "Copy failed",
            msg_intro: "Hello Master, I seek a reading.",
            msg_q: "[Question]",
            msg_t: "[Time]",
            msg_g: "[Hexagram]",
            msg_bazi: "[BaZi Chart]",
            msg_yun: "[Luck Cycles]",
            msg_end: "Please analyze.",
            label_birth_date: "Birth Date (Solar)",
            label_birth_time: "Birth Time",
            gender_male: "Male",
            gender_female: "Female",
            bazi_question_ph: "Specific question? (Optional)",
            bazi_male: "Male",
            bazi_female: "Female",
            col_year: "YEAR", col_month: "MONTH", col_day: "DAY", col_hour: "HOUR",
            label_5_elements: "5 Elements",
            wx_wood: "Wood", wx_fire: "Fire", wx_earth: "Earth", wx_metal: "Metal", wx_water: "Water",
            label_luck_cycle: "Luck Cycles",
            label_start_luck: "Start",
            label_age: "",
            label_age_short: "y.o.",
            label_curr_year: "Year",
            label_curr_day: "Day",
            label_analysis_date: "Analysis Date"
        }
    };

    const terms = {
        zh: {},
        en: {
            '金': 'Metal', '木': 'Wood', '水': 'Water', '火': 'Fire', '土': 'Earth',
            '父母': 'Parent', '兄弟': 'Sibling', '子孙': 'Offspring', '妻财': 'Wealth', '官鬼': 'Official',
            '青龙': 'Dragon', '朱雀': 'Bird', '勾陈': 'Hook', '腾蛇': 'Snake', '白虎': 'Tiger', '玄武': 'Tortoise'
        }
    };

    const TRIGRAMS = { '111': {name:'乾',element:'金'}, '011': {name:'兑',element:'金'}, '101': {name:'离',element:'火'}, '001': {name:'震',element:'木'}, '110': {name:'巽',element:'木'}, '010': {name:'坎',element:'水'}, '100': {name:'艮',element:'土'}, '000': {name:'坤',element:'土'} };
    const PALACES = [['乾为天','天风姤','天山遁','天地否','风地观','山地剥','火地晋','火天大有'],['坎为水','水泽节','水雷屯','水火既济','泽火革','雷火丰','地火明夷','地水师'],['艮为山','山火贲','山天大畜','山泽损','火泽睽','天泽履','风泽中孚','风山渐'],['震为雷','雷地豫','雷水解','雷风恒','地风升','水风井','泽风大过','泽雷随'],['巽为风','风天小畜','风火家人','风雷益','天雷无妄','火雷噬嗑','山雷颐','山风蛊'],['离为火','火山旅','火风鼎','火水未济','山水蒙','风水涣','天水讼','天火同人'],['坤为地','地雷复','地泽临','地天泰','雷天大壮','泽天夬','水天需','水地比'],['兑为泽','泽水困','泽地萃','泽山咸','水山蹇','地山谦','雷山小过','雷泽归妹']];
    const NA_JIA = {'乾':['甲',['子','寅','辰'],'壬',['午','申','戌']],'震':['庚',['子','寅','辰'],'庚',['午','申','戌']],'坎':['戊',['寅','辰','午'],'戊',['申','戌','子']],'艮':['丙',['辰','午','申'],'丙',['戌','子','寅']],'坤':['乙',['未','巳','卯'],'癸',['丑','亥','酉']],'巽':['辛',['丑','亥','酉'],'辛',['未','巳','卯']],'离':['己',['卯','丑','亥'],'己',['酉','未','巳']],'兑':['丁',['巳','卯','丑'],'丁',['亥','酉','未']]};
    const WUXING_MAP = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    const LIU_SHEN_START = {'甲':0,'乙':0,'丙':1,'丁':1,'戊':2,'己':3,'庚':4,'辛':4,'壬':5,'癸':5};
    const LIU_SHEN_ORDER = ['青龙','朱雀','勾陈','腾蛇','白虎','玄武'];

    createApp({
        setup() {
            const currentLang = ref('zh');
            const viewMode = ref('mobile'); // 'mobile' or 'desktop'
            const mode = ref('liuyao');
            const step = ref(1); 
            const question = ref('');
            
            const inputLines = ref([]);
            const isShaking = ref(false);
            const lastCoins = ref([2,2,2]);
            const statusText = ref('');
            const currentChart = ref(null);
            
            const baziInput = reactive({ gender: '1', date: '', time: '' });
            const baziChart = ref(null);
            const analysisDate = ref(new Date().toISOString().split('T')[0]);
            const selectedDaYunIndex = ref(-1);
            
            const lunarInfo = ref({});
            const toast = reactive({ show: false, message: '', type: 'info' });

            const t = (key) => messages[currentLang.value][key] || key;
            const translateTerm = (term) => (currentLang.value === 'zh' ? term : (terms.en[term] || term));

            const toggleLang = () => {
                currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh';
                if(step.value === 2 && mode.value === 'liuyao' && !isShaking.value && inputLines.value.length === 0) {
                    statusText.value = currentLang.value === 'zh' ? '点击按钮摇卦' : 'Tap button to shake';
                }
            };
            
            const toggleViewMode = () => {
                viewMode.value = viewMode.value === 'mobile' ? 'desktop' : 'mobile';
                const msg = viewMode.value === 'mobile' 
                    ? (currentLang.value === 'zh' ? '切换至手机视图' : 'Switched to Mobile View')
                    : (currentLang.value === 'zh' ? '切换至桌面视图' : 'Switched to Desktop View');
                showToast(msg, 'info');
            };

            const switchMode = (m) => {
                mode.value = m;
                step.value = 1;
                question.value = '';
                if(m === 'bazi' && !baziInput.date) {
                    const now = new Date();
                    baziInput.date = now.toISOString().split('T')[0];
                    baziInput.time = now.toTimeString().split(' ')[0].substring(0,5);
                }
            };

            const canProceed = computed(() => {
                if(mode.value === 'liuyao') return question.value.trim().length > 0;
                if(mode.value === 'bazi') return baziInput.date && baziInput.time;
                return false;
            });

            const nextStep = () => {
                if(mode.value === 'liuyao') {
                    if(question.value.trim()) {
                        step.value = 2;
                        statusText.value = currentLang.value === 'zh' ? t('btn_shake') : 'Tap button to shake';
                    }
                } else {
                    calcBaZi();
                    step.value = 3;
                }
            };

            const shake = () => {
                if(isShaking.value || inputLines.value.length >= 6) return;
                isShaking.value = true;
                statusText.value = currentLang.value === 'zh' ? '感应中...' : 'Divining...';
                
                setTimeout(() => {
                    const coins = [0,0,0].map(() => Math.random() > 0.5 ? 2 : 3);
                    const sum = coins.reduce((a,b)=>a+b, 0);
                    lastCoins.value = coins;
                    inputLines.value.push(sum);
                    
                    let txt = '';
                    if(sum===6) txt = currentLang.value==='zh' ? "老阴 X" : "Old Yin X"; 
                    if(sum===7) txt = currentLang.value==='zh' ? "少阳 |" : "Young Yang |";
                    if(sum===8) txt = currentLang.value==='zh' ? "少阴 ||" : "Young Yin ||"; 
                    if(sum===9) txt = currentLang.value==='zh' ? "老阳 O" : "Old Yang O";
                    
                    statusText.value = `${currentLang.value==='zh'?'第':'Line'} ${inputLines.value.length} ${currentLang.value==='zh'?'爻':''}: ${txt}`;
                    isShaking.value = false;

                    if(inputLines.value.length === 6) {
                        setTimeout(() => {
                            generateLiuYaoChart();
                            step.value = 3;
                        }, 600);
                    }
                }, 800);
            };

            const generateLiuYaoChart = () => {
                const now = new Date();
                const lunar = Lunar.fromDate(now);
                lunarInfo.value = {
                    dateStr: `${lunar.getYearInGanZhi()}年 ${lunar.getMonthInGanZhi()}月 ${lunar.getDayInGanZhi()}日 ${lunar.getTimeInGanZhi()}时`,
                    kongWang: lunar.getDayXunKong(),
                    solarTime: formatDate(now)
                };
                
                const mainBits = [], changedBits = [], movingLines = [];
                inputLines.value.forEach((val, idx) => {
                    if (val === 6) { mainBits.push(0); changedBits.push(1); movingLines.push(idx); }
                    else if (val === 7) { mainBits.push(1); changedBits.push(1); }
                    else if (val === 8) { mainBits.push(0); changedBits.push(0); }
                    else if (val === 9) { mainBits.push(1); changedBits.push(0); movingLines.push(idx); }
                });
                const mainInfo = identifyHexagram(mainBits);
                const changedInfo = identifyHexagram(changedBits);
                const mainDetails = mountHexagram(mainBits, mainInfo, movingLines, true);
                const changedDetails = mountHexagram(changedBits, changedInfo, movingLines, false, mainInfo.element);
                const dayStem = lunar.getDayInGanZhi().substring(0,1);
                const startIdx = LIU_SHEN_START[dayStem] || 0;
                mainDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                changedDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                currentChart.value = {
                    main: { name: mainInfo.fullName, palace: mainInfo.palace, element: mainInfo.element, lines: [...mainDetails.lines].reverse() },
                    changed: { name: changedInfo.fullName, lines: [...changedDetails.lines].reverse() },
                    hasChange: movingLines.length > 0
                };
            };

            const calcBaZi = () => {
                analysisDate.value = new Date().toISOString().split('T')[0];
                const dateParts = baziInput.date.split('-');
                if (dateParts.length !== 3) return;
                const timeParts = baziInput.time.split(':');
                if (timeParts.length !== 2) return;

                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);
                const h = parseInt(timeParts[0]);
                const min = parseInt(timeParts[1]);

                const solar = Solar.fromYmdHms(y, m, d, h, min, 0);
                const lunar = solar.getLunar();
                const eightChar = lunar.getEightChar();
                
                const wuxingCount = { 'gold':0, 'wood':0, 'water':0, 'fire':0, 'earth':0 };
                const pillars = [
                    {s: eightChar.getYearGan(), b: eightChar.getYearZhi()},
                    {s: eightChar.getMonthGan(), b: eightChar.getMonthZhi()},
                    {s: eightChar.getDayGan(), b: eightChar.getDayZhi()},
                    {s: eightChar.getTimeGan(), b: eightChar.getTimeZhi()}
                ];
                
                const getWx = (char) => {
                    if("甲乙寅卯".includes(char)) return 'wood';
                    if("丙丁巳午".includes(char)) return 'fire';
                    if("戊己辰戌丑未".includes(char)) return 'earth';
                    if("庚辛申酉".includes(char)) return 'metal';
                    if("壬癸亥子".includes(char)) return 'water';
                    return 'earth';
                };

                const processedPillars = pillars.map(p => {
                    const sWx = getWx(p.s);
                    const bWx = getWx(p.b);
                    wuxingCount[sWx === 'metal' ? 'gold' : sWx]++; 
                    return { stem: p.s, branch: p.b, stemWx: sWx, branchWx: bWx };
                });
                
                const counts = { 'wood':0, 'fire':0, 'earth':0, 'metal':0, 'water':0 };
                processedPillars.forEach(p => { counts[p.stemWx]++; counts[p.branchWx]++; });

                const gender = parseInt(baziInput.gender); 
                const yun = eightChar.getYun(gender);
                const daYunArr = yun.getDaYun();
                const startAge = (daYunArr && daYunArr.length > 0) ? daYunArr[0].getStartAge() : 0;
                
                const currentAge = new Date().getFullYear() - y + 1; 

                const processedDaYun = daYunArr.slice(0, 8).map(dy => {
                    const age = dy.getStartAge();
                    const isActive = currentAge >= age && currentAge < (age + 10);
                    return { ganZhi: dy.getGanZhi(), startAge: age, isCurrent: isActive };
                });

                const currentIdx = processedDaYun.findIndex(d => d.isCurrent);
                selectedDaYunIndex.value = currentIdx !== -1 ? currentIdx : 0;

                baziChart.value = {
                    gender: baziInput.gender,
                    solarDate: `${y}-${m}-${d} ${h}:${min}`,
                    pillars: processedPillars,
                    wuxingCount: counts,
                    startAge: startAge,
                    dayun: processedDaYun,
                    currentAge: currentAge,
                    currentLiuNian: '',
                    currentLiuRi: ''
                };
                updateAnalysis();
            };

            const updateAnalysis = () => {
                if(!baziChart.value) return;
                const dateParts = analysisDate.value.split('-');
                if (dateParts.length !== 3) return;
                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);
                const solar = Solar.fromYmd(y, m, d);
                const lunar = solar.getLunar();
                baziChart.value.currentLiuNian = lunar.getYearInGanZhi() + (currentLang.value==='zh'?'年':'');
                baziChart.value.currentLiuRi = lunar.getDayInGanZhi() + (currentLang.value==='zh'?'日':'');
            };

            const selectDaYun = (index) => { selectedDaYunIndex.value = index; };

            const formatDate = (date) => date.toLocaleString('zh-CN', {hour12:false});
            const getWuXingColor = (wx) => `wx-${wx}`;
            const getWuXingHex = (wx) => {
                const map = { wood:'#2d6a4f', fire:'#d63031', earth:'#a0522d', metal:'#636e72', water:'#0984e3' };
                return map[wx];
            };

            const getCopyText = () => {
                if(mode.value === 'liuyao') return getLiuYaoText();
                return getBaZiText();
            };

            const getLiuYaoText = () => {
                const c = currentChart.value;
                const isZh = currentLang.value === 'zh';
                const changeText = c.hasChange ? ` -> ${c.changed.name}` : '';
                let linesText = '';
                c.main.lines.forEach(line => {
                    const lineSymbol = line.isYang ? "====== " : "==  == ";
                    const movingMark = line.isMoving ? (line.isYang ? "O" : "X") : " "; 
                    const shiYing = line.shi ? (isZh?"(世)":"(Self)") : (line.ying ? (isZh?"(应)":"(Other)") : "    ");
                    linesText += `${lineSymbol}${movingMark} ${translateTerm(line.beast)} ${translateTerm(line.relation)} ${line.branch}${translateTerm(line.wuxing)} ${shiYing}\n`;
                });
                return `${t('msg_intro')}
${t('msg_q')} ${question.value}
${t('msg_t')} ${lunarInfo.value.dateStr}
${t('msg_g')} ${c.main.name} ${changeText}
------------------------
${linesText}------------------------
${t('msg_end')}`;
            };

            const getBaZiText = () => {
                const c = baziChart.value;
                const gender = c.gender === '1' ? t('bazi_male') : t('bazi_female');
                const p = c.pillars;
                const qText = question.value ? `\n${t('msg_q')} ${question.value}` : '';
                const selDy = c.dayun[selectedDaYunIndex.value];
                const dyText = selDy ? `${selDy.ganZhi} (${selDy.startAge}${t('label_age_short')})` : 'N/A';

                return `${t('msg_intro')}
${t('label_birth_date')}: ${c.solarDate}
${gender} (${c.currentAge}${t('label_age_short')})
${qText}

${t('msg_bazi')}
${t('col_year')}  ${t('col_month')}  ${t('col_day')}  ${t('col_hour')}
${p[0].stem}${p[0].branch}  ${p[1].stem}${p[1].branch}  ${p[2].stem}${p[2].branch}  ${p[3].stem}${p[3].branch}

${t('msg_yun')}
Focus: ${dyText}
${t('label_analysis_date')}: ${analysisDate.value}
${t('label_curr_year')}: ${c.currentLiuNian}
${t('label_curr_day')}: ${c.currentLiuRi}

${t('label_5_elements')}: 
${t('wx_metal')}:${c.wuxingCount.metal} ${t('wx_wood')}:${c.wuxingCount.wood} ${t('wx_water')}:${c.wuxingCount.water} ${t('wx_fire')}:${c.wuxingCount.fire} ${t('wx_earth')}:${c.wuxingCount.earth}

${t('msg_end')}`;
            };

            const contactWhatsApp = () => {
                const url = `https://wa.me/${MY_WHATSAPP_NUMBER}?text=${encodeURIComponent(getCopyText())}`;
                window.open(url, '_blank');
            };

            const contactWeChat = async () => {
                const text = getCopyText();
                copyToClipboard(text).then(() => {
                    showToast(t('toast_copy_success'), 'success');
                    setTimeout(() => window.location.href = 'weixin://', 1200);
                }).catch(() => showToast(t('toast_fail'), 'error'));
            };
            
            const copyToClipboard = (text) => {
                return new Promise((resolve, reject) => {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(resolve).catch(() => fallbackCopy(text, resolve, reject));
                    } else fallbackCopy(text, resolve, reject);
                });
            };
            const fallbackCopy = (text, resolve, reject) => {
                try {
                    const ta = document.createElement("textarea");
                    ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
                    document.body.appendChild(ta); ta.focus(); ta.select();
                    const s = document.execCommand('copy'); document.body.removeChild(ta);
                    if(s) resolve(); else reject();
                } catch(e) { reject(e); }
            };
            const copyWeChatIDOnly = () => {
                copyToClipboard(MY_WECHAT_ID).then(() => showToast(t('toast_wechat_copy'), 'success')).catch(() => showToast(t('toast_fail'), 'error'));
            };
            const showToast = (msg, type='info') => {
                toast.message = msg; toast.type = type; toast.show = true;
                setTimeout(() => toast.show = false, 3000);
            };
            const resetAll = () => {
                step.value = 1; inputLines.value = []; question.value = ''; statusText.value = '';
            };

            const identifyHexagram=(bits)=>{const lKey=''+bits[2]+bits[1]+bits[0],uKey=''+bits[5]+bits[4]+bits[3];const tian=bits[5]===bits[2],ren=bits[4]===bits[1],di=bits[3]===bits[0];let shi=0,pName='',isYou=false,isGui=false;const uName=TRIGRAMS[uKey].name,lName=TRIGRAMS[lKey].name;const inv=(k)=>k.split('').map(x=>x==='1'?'0':'1').join('');if(tian&&ren&&di){shi=6;pName=uName;}else if(tian&&ren&&!di){shi=1;pName=uName;}else if(tian&&!ren&&!di){shi=2;pName=uName;}else if(!tian&&!ren&&!di){shi=3;pName=uName;}else if(!tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;}else if(!tian&&ren&&di){shi=5;pName=TRIGRAMS[inv(lKey)].name;}else if(tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;isYou=true;}else if(!tian&&ren&&!di){shi=3;pName=lName;isGui=true;}const pEl=NA_JIA[pName]?TRIGRAMS[Object.keys(TRIGRAMS).find(k=>TRIGRAMS[k].name===pName)].element:'金';let oIdx=0;if(shi===6)oIdx=0;else if(shi===1)oIdx=1;else if(shi===2)oIdx=2;else if(shi===3&&!isGui)oIdx=3;else if(shi===4&&!isYou)oIdx=4;else if(shi===5)oIdx=5;else if(isYou)oIdx=6;else if(isGui)oIdx=7;let pIndex=['乾','坎','艮','震','巽','离','坤','兑'].indexOf(pName);if(pIndex===-1)pIndex=0;return{fullName:PALACES[pIndex][oIdx],palace:pName,palaceIndex:pIndex,element:pEl,shiIndex:shi-1,yingIndex:(shi-1+3)%6};};
            const mountHexagram=(bits,info,mov,isM,overrideEl)=>{const lName=TRIGRAMS[''+bits[2]+bits[1]+bits[0]].name,uName=TRIGRAMS[''+bits[5]+bits[4]+bits[3]].name;const lines=[],pEl=overrideEl||info.element;for(let i=0;i<6;i++){const isY=bits[i]===1,rule=i<3?NA_JIA[lName]:NA_JIA[uName];const st=i<3?rule[0]:rule[2],br=i<3?rule[1][i]:rule[3][i-3];const wx=WUXING_MAP[br],rel=getLiuQin(pEl,wx);lines.push({index:i,isYang:isY,stem:st,branch:br,wuxing:wx,relation:rel,shi:isM&&i===info.shiIndex,ying:isM&&i===info.yingIndex,isMoving:isM&&mov.includes(i),isMovingOrigin:!isM&&mov.includes(i)});}return{lines};};
            const getLiuQin=(p,l)=>{const gens={'木':'火','火':'土','土':'金','金':'水','水':'木'},cons={'木':'土','土':'水','水':'火','火':'金','金':'木'};if(p===l)return'兄弟';if(gens[l]===p)return'父母';if(gens[p]===l)return'子孙';if(cons[l]===p)return'官鬼';if(cons[p]===l)return'妻财';return'未知';};
            const getRelationClass = (r) => { if(r==='官鬼') return 'text-purple-700'; if(r==='妻财') return 'text-green-700'; if(r==='子孙') return 'text-blue-700'; if(r==='兄弟') return 'text-orange-700'; return 'text-stone-600'; };

            return { 
                mode, step, question, inputLines, isShaking, lastCoins, statusText, currentChart, lunarInfo, 
                baziInput, baziChart, analysisDate, selectedDaYunIndex, toast, viewMode, currentLang,
                t, toggleLang, toggleViewMode, switchMode, nextStep, shake, resetAll, contactWhatsApp, contactWeChat, copyWeChatIDOnly, getRelationClass, translateTerm, getWuXingColor, getWuXingHex, canProceed, MY_WECHAT_ID,
                updateAnalysis, selectDaYun
            };
        }
    }).mount('#app');
</script>
</body>
</html>
