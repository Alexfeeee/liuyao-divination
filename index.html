<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>六爻天机 - 真人大师亲算</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lunar Javascript -->
    <script src="https://unpkg.com/lunar-javascript@1.6.12/lunar.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Ma+Shan+Zheng&display=swap');
        
        :root {
            --paper-bg: #f7f5f0;
            --ink-color: #2c2c2c;
            --cinnabar: #a93226;
            --whatsapp-green: #25D366;
            --wechat-green: #07C160;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--paper-bg);
            color: var(--ink-color);
            background-image: 
                radial-gradient(#e3e0d8 1px, transparent 1px),
                linear-gradient(to bottom, #fcfbf9, #f0eee9);
            background-size: 20px 20px, 100% 100%;
        }

        /* 隐藏滚动条 */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* 卦爻样式 */
        .ink-stroke { border-radius: 2px; }
        .yang-stroke { 
            height: 12px; width: 100%; 
            background: linear-gradient(90deg, #c0392b, #a93226, #c0392b);
            box-shadow: 0 1px 2px rgba(169, 50, 38, 0.2);
            border-radius: 3px;
        }
        .yin-stroke-wrapper { display: flex; justify-content: space-between; width: 100%; }
        .yin-stroke { 
            height: 12px; width: 44%; 
            background: linear-gradient(90deg, #424949, #2c3e50, #424949);
            box-shadow: 0 1px 2px rgba(44, 62, 80, 0.2);
            border-radius: 3px;
        }

        /* 铜钱动画 */
        .coin {
            width: 70px; height: 70px; border-radius: 50%;
            background: conic-gradient(from 45deg, #f1c40f, #f9e79f, #b7950b, #f1c40f);
            box-shadow: inset 0 0 0 4px #d4ac0d, inset 2px 2px 5px rgba(255,255,255,0.4), 2px 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: #7d6608;
            position: relative;
        }
        .coin::after {
            content: ''; width: 24px; height: 24px;
            background-color: #f0eee9; border: 2px solid #b7950b;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); position: absolute; z-index: 1;
        }
        .coin-text { position: absolute; z-index: 2; font-family: 'Ma Shan Zheng', cursive; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }

        @keyframes toss {
            0% { transform: translateY(0) rotateX(0) scale(1); }
            50% { transform: translateY(-120px) rotateX(720deg) scale(1.1); }
            100% { transform: translateY(0) rotateX(1440deg) scale(1); }
        }
        .animate-toss { animation: toss 0.8s cubic-bezier(0.45, 0.05, 0.55, 0.95); }

        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(169, 50, 38, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(169, 50, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(169, 50, 38, 0); }
        }
        .btn-shake { animation: pulse-shadow 2s infinite; }

        /* 动效类 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.4s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active { transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .slide-up-enter-from { opacity: 0; transform: translateY(30px); }
        .slide-up-enter-to { opacity: 1; transform: translateY(0); }

        /* 卡片玻璃态 */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px -8px rgba(0,0,0,0.05);
        }

        /* Toast 提示 */
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { transform: translateY(-100%); opacity: 0; }
        .toast-enter-to, .toast-leave-from { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex flex-col text-stone-800">

<div id="app" class="w-full h-full flex flex-col relative max-w-md mx-auto shadow-2xl bg-white/30">

    <!-- 全局 Toast 提示 -->
    <transition name="toast">
        <div v-if="toast.show" class="absolute top-0 left-0 right-0 z-50 p-4 flex justify-center">
            <div class="bg-stone-800 text-white px-4 py-2 rounded-full shadow-lg text-sm flex items-center gap-2">
                <i v-if="toast.type === 'success'" class="ph ph-check-circle text-green-400"></i>
                <i v-else class="ph ph-info text-blue-400"></i>
                <span>{{ toast.message }}</span>
            </div>
        </div>
    </transition>

    <!-- Header -->
    <header class="h-14 flex items-center justify-center px-4 shrink-0 z-10 pt-2 bg-white/40 backdrop-blur-sm border-b border-stone-200/50">
        <div class="flex flex-col items-center">
            <h1 class="font-serif font-bold text-lg tracking-[0.3em] text-[#a93226]" style="font-family: 'Ma Shan Zheng', cursive;">六爻天机</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden p-6 relative" ref="scrollContainer">
        
        <!-- Phase 1: 输入问题 -->
        <transition name="fade" mode="out-in">
            <div v-if="step === 1" key="step1" class="h-full flex flex-col pt-6">
                <div class="text-center space-y-3 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-stone-100 to-white shadow-inner border border-stone-200 mb-2">
                        <i class="ph ph-hands-praying text-3xl text-stone-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-stone-800 tracking-wide">诚心求占</h2>
                    <p class="text-stone-500 text-xs tracking-widest uppercase">DIVINATION</p>
                </div>

                <div class="w-full space-y-6 flex-1">
                    <div class="relative group">
                        <textarea v-model="question" rows="4" placeholder="请默念您的问题...&#10;例如：近期事业发展有无阻碍？" 
                            class="w-full p-5 bg-white/80 border border-stone-200 rounded-2xl focus:outline-none focus:border-[#a93226] focus:ring-4 focus:ring-[#a93226]/10 transition resize-none shadow-sm text-stone-700 text-lg leading-relaxed placeholder-stone-400"></textarea>
                    </div>
                    
                    <button @click="nextStep" :disabled="!question.trim()"
                        class="w-full py-4 bg-[#2c2c2c] text-[#f7f5f0] rounded-xl font-bold text-lg shadow-xl hover:bg-black hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                        <span>开始起卦</span>
                        <i class="ph ph-arrow-right"></i>
                    </button>
                    
                    <div class="text-center mt-4">
                         <p class="text-[10px] text-stone-400">* 心诚则灵，无事不占</p>
                    </div>
                </div>
            </div>

            <!-- Phase 2: 摇卦 -->
            <div v-else-if="step === 2" key="step2" class="h-full flex flex-col">
                <div class="text-center mb-8 animate-fade-in">
                    <div class="text-[10px] text-stone-400 uppercase tracking-widest mb-2">QUESTION</div>
                    <div class="font-serif font-bold text-lg text-stone-800 px-4 leading-relaxed line-clamp-2">{{ question }}</div>
                    <div class="w-12 h-px bg-stone-200 mx-auto mt-4"></div>
                </div>

                <div class="flex-1 flex flex-col justify-center items-center space-y-12 -mt-10">
                    <div class="h-24 flex items-center justify-center gap-6 perspective-1000 w-full">
                        <div v-for="c in 3" :key="c" class="coin transform transition-all" :class="{'animate-toss': isShaking}">
                            <div class="coin-text" :class="lastCoins[c-1] === 3 ? 'top-[42%] left-[45%]' : 'top-[10%] left-[30%]'">
                                <span v-if="!isShaking && lastCoins[c-1] === 2" class="text-sm scale-90 block">字</span>
                                <i v-if="!isShaking && lastCoins[c-1] === 3" class="ph ph-flower-lotus text-xs opacity-60"></i>
                            </div>
                        </div>
                    </div>

                    <div class="text-center space-y-8">
                        <div class="relative inline-block">
                             <button @click="shake" :disabled="isShaking"
                                class="w-28 h-28 rounded-full bg-[#a93226] text-[#f7f5f0] font-bold text-xl shadow-2xl active:scale-95 transition-all flex flex-col items-center justify-center gap-1 z-10 relative overflow-hidden group"
                                :class="{'btn-shake': !isShaking && inputLines.length < 6}">
                                <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <i class="ph ph-hand-waving text-3xl mb-1 group-hover:rotate-12 transition-transform"></i>
                                <span class="text-sm font-medium tracking-widest">{{ inputLines.length < 6 ? '摇卦' : '完成' }}</span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div class="font-mono text-[#a93226] font-bold h-6 text-sm tracking-wider">{{ statusText }}</div>
                            <div class="flex justify-center gap-1.5">
                                <div v-for="i in 6" :key="i" class="w-1.5 h-1.5 rounded-full transition-all duration-500"
                                        :class="inputLines.length >= i ? 'bg-[#a93226] scale-110' : 'bg-stone-300 scale-90'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phase 3: 结果展示 -->
            <div v-else-if="step === 3" key="step3" class="space-y-6 pb-20">
                
                <div class="flex flex-col items-center justify-center pt-2">
                    <div class="text-sm text-stone-600 font-bold font-mono tracking-wide">{{ lunarInfo.dateStr }}</div>
                    <div class="text-[10px] text-stone-400 font-mono mt-1">空亡: {{ lunarInfo.kongWang }} | 公历: {{ lunarInfo.solarTime }}</div>
                </div>

                <!-- 1. 本卦卡片 -->
                <transition appear name="slide-up">
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-1 bg-[#a93226]/20"></div>
                        
                        <div class="flex justify-between items-start mb-6 border-b border-stone-200/60 pb-3">
                            <div>
                                <span class="text-[10px] text-stone-400 block mb-1 uppercase tracking-wider">Present</span>
                                <h3 class="text-2xl font-bold text-[#a93226]">{{ currentChart.main.name }}</h3>
                                <span class="text-xs text-stone-500 bg-stone-100/50 px-2 py-0.5 rounded-full mt-1 inline-block">{{ currentChart.main.palace }}宫 · {{ currentChart.main.element }}</span>
                            </div>
                            <div class="text-4xl text-stone-100 font-serif absolute right-4 top-2 select-none" style="font-family: 'Ma Shan Zheng'">本</div>
                        </div>

                        <div class="space-y-2.5 relative z-10">
                            <div v-for="line in currentChart.main.lines" :key="'main-'+line.index" class="flex items-center text-sm h-8 group">
                                <div class="w-8 text-stone-400 text-[11px] text-center scale-90">{{ line.beast }}</div>
                                <div class="w-10 font-bold text-xs text-center" :class="getRelationClass(line.relation)">{{ line.relation }}</div>
                                <div class="w-14 font-mono text-[10px] text-stone-500 scale-90 origin-center text-center">{{ line.stem }}{{ line.branch }}{{ line.wuxing }}</div>
                                <div class="flex-1 px-3 flex items-center">
                                    <div v-if="line.isYang" class="yang-stroke relative transition-all group-hover:brightness-110">
                                        <div v-if="line.isMoving" class="absolute -right-1.5 -top-1 w-2 h-2 rounded-full bg-[#a93226] animate-pulse"></div>
                                    </div>
                                    <div v-else class="yin-stroke-wrapper relative transition-all group-hover:brightness-110">
                                        <div class="yin-stroke"></div>
                                        <div class="yin-stroke"></div>
                                        <div v-if="line.isMoving" class="absolute left-1/2 -translate-x-1/2 -top-1 w-2 h-2 rounded-full bg-[#a93226] animate-pulse"></div>
                                    </div>
                                </div>
                                <div class="w-6 text-[10px] font-bold text-center">
                                    <span v-if="line.shi" class="text-white bg-[#a93226] px-1 rounded shadow-sm">世</span>
                                    <span v-if="line.ying" class="text-[#a93226] border border-[#a93226] px-0.5 rounded">应</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- 变卦指示器 -->
                <div v-if="currentChart.hasChange" class="flex justify-center -my-2 relative z-10 opacity-60">
                    <i class="ph ph-arrow-down text-2xl text-stone-400 animate-bounce"></i>
                </div>

                <!-- 2. 变卦卡片 -->
                <transition appear name="slide-up" v-if="currentChart.hasChange">
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden bg-[#fbfdfc]/90">
                        <div class="absolute right-0 top-0 bottom-0 w-1 bg-stone-400/20"></div>

                        <div class="flex justify-between items-start mb-6 border-b border-stone-200/60 pb-3">
                            <div>
                                <span class="text-[10px] text-stone-400 block mb-1 uppercase tracking-wider">Future</span>
                                <h3 class="text-2xl font-bold text-stone-700">{{ currentChart.changed.name }}</h3>
                                <span class="text-xs text-stone-500 bg-stone-100/50 px-2 py-0.5 rounded-full mt-1 inline-block">变卦 · 趋势</span>
                            </div>
                            <div class="text-4xl text-stone-100 font-serif absolute right-4 top-2 select-none" style="font-family: 'Ma Shan Zheng'">变</div>
                        </div>

                        <div class="space-y-2.5 relative z-10">
                            <div v-for="line in currentChart.changed.lines" :key="'changed-'+line.index" class="flex items-center text-sm h-8 opacity-90 group">
                                <div class="w-8 text-stone-400 text-[11px] text-center scale-90">{{ line.beast }}</div>
                                <div class="w-10 font-bold text-xs text-center" :class="getRelationClass(line.relation)">{{ line.relation }}</div>
                                <div class="w-14 font-mono text-[10px] text-stone-500 scale-90 origin-center text-center">{{ line.stem }}{{ line.branch }}{{ line.wuxing }}</div>
                                <div class="flex-1 px-3 flex items-center">
                                    <div v-if="line.isYang" class="yang-stroke bg-stone-500 !bg-none !box-shadow-none bg-stone-600"></div>
                                    <div v-else class="yin-stroke-wrapper">
                                        <div class="yin-stroke bg-stone-500 !bg-none !box-shadow-none bg-stone-600"></div>
                                        <div class="yin-stroke bg-stone-500 !bg-none !box-shadow-none bg-stone-600"></div>
                                    </div>
                                </div>
                                <div class="w-6 text-[10px] text-center"></div>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- 无变卦 -->
                <div v-else class="text-center py-4 opacity-50">
                    <span class="text-xs text-stone-400 border border-stone-200 px-3 py-1 rounded-full">六爻安静，以本卦断吉凶</span>
                </div>

                <!-- 邀请函 (双通道引流) -->
                <transition appear name="slide-up">
                    <div class="bg-gradient-to-b from-[#f0fdf4] to-[#dcfce7] border border-[#bbf7d0] rounded-2xl p-6 text-center space-y-5 shadow-lg relative overflow-hidden mt-4">
                        <div class="relative z-10">
                            <h3 class="text-lg font-bold text-[#14532d] mb-2 flex items-center justify-center gap-2">
                                <i class="ph ph-chat-circle-dots text-xl"></i>
                                <span>大师详批通道</span>
                            </h3>
                            <p class="text-xs text-[#166534] leading-relaxed opacity-90 px-2 mb-4">
                                天机深奥，需结合流年神煞。<br>
                                请选择下方任一方式联系大师。
                            </p>

                            <!-- 按钮组 -->
                            <div class="grid grid-cols-2 gap-3">
                                <!-- WhatsApp -->
                                <button @click="contactWhatsApp"
                                    class="relative w-full py-3 bg-[#25D366] hover:bg-[#128C7E] text-white rounded-xl font-bold text-sm shadow-md active:translate-y-0.5 transition-all flex flex-col items-center justify-center gap-1">
                                    <i class="ph ph-whatsapp-logo text-2xl"></i>
                                    <span>WhatsApp</span>
                                </button>

                                <!-- WeChat -->
                                <button @click="contactWeChat"
                                    class="relative w-full py-3 bg-[#07C160] hover:bg-[#06ad56] text-white rounded-xl font-bold text-sm shadow-md active:translate-y-0.5 transition-all flex flex-col items-center justify-center gap-1">
                                    <i class="ph ph-wechat-logo text-2xl"></i>
                                    <span>微信联系</span>
                                </button>
                            </div>
                            
                            <!-- 微信辅助信息 -->
                            <div class="text-[10px] text-[#166534] mt-3 bg-white/40 rounded-lg p-2 inline-block">
                                大师微信号: <span class="font-mono font-bold select-all">{{ MY_WECHAT_ID }}</span>
                                <span @click="copyWeChatIDOnly" class="ml-2 underline cursor-pointer text-[#07C160]">复制</span>
                            </div>
                        </div>
                    </div>
                </transition>

                <div class="text-center pt-2 pb-6">
                    <button @click="resetAll" class="text-xs text-stone-400 hover:text-stone-600 flex items-center justify-center gap-1.5 mx-auto px-4 py-2 hover:bg-stone-100 rounded-full transition-colors">
                        <i class="ph ph-arrow-counter-clockwise"></i>
                        <span>重新起卦</span>
                    </button>
                </div>

            </div>
        </transition>

    </main>
</div>

<script>
    const { createApp, ref, reactive } = Vue;

    // --- ⬇️ 请配置联系方式 ⬇️ ---
    const MY_WHATSAPP_NUMBER = "8615382537862"; 
    const MY_WECHAT_ID = "Nobebaelaguaporfavor"; // 请替换为您的微信号
    // --------------------------

    // Constants
    const TRIGRAMS = { '111': {name:'乾',element:'金'}, '011': {name:'兑',element:'金'}, '101': {name:'离',element:'火'}, '001': {name:'震',element:'木'}, '110': {name:'巽',element:'木'}, '010': {name:'坎',element:'水'}, '100': {name:'艮',element:'土'}, '000': {name:'坤',element:'土'} };
    const PALACES = [['乾为天','天风姤','天山遁','天地否','风地观','山地剥','火地晋','火天大有'],['坎为水','水泽节','水雷屯','水火既济','泽火革','雷火丰','地火明夷','地水师'],['艮为山','山火贲','山天大畜','山泽损','火泽睽','天泽履','风泽中孚','风山渐'],['震为雷','雷地豫','雷水解','雷风恒','地风升','水风井','泽风大过','泽雷随'],['巽为风','风天小畜','风火家人','风雷益','天雷无妄','火雷噬嗑','山雷颐','山风蛊'],['离为火','火山旅','火风鼎','火水未济','山水蒙','风水涣','天水讼','天火同人'],['坤为地','地雷复','地泽临','地天泰','雷天大壮','泽天夬','水天需','水地比'],['兑为泽','泽水困','泽地萃','泽山咸','水山蹇','地山谦','雷山小过','雷泽归妹']];
    const NA_JIA = {'乾':['甲',['子','寅','辰'],'壬',['午','申','戌']],'震':['庚',['子','寅','辰'],'庚',['午','申','戌']],'坎':['戊',['寅','辰','午'],'戊',['申','戌','子']],'艮':['丙',['辰','午','申'],'丙',['戌','子','寅']],'坤':['乙',['未','巳','卯'],'癸',['丑','亥','酉']],'巽':['辛',['丑','亥','酉'],'辛',['未','巳','卯']],'离':['己',['卯','丑','亥'],'己',['酉','未','巳']],'兑':['丁',['巳','卯','丑'],'丁',['亥','酉','未']]};
    const WUXING_MAP = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    const LIU_SHEN_START = {'甲':0,'乙':0,'丙':1,'丁':1,'戊':2,'己':3,'庚':4,'辛':4,'壬':5,'癸':5};
    const LIU_SHEN_ORDER = ['青龙','朱雀','勾陈','腾蛇','白虎','玄武'];

    createApp({
        setup() {
            const step = ref(1); 
            const question = ref('');
            const inputLines = ref([]);
            const isShaking = ref(false);
            const lastCoins = ref([2,2,2]);
            const statusText = ref('点击按钮摇卦');
            const currentChart = ref(null);
            const lunarInfo = ref({});
            const toast = reactive({ show: false, message: '', type: 'info' });

            const showToast = (msg, type='info') => {
                toast.message = msg;
                toast.type = type;
                toast.show = true;
                setTimeout(() => toast.show = false, 3000);
            };

            const nextStep = () => { if(question.value.trim()) step.value = 2; };

            const shake = () => {
                if(isShaking.value || inputLines.value.length >= 6) return;
                isShaking.value = true;
                statusText.value = '感应中...';
                
                setTimeout(() => {
                    const coins = [0,0,0].map(() => Math.random() > 0.5 ? 2 : 3);
                    const sum = coins.reduce((a,b)=>a+b, 0);
                    lastCoins.value = coins;
                    inputLines.value.push(sum);
                    
                    let txt = '';
                    if(sum===6) txt="老阴 X"; if(sum===7) txt="少阳 |";
                    if(sum===8) txt="少阴 ||"; if(sum===9) txt="老阳 O";
                    statusText.value = `第 ${inputLines.value.length} 爻: ${txt}`;
                    isShaking.value = false;

                    if(inputLines.value.length === 6) {
                        setTimeout(() => {
                            generateChart();
                            step.value = 3;
                        }, 600);
                    }
                }, 800);
            };

            const generateChart = () => {
                const now = new Date();
                const lunar = Lunar.fromDate(now);
                
                // 更精确的时间计算 (增加时柱)
                lunarInfo.value = {
                    dateStr: `${lunar.getYearInGanZhi()}年 ${lunar.getMonthInGanZhi()}月 ${lunar.getDayInGanZhi()}日 ${lunar.getTimeInGanZhi()}时`,
                    kongWang: lunar.getDayXunKong(),
                    solarTime: `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`
                };

                const mainBits = [], changedBits = [], movingLines = [];
                inputLines.value.forEach((val, idx) => {
                    if (val === 6) { mainBits.push(0); changedBits.push(1); movingLines.push(idx); }
                    else if (val === 7) { mainBits.push(1); changedBits.push(1); }
                    else if (val === 8) { mainBits.push(0); changedBits.push(0); }
                    else if (val === 9) { mainBits.push(1); changedBits.push(0); movingLines.push(idx); }
                });

                const mainInfo = identifyHexagram(mainBits);
                const changedInfo = identifyHexagram(changedBits);
                
                const mainDetails = mountHexagram(mainBits, mainInfo, movingLines, true);
                const changedDetails = mountHexagram(changedBits, changedInfo, movingLines, false, mainInfo.element);
                
                const dayStem = lunar.getDayInGanZhi().substring(0,1);
                const startIdx = LIU_SHEN_START[dayStem] || 0;
                
                mainDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                changedDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);

                currentChart.value = {
                    main: { name: mainInfo.fullName, palace: mainInfo.palace, element: mainInfo.element, lines: [...mainDetails.lines].reverse() },
                    changed: { name: changedInfo.fullName, lines: [...changedDetails.lines].reverse() },
                    hasChange: movingLines.length > 0
                };
            };

            // 生成卦象字符画文本
            const getChartText = () => {
                const c = currentChart.value;
                const changeText = c.hasChange ? `之 ${c.changed.name}` : '(无变卦)';
                
                let linesText = '';
                c.main.lines.forEach(line => {
                    // 构建卦画符号
                    // 阴爻: ==  == (U+268B ⚋ 看起来太小，用ASCII模拟更通用)
                    // 阳爻: ====== 
                    const lineSymbol = line.isYang ? "====== " : "==  == ";
                    const movingMark = line.isMoving ? (line.isYang ? "O" : "X") : " "; // 动爻标记
                    const shiYing = line.shi ? "(世)" : (line.ying ? "(应)" : "    ");
                    
                    linesText += `${lineSymbol}${movingMark} ${line.beast} ${line.relation} ${line.branch}${line.wuxing} ${shiYing}\n`;
                });

                return `大师您好，我诚心求测。

【问题】
${question.value}

【时间】
${lunarInfo.value.dateStr} (空亡: ${lunarInfo.value.kongWang})
(公历: ${lunarInfo.value.solarTime})

【卦象】
本卦：${c.main.name} (${c.main.palace}${c.main.element})
------------------------
${linesText}------------------------
变卦：${c.changed.name}

请大师详批。`;
            };

            // 兼容性更强的复制函数
            const copyToClipboard = (text) => {
                return new Promise((resolve, reject) => {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(resolve).catch(() => fallbackCopy(text, resolve, reject));
                    } else {
                        fallbackCopy(text, resolve, reject);
                    }
                });
            };

            const fallbackCopy = (text, resolve, reject) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus(); textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (successful) resolve(); else reject(new Error('复制指令失败'));
                } catch (err) { reject(err); }
            };

            const contactWhatsApp = () => {
                const url = `https://wa.me/${MY_WHATSAPP_NUMBER}?text=${encodeURIComponent(getChartText())}`;
                window.open(url, '_blank');
            };

            const contactWeChat = async () => {
                const text = getChartText();
                copyToClipboard(text)
                    .then(() => {
                        showToast('详细卦象已复制！请粘贴给大师', 'success');
                        setTimeout(() => window.location.href = 'weixin://', 1200);
                    })
                    .catch(() => showToast('复制失败，请手动截图', 'error'));
            };

            const copyWeChatIDOnly = () => {
                copyToClipboard(MY_WECHAT_ID)
                    .then(() => showToast('微信号已复制！', 'success'))
                    .catch(() => showToast('复制失败', 'error'));
            }

            const resetAll = () => {
                step.value = 1;
                inputLines.value = [];
                question.value = '';
                statusText.value = '点击按钮摇卦';
            };

            const getRelationClass = (r) => {
                if(r==='官鬼') return 'text-purple-700'; if(r==='妻财') return 'text-green-700';
                if(r==='子孙') return 'text-blue-700'; if(r==='兄弟') return 'text-orange-700';
                return 'text-stone-600';
            };

            // Logic Helpers
            const identifyHexagram=(bits)=>{const lKey=''+bits[2]+bits[1]+bits[0],uKey=''+bits[5]+bits[4]+bits[3];const tian=bits[5]===bits[2],ren=bits[4]===bits[1],di=bits[3]===bits[0];let shi=0,pName='',isYou=false,isGui=false;const uName=TRIGRAMS[uKey].name,lName=TRIGRAMS[lKey].name;const inv=(k)=>k.split('').map(x=>x==='1'?'0':'1').join('');if(tian&&ren&&di){shi=6;pName=uName;}else if(tian&&ren&&!di){shi=1;pName=uName;}else if(tian&&!ren&&!di){shi=2;pName=uName;}else if(!tian&&!ren&&!di){shi=3;pName=uName;}else if(!tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;}else if(!tian&&ren&&di){shi=5;pName=TRIGRAMS[inv(lKey)].name;}else if(tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;isYou=true;}else if(!tian&&ren&&!di){shi=3;pName=lName;isGui=true;}const pEl=NA_JIA[pName]?TRIGRAMS[Object.keys(TRIGRAMS).find(k=>TRIGRAMS[k].name===pName)].element:'金';let oIdx=0;if(shi===6)oIdx=0;else if(shi===1)oIdx=1;else if(shi===2)oIdx=2;else if(shi===3&&!isGui)oIdx=3;else if(shi===4&&!isYou)oIdx=4;else if(shi===5)oIdx=5;else if(isYou)oIdx=6;else if(isGui)oIdx=7;let pIndex=['乾','坎','艮','震','巽','离','坤','兑'].indexOf(pName);if(pIndex===-1)pIndex=0;return{fullName:PALACES[pIndex][oIdx],palace:pName,palaceIndex:pIndex,element:pEl,shiIndex:shi-1,yingIndex:(shi-1+3)%6};};
            
            const mountHexagram=(bits,info,mov,isM,overrideEl)=>{
                const lName=TRIGRAMS[''+bits[2]+bits[1]+bits[0]].name,uName=TRIGRAMS[''+bits[5]+bits[4]+bits[3]].name;
                const lines=[],pEl=overrideEl||info.element;
                for(let i=0;i<6;i++){
                    const isY=bits[i]===1,rule=i<3?NA_JIA[lName]:NA_JIA[uName];
                    const st=i<3?rule[0]:rule[2],br=i<3?rule[1][i]:rule[3][i-3];
                    const wx=WUXING_MAP[br],rel=getLiuQin(pEl,wx);
                    lines.push({index:i,isYang:isY,stem:st,branch:br,wuxing:wx,relation:rel,shi:isM&&i===info.shiIndex,ying:isM&&i===info.yingIndex,isMoving:isM&&mov.includes(i),isMovingOrigin:!isM&&mov.includes(i)});
                }
                return {lines};
            };
            const getLiuQin=(p,l)=>{const gens={'木':'火','火':'土','土':'金','金':'水','水':'木'},cons={'木':'土','土':'水','水':'火','火':'金','金':'木'};if(p===l)return'兄弟';if(gens[l]===p)return'父母';if(gens[p]===l)return'子孙';if(cons[l]===p)return'官鬼';if(cons[p]===l)return'妻财';return'未知';};

            return { step, question, inputLines, isShaking, lastCoins, statusText, currentChart, lunarInfo, nextStep, shake, resetAll, contactWhatsApp, contactWeChat, copyWeChatIDOnly, getRelationClass, MY_WECHAT_ID, toast };
        }
    }).mount('#app');
</script>
</body>
</html>
