<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>六爻天机 - 真人大师亲算</title>
    
    <!-- ========================================== -->
    <!-- 核心依赖库 (修复：补充缺失的库)            -->
    <!-- ========================================== -->
    
    <!-- 1. Tailwind CSS (样式框架) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Vue 3 (前端框架) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 3. Lunar.js (农历/八字核心算法库 - 必需) -->
    <script src="https://unpkg.com/lunar-javascript@1.6.12/lunar.js"></script>
    
    <!-- 4. Phosphor Icons (图标库 - 必需) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- 5. 不蒜子 (访问量统计 - 可选) -->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Ma+Shan+Zheng&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        :root {
            --paper-bg: #f7f5f0;
            --ink-color: #2c2c2c;
            --cinnabar: #a93226;
            --whatsapp-green: #25D366;
            --wechat-green: #07C160;
        }

        body {
            font-family: 'Noto Serif SC', 'Crimson Text', serif;
            background-color: var(--paper-bg);
            color: var(--ink-color);
            background-image: 
                radial-gradient(#e3e0d8 1px, transparent 1px),
                linear-gradient(to bottom, #fcfbf9, #f0eee9);
            background-size: 20px 20px, 100% 100%;
        }

        /* 隐藏滚动条 */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* 六爻 - 阴阳爻样式 */
        .yang-stroke { 
            height: 12px; width: 100%; 
            background: linear-gradient(90deg, #c0392b, #a93226, #c0392b);
            box-shadow: 0 1px 2px rgba(169, 50, 38, 0.2);
            border-radius: 3px;
        }
        .yin-stroke-wrapper { display: flex; justify-content: space-between; width: 100%; }
        .yin-stroke { 
            height: 12px; width: 44%; 
            background: linear-gradient(90deg, #424949, #2c3e50, #424949);
            box-shadow: 0 1px 2px rgba(44, 62, 80, 0.2);
            border-radius: 3px;
        }

        /* 铜钱动画 */
        .coin {
            width: 70px; height: 70px; border-radius: 50%;
            background: conic-gradient(from 45deg, #f1c40f, #f9e79f, #b7950b, #f1c40f);
            box-shadow: inset 0 0 0 4px #d4ac0d, inset 2px 2px 5px rgba(255,255,255,0.4), 2px 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: #7d6608;
            position: relative;
        }
        .coin::after {
            content: ''; width: 24px; height: 24px;
            background-color: #f0eee9; border: 2px solid #b7950b;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); position: absolute; z-index: 1;
        }
        .coin-text { position: absolute; z-index: 2; font-family: 'Ma Shan Zheng', cursive; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }

        @keyframes toss {
            0% { transform: translateY(0) rotateX(0) scale(1); }
            50% { transform: translateY(-120px) rotateX(720deg) scale(1.1); }
            100% { transform: translateY(0) rotateX(1440deg) scale(1); }
        }
        .animate-toss { animation: toss 0.8s cubic-bezier(0.45, 0.05, 0.55, 0.95); }

        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(169, 50, 38, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(169, 50, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(169, 50, 38, 0); }
        }
        .btn-shake { animation: pulse-shadow 2s infinite; }

        /* 八字 - 五行颜色 */
        .wx-wood { color: #166534; } 
        .wx-fire { color: #dc2626; } 
        .wx-earth { color: #854d0e; } 
        .wx-metal { color: #525252; } 
        .wx-water { color: #1e40af; } 
        
        .bazi-pillar {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 0;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* 八字 - 大运样式 (修复：选中时文字颜色) */
        .dayun-selected {
            background-color: #a93226 !important;
            box-shadow: 0 4px 6px -1px rgba(169, 50, 38, 0.3);
            border: 1px solid #a93226;
        }
        /* 强制选中状态下的所有子元素变成白色 */
        .dayun-selected * {
            color: white !important;
        }
        
        .dayun-current-border {
            border: 2px solid #a93226;
            background-color: rgba(169, 50, 38, 0.05);
        }
        .dayun-item {
            min-width: 3.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.6);
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        /* 修复：精简动画定义，避免冗余 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active { transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .slide-up-enter-from { opacity: 0; transform: translateY(30px); }
        .slide-up-enter-to { opacity: 1; transform: translateY(0); }
        
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { transform: translateY(-100%); opacity: 0; }
        .toast-enter-to, .toast-leave-from { transform: translateY(0); opacity: 1; }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px -8px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex flex-col text-stone-800">

<div id="app" class="w-full h-full flex flex-col relative max-w-md mx-auto shadow-2xl bg-white/30">

    <!-- Toast 提示 -->
    <transition name="toast">
        <div v-if="toast.show" class="absolute top-0 left-0 right-0 z-50 p-4 flex justify-center">
            <div class="bg-stone-800 text-white px-4 py-2 rounded-full shadow-lg text-sm flex items-center gap-2">
                <i v-if="toast.type === 'success'" class="ph ph-check-circle text-green-400"></i>
                <i v-else class="ph ph-info text-blue-400"></i>
                <span>{{ toast.message }}</span>
            </div>
        </div>
    </transition>

    <!-- Header -->
    <header class="h-14 flex items-center justify-between px-4 shrink-0 z-10 pt-2 bg-white/40 backdrop-blur-sm border-b border-stone-200/50">
        <div class="w-8"></div>
        <div class="flex flex-col items-center">
            <h1 class="font-serif font-bold text-lg tracking-[0.2em] text-[#a93226]" style="font-family: 'Ma Shan Zheng', cursive;">
                {{ t('app_title') }}
            </h1>
        </div>
        <button @click="toggleLang" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200/50 transition text-stone-600">
            <i class="ph ph-globe text-xl"></i>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden p-6 relative" ref="scrollContainer">
        
        <!-- Phase 1: 输入与模式选择 -->
        <transition name="fade" mode="out-in">
            <div v-if="step === 1" key="step1" class="h-full flex flex-col">
                
                <!-- 模式切换 Tab -->
                <div class="bg-white/60 p-1 rounded-xl flex mb-8 shadow-sm border border-white">
                    <button @click="switchMode('liuyao')" 
                        class="flex-1 py-2 text-sm font-bold rounded-lg transition-all duration-300"
                        :class="mode === 'liuyao' ? 'bg-white shadow text-[#a93226]' : 'text-stone-400 hover:text-stone-600'">
                        {{ t('tab_liuyao') }}
                    </button>
                    <button @click="switchMode('bazi')" 
                        class="flex-1 py-2 text-sm font-bold rounded-lg transition-all duration-300"
                        :class="mode === 'bazi' ? 'bg-white shadow text-[#a93226]' : 'text-stone-400 hover:text-stone-600'">
                        {{ t('tab_bazi') }}
                    </button>
                </div>

                <div class="text-center space-y-3 mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-stone-100 to-white shadow-inner border border-stone-200 mb-2">
                        <i v-if="mode==='liuyao'" class="ph ph-hands-praying text-3xl text-stone-600"></i>
                        <i v-else class="ph ph-scroll text-3xl text-stone-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-stone-800 tracking-wide">{{ t(mode + '_title') }}</h2>
                    <p class="text-stone-500 text-xs tracking-widest uppercase">{{ t(mode + '_subtitle') }}</p>
                </div>

                <div class="w-full space-y-5 flex-1">
                    
                    <!-- 六爻输入 -->
                    <div v-if="mode === 'liuyao'" class="space-y-5">
                        <div class="relative group">
                            <textarea v-model="question" rows="4" :placeholder="t('step1_placeholder')" 
                                class="w-full p-5 bg-white/80 border border-stone-200 rounded-2xl focus:outline-none focus:border-[#a93226] focus:ring-4 focus:ring-[#a93226]/10 transition resize-none shadow-sm text-stone-700 text-lg leading-relaxed placeholder-stone-400"></textarea>
                        </div>
                    </div>

                    <!-- 八字输入 -->
                    <div v-else class="space-y-4">
                        <!-- 性别 -->
                        <div class="flex gap-4">
                            <label class="flex-1 flex items-center justify-center gap-2 p-3 bg-white/80 border border-stone-200 rounded-xl cursor-pointer transition hover:border-[#a93226]"
                                :class="baziInput.gender==='1'?'border-[#a93226] bg-[#a93226]/5':''">
                                <input type="radio" v-model="baziInput.gender" value="1" class="hidden">
                                <i class="ph ph-gender-male text-blue-500"></i>
                                <span class="text-sm font-bold">{{ t('gender_male') }}</span>
                            </label>
                            <label class="flex-1 flex items-center justify-center gap-2 p-3 bg-white/80 border border-stone-200 rounded-xl cursor-pointer transition hover:border-[#a93226]"
                                :class="baziInput.gender==='0'?'border-[#a93226] bg-[#a93226]/5':''">
                                <input type="radio" v-model="baziInput.gender" value="0" class="hidden">
                                <i class="ph ph-gender-female text-pink-500"></i>
                                <span class="text-sm font-bold">{{ t('gender_female') }}</span>
                            </label>
                        </div>

                        <!-- 日期时间 -->
                        <div class="bg-white/80 border border-stone-200 rounded-xl p-4 space-y-3">
                            <div>
                                <label class="block text-xs text-stone-400 mb-1">{{ t('label_birth_date') }}</label>
                                <input type="date" v-model="baziInput.date" class="w-full bg-transparent border-b border-stone-300 py-1 focus:outline-none focus:border-[#a93226] font-mono text-lg text-stone-800">
                            </div>
                            <div>
                                <label class="block text-xs text-stone-400 mb-1">{{ t('label_birth_time') }}</label>
                                <input type="time" v-model="baziInput.time" class="w-full bg-transparent border-b border-stone-300 py-1 focus:outline-none focus:border-[#a93226] font-mono text-lg text-stone-800">
                            </div>
                        </div>
                        
                        <div class="relative group">
                            <input v-model="question" type="text" :placeholder="t('bazi_question_ph')" 
                                class="w-full p-4 bg-white/80 border border-stone-200 rounded-xl focus:outline-none focus:border-[#a93226] transition shadow-sm text-stone-700">
                        </div>
                    </div>
                    
                    <button @click="nextStep" :disabled="!canProceed"
                        class="w-full py-4 bg-[#2c2c2c] text-[#f7f5f0] rounded-xl font-bold text-lg shadow-xl hover:bg-black hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                        <span>{{ t('btn_start') }}</span>
                        <i class="ph ph-arrow-right"></i>
                    </button>
                    
                    <div class="text-center mt-4">
                         <p class="text-[10px] text-stone-400">{{ t('step1_footer') }}</p>
                    </div>
                </div>
            </div>

            <!-- Phase 2: 六爻摇卦 -->
            <div v-else-if="step === 2 && mode === 'liuyao'" key="step2" class="h-full flex flex-col">
                <div class="text-center mb-8 animate-fade-in">
                    <div class="text-[10px] text-stone-400 uppercase tracking-widest mb-2">{{ t('label_question') }}</div>
                    <div class="font-serif font-bold text-lg text-stone-800 px-4 leading-relaxed line-clamp-2">{{ question }}</div>
                    <div class="w-12 h-px bg-stone-200 mx-auto mt-4"></div>
                </div>

                <div class="flex-1 flex flex-col justify-center items-center space-y-12 -mt-10">
                    <div class="h-24 flex items-center justify-center gap-6 perspective-1000 w-full">
                        <div v-for="c in 3" :key="c" class="coin transform transition-all" :class="{'animate-toss': isShaking}">
                            <div class="coin-text" :class="lastCoins[c-1] === 3 ? 'top-[42%] left-[45%]' : 'top-[10%] left-[30%]'">
                                <span v-if="!isShaking && lastCoins[c-1] === 2" class="text-sm scale-90 block">{{ t('coin_yang') }}</span>
                                <i v-if="!isShaking && lastCoins[c-1] === 3" class="ph ph-flower-lotus text-xs opacity-60"></i>
                            </div>
                        </div>
                    </div>

                    <div class="text-center space-y-8">
                        <div class="relative inline-block">
                             <button @click="shake" :disabled="isShaking"
                                class="w-28 h-28 rounded-full bg-[#a93226] text-[#f7f5f0] font-bold text-xl shadow-2xl active:scale-95 transition-all flex flex-col items-center justify-center gap-1 z-10 relative overflow-hidden group"
                                :class="{'btn-shake': !isShaking && inputLines.length < 6}">
                                <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <i class="ph ph-hand-waving text-3xl mb-1 group-hover:rotate-12 transition-transform"></i>
                                <span class="text-sm font-medium tracking-widest">
                                    {{ inputLines.length < 6 ? t('btn_shake') : t('btn_finish') }}
                                </span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div class="font-mono text-[#a93226] font-bold h-6 text-sm tracking-wider">{{ statusText }}</div>
                            <div class="flex justify-center gap-1.5">
                                <div v-for="i in 6" :key="i" class="w-1.5 h-1.5 rounded-full transition-all duration-500"
                                        :class="inputLines.length >= i ? 'bg-[#a93226] scale-110' : 'bg-stone-300 scale-90'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phase 3: 结果展示 -->
            <div v-else-if="step === 3" key="step3" class="space-y-6 pb-20">
                
                <!-- 六爻结果卡片 -->
                <template v-if="mode === 'liuyao'">
                    <div class="flex flex-col items-center justify-center pt-2">
                        <div class="text-sm text-stone-600 font-bold font-mono tracking-wide">{{ lunarInfo.dateStr }}</div>
                        <div class="text-[10px] text-stone-400 font-mono mt-1">{{ t('label_void') }}: {{ lunarInfo.kongWang }}</div>
                    </div>

                    <transition appear name="slide-up">
                        <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                            <div class="absolute right-0 top-0 bottom-0 w-1 bg-[#a93226]/20"></div>
                            <div class="flex justify-between items-start mb-6 border-b border-stone-200/60 pb-3">
                                <div>
                                    <span class="text-[10px] text-stone-400 block mb-1 uppercase tracking-wider">Present</span>
                                    <h3 class="text-2xl font-bold text-[#a93226]">{{ currentChart.main.name }}</h3>
                                    <span class="text-xs text-stone-500 bg-stone-100/50 px-2 py-0.5 rounded-full mt-1 inline-block">
                                        {{ currentChart.main.palace }}{{ t('label_palace') }} · {{ translateTerm(currentChart.main.element) }}
                                    </span>
                                </div>
                                <div class="text-4xl text-stone-100 font-serif absolute right-4 top-2 select-none" style="font-family: 'Ma Shan Zheng'">{{ t('label_main_bg') }}</div>
                            </div>
                            <div class="space-y-2.5 relative z-10">
                                <div v-for="line in currentChart.main.lines" :key="'main-'+line.index" class="flex items-center text-sm h-8 group">
                                    <div class="w-12 text-stone-400 text-[10px] text-center scale-95">{{ translateTerm(line.beast) }}</div>
                                    <div class="w-12 font-bold text-xs text-center scale-95" :class="getRelationClass(line.relation)">{{ translateTerm(line.relation) }}</div>
                                    <div class="w-14 font-mono text-[10px] text-stone-500 scale-90 origin-center text-center">{{ line.stem }}{{ line.branch }}{{ translateTerm(line.wuxing) }}</div>
                                    <div class="flex-1 px-2 flex items-center">
                                        <div v-if="line.isYang" class="yang-stroke relative transition-all group-hover:brightness-110">
                                            <div v-if="line.isMoving" class="absolute -right-1.5 -top-1 w-2 h-2 rounded-full bg-[#a93226] animate-pulse"></div>
                                        </div>
                                        <div v-else class="yin-stroke-wrapper relative transition-all group-hover:brightness-110">
                                            <div class="yin-stroke"></div> <div class="yin-stroke"></div>
                                            <div v-if="line.isMoving" class="absolute left-1/2 -translate-x-1/2 -top-1 w-2 h-2 rounded-full bg-[#a93226] animate-pulse"></div>
                                        </div>
                                    </div>
                                    <div class="w-6 text-[10px] font-bold text-center">
                                        <span v-if="line.shi" class="text-white bg-[#a93226] px-1 rounded shadow-sm">{{ t('label_shi') }}</span>
                                        <span v-if="line.ying" class="text-[#a93226] border border-[#a93226] px-0.5 rounded">{{ t('label_ying') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </transition>

                    <div v-if="currentChart.hasChange" class="flex justify-center -my-2 relative z-10 opacity-60">
                        <i class="ph ph-arrow-down text-2xl text-stone-400 animate-bounce"></i>
                    </div>

                    <transition appear name="slide-up" v-if="currentChart.hasChange">
                        <div class="glass-card rounded-2xl p-5 relative overflow-hidden bg-[#fbfdfc]/90">
                            <div class="absolute right-0 top-0 bottom-0 w-1 bg-stone-400/20"></div>
                            <div class="flex justify-between items-start mb-6 border-b border-stone-200/60 pb-3">
                                <div>
                                    <span class="text-[10px] text-stone-400 block mb-1 uppercase tracking-wider">Future</span>
                                    <h3 class="text-2xl font-bold text-stone-700">{{ currentChart.changed.name }}</h3>
                                    <span class="text-xs text-stone-500 bg-stone-100/50 px-2 py-0.5 rounded-full mt-1 inline-block">{{ t('label_change_trend') }}</span>
                                </div>
                                <div class="text-4xl text-stone-100 font-serif absolute right-4 top-2 select-none" style="font-family: 'Ma Shan Zheng'">{{ t('label_change_bg') }}</div>
                            </div>
                            <div class="space-y-2.5 relative z-10">
                                <div v-for="line in currentChart.changed.lines" :key="'changed-'+line.index" class="flex items-center text-sm h-8 opacity-90 group">
                                    <div class="w-12 text-stone-400 text-[10px] text-center scale-95">{{ translateTerm(line.beast) }}</div>
                                    <div class="w-12 font-bold text-xs text-center scale-95" :class="getRelationClass(line.relation)">{{ translateTerm(line.relation) }}</div>
                                    <div class="w-14 font-mono text-[10px] text-stone-500 scale-90 origin-center text-center">{{ line.stem }}{{ line.branch }}{{ translateTerm(line.wuxing) }}</div>
                                    <div class="flex-1 px-2 flex items-center">
                                        <div v-if="line.isYang" class="yang-stroke bg-stone-500 !bg-none !box-shadow-none bg-stone-600"></div>
                                        <div v-else class="yin-stroke-wrapper">
                                            <div class="yin-stroke bg-stone-500 !bg-none !box-shadow-none bg-stone-600"></div> <div class="yin-stroke bg-stone-500 !bg-none !box-shadow-none bg-stone-600"></div>
                                        </div>
                                    </div>
                                    <div class="w-6 text-[10px] text-center"></div>
                                </div>
                            </div>
                        </div>
                    </transition>
                </template>

                <!-- 八字结果卡片 -->
                <template v-else>
                    <transition appear name="slide-up">
                        <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                            <!-- 顶部信息 -->
                            <div class="flex justify-between items-center mb-6 pb-2 border-b border-stone-200/50">
                                <div class="text-xs text-stone-500 font-bold bg-stone-100 px-2 py-1 rounded">
                                    {{ baziChart.gender === '1' ? t('bazi_male') : t('bazi_female') }} / {{ t('label_solar') }}
                                </div>
                                <div class="text-[10px] text-stone-400 font-mono">{{ baziChart.solarDate }}</div>
                            </div>

                            <!-- 四柱展示 -->
                            <div class="grid grid-cols-4 gap-2 mb-6">
                                <div class="text-center text-[10px] text-stone-400 uppercase tracking-widest">{{ t('col_year') }}</div>
                                <div class="text-center text-[10px] text-stone-400 uppercase tracking-widest">{{ t('col_month') }}</div>
                                <div class="text-center text-[10px] text-stone-400 uppercase tracking-widest">{{ t('col_day') }}</div>
                                <div class="text-center text-[10px] text-stone-400 uppercase tracking-widest">{{ t('col_hour') }}</div>

                                <div v-for="(p, i) in baziChart.pillars" :key="i" class="bazi-pillar">
                                    <div class="text-lg font-bold" :class="getWuXingColor(p.stemWx)">{{ p.stem }}</div>
                                    <div class="text-lg font-bold" :class="getWuXingColor(p.branchWx)">{{ p.branch }}</div>
                                    <div class="text-[10px] text-stone-400 mt-1 scale-90">{{ t('wx_'+p.stemWx) }}</div>
                                </div>
                            </div>

                            <!-- 运势推演 (大运/流年/流日) -->
                            <div class="bg-white/50 rounded-lg p-3 border border-stone-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="text-[10px] text-stone-400 uppercase">{{ t('label_luck_cycle') }}</div>
                                    <div class="text-[10px] text-[#a93226] font-bold">{{ t('label_start_luck') }}: {{ baziChart.startAge }} {{ t('label_age') }}</div>
                                </div>
                                
                                <!-- 大运滚动条 (可点击) -->
                                <div class="flex overflow-x-auto gap-2 pb-2 mb-3">
                                    <div v-for="(dy, idx) in baziChart.dayun" :key="idx" 
                                         @click="selectDaYun(idx)"
                                         class="dayun-item transition-all shrink-0 cursor-pointer"
                                         :class="[
                                            selectedDaYunIndex === idx ? 'dayun-selected' : '',
                                            (dy.isCurrent && selectedDaYunIndex !== idx) ? 'dayun-current-border' : ''
                                         ]">
                                        <div class="font-bold">{{ dy.ganZhi }}</div>
                                        <div class="text-[9px] opacity-80">{{ dy.startAge }}{{ t('label_age_short') }}</div>
                                    </div>
                                </div>

                                <!-- 流年流日 (可自由选择日期) - 修复选择问题 -->
                                <div class="bg-stone-100/50 rounded p-3 text-center border border-stone-200/50 flex items-center justify-between">
                                    
                                    <div class="text-left relative">
                                        <div class="text-[9px] text-stone-400 mb-1 flex items-center gap-1">
                                            {{ t('label_analysis_date') }}
                                        </div>
                                        <!-- 显式日期选择器 -->
                                        <input type="date" v-model="analysisDate" @change="updateAnalysis" 
                                               class="bg-transparent font-mono text-xs font-bold text-stone-600 border-b border-dashed border-stone-300 focus:outline-none focus:border-[#a93226]">
                                    </div>

                                    <div class="text-right">
                                        <div class="font-bold text-stone-800 text-sm">{{ baziChart.currentLiuNian }}</div>
                                        <div class="font-bold text-stone-600 text-xs">{{ baziChart.currentLiuRi }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 五行统计 -->
                            <div class="bg-stone-50 rounded-lg p-3">
                                <div class="text-[10px] text-stone-400 mb-2 uppercase">{{ t('label_5_elements') }}</div>
                                <div class="flex h-3 rounded-full overflow-hidden w-full">
                                    <div v-for="(count, wx) in baziChart.wuxingCount" :key="wx" 
                                         :style="{width: (count/8*100) + '%', backgroundColor: getWuXingHex(wx)}"
                                         class="h-full transition-all duration-500" :title="t('wx_'+wx)"></div>
                                </div>
                                <div class="flex justify-between mt-2 text-[10px] text-stone-500 font-mono">
                                    <span v-for="(count, wx) in baziChart.wuxingCount" :key="'txt'+wx" class="flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full" :style="{backgroundColor: getWuXingHex(wx)}"></span>
                                        {{count}}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </transition>
                </template>

                <!-- 邀请函 (双通道引流) -->
                <transition appear name="slide-up">
                    <div class="bg-gradient-to-b from-[#f0fdf4] to-[#dcfce7] border border-[#bbf7d0] rounded-2xl p-6 text-center space-y-5 shadow-lg relative overflow-hidden mt-4">
                        <div class="relative z-10">
                            <h3 class="text-lg font-bold text-[#14532d] mb-2 flex items-center justify-center gap-2">
                                <i class="ph ph-chat-circle-dots text-xl"></i>
                                <span>{{ t('cta_title') }}</span>
                            </h3>
                            <p class="text-xs text-[#166534] leading-relaxed opacity-90 px-2 mb-4">
                                {{ t('cta_desc_1') }}<br>
                                {{ t('cta_desc_2') }}
                            </p>

                            <div class="grid grid-cols-2 gap-3">
                                <button @click="contactWhatsApp"
                                    class="relative w-full py-3 bg-[#25D366] hover:bg-[#128C7E] text-white rounded-xl font-bold text-sm shadow-md active:translate-y-0.5 transition-all flex flex-col items-center justify-center gap-1">
                                    <i class="ph ph-whatsapp-logo text-2xl"></i>
                                    <span>WhatsApp</span>
                                </button>
                                <button @click="contactWeChat"
                                    class="relative w-full py-3 bg-[#07C160] hover:bg-[#06ad56] text-white rounded-xl font-bold text-sm shadow-md active:translate-y-0.5 transition-all flex flex-col items-center justify-center gap-1">
                                    <i class="ph ph-wechat-logo text-2xl"></i>
                                    <span>{{ t('btn_wechat') }}</span>
                                </button>
                            </div>
                            
                            <div class="text-[10px] text-[#166534] mt-3 bg-white/40 rounded-lg p-2 inline-block">
                                {{ t('label_wechat_id') }}: <span class="font-mono font-bold select-all">{{ MY_WECHAT_ID }}</span>
                                <span @click="copyWeChatIDOnly" class="ml-2 underline cursor-pointer text-[#07C160]">{{ t('btn_copy') }}</span>
                            </div>
                        </div>
                    </div>
                </transition>

                <div class="text-center pt-2 pb-6">
                    <button @click="resetAll" class="text-xs text-stone-400 hover:text-stone-600 flex items-center justify-center gap-1.5 mx-auto px-4 py-2 hover:bg-stone-100 rounded-full transition-colors">
                        <i class="ph ph-arrow-counter-clockwise"></i>
                        <span>{{ t('btn_restart') }}</span>
                    </button>
                </div>

            </div>
        </transition>

    </main>
</div>

<script>
    const { createApp, ref, reactive, computed } = Vue;

    // --- 配置 ---
    const MY_WHATSAPP_NUMBER = "8615382537862"; 
    const MY_WECHAT_ID = "Nobebaelaguaporfavor"; 

    // --- I18n ---
    const messages = {
        zh: {
            app_title: "六爻天机",
            tab_liuyao: "六爻占卜",
            tab_bazi: "八字命理",
            liuyao_title: "六爻起卦",
            liuyao_subtitle: "DIVINATION",
            bazi_title: "八字排盘",
            bazi_subtitle: "FOUR PILLARS",
            step1_placeholder: "请默念您的问题...\n例如：近期事业发展有无阻碍？",
            btn_start: "开始排盘",
            step1_footer: "* 心诚则灵，无事不占",
            visits: "累计访问",
            label_question: "所占之事",
            coin_yang: "字",
            btn_shake: "摇卦",
            btn_finish: "完成",
            label_void: "空亡",
            label_solar: "公历",
            label_palace: "宫",
            label_main_bg: "本",
            label_shi: "世",
            label_ying: "应",
            label_change_trend: "变卦 · 趋势",
            label_change_bg: "变",
            label_no_change: "六爻安静，以本卦断吉凶",
            cta_title: "大师详批通道",
            cta_desc_1: "天机深奥，需结合流年神煞。",
            cta_desc_2: "请选择下方任一方式联系大师。",
            btn_wechat: "微信联系",
            label_wechat_id: "大师微信号",
            btn_copy: "复制",
            btn_restart: "重新起卦",
            toast_copy_success: "信息已复制！正在打开微信...",
            toast_wechat_copy: "微信号已复制！",
            toast_fail: "复制失败",
            msg_intro: "大师您好，我诚心求测。",
            msg_q: "【问题】",
            msg_t: "【时间】",
            msg_g: "【卦象】",
            msg_bazi: "【八字】",
            msg_yun: "【大运流年】",
            msg_end: "请大师详批。",
            label_birth_date: "出生日期 (公历)",
            label_birth_time: "出生时间",
            gender_male: "男",
            gender_female: "女",
            bazi_question_ph: "您想问大师关于命运的什么问题？(选填)",
            bazi_male: "乾造 (男)",
            bazi_female: "坤造 (女)",
            col_year: "年柱", col_month: "月柱", col_day: "日柱", col_hour: "时柱",
            label_5_elements: "五行能量",
            wx_wood: "木", wx_fire: "火", wx_earth: "土", wx_metal: "金", wx_water: "水",
            label_luck_cycle: "大运推演",
            label_start_luck: "起运",
            label_age: "岁",
            label_age_short: "岁",
            label_curr_year: "流年",
            label_curr_day: "流日",
            label_analysis_date: "推演日期"
        },
        en: {
            app_title: "Destiny Decoder",
            tab_liuyao: "Divination",
            tab_bazi: "BaZi Destiny",
            liuyao_title: "I Ching",
            liuyao_subtitle: "DIVINATION",
            bazi_title: "BaZi Chart",
            bazi_subtitle: "FOUR PILLARS",
            step1_placeholder: "Meditate on your question...\nEx: Will my career improve soon?",
            btn_start: "Analyze",
            step1_footer: "* Sincerity brings accuracy",
            visits: "Visits",
            label_question: "Question",
            coin_yang: "Head",
            btn_shake: "Shake",
            btn_finish: "Finish",
            label_void: "Void",
            label_solar: "Solar",
            label_palace: " Palace",
            label_main_bg: "Base",
            label_shi: "Self",
            label_ying: "Other",
            label_change_trend: "Change / Trend",
            label_change_bg: "Chg",
            label_no_change: "No moving lines.",
            cta_title: "Expert Interpretation",
            cta_desc_1: "Deep insight requires expert analysis.",
            cta_desc_2: "Contact Master for a detailed reading.",
            btn_wechat: "WeChat",
            label_wechat_id: "WeChat ID",
            btn_copy: "Copy",
            btn_restart: "Restart",
            toast_copy_success: "Copied! Opening WeChat...",
            toast_wechat_copy: "ID Copied!",
            toast_fail: "Copy failed",
            msg_intro: "Hello Master, I seek a reading.",
            msg_q: "[Question]",
            msg_t: "[Time]",
            msg_g: "[Hexagram]",
            msg_bazi: "[BaZi Chart]",
            msg_yun: "[Luck Cycles]",
            msg_end: "Please analyze.",
            label_birth_date: "Birth Date (Solar)",
            label_birth_time: "Birth Time",
            gender_male: "Male",
            gender_female: "Female",
            bazi_question_ph: "Specific question about your destiny? (Optional)",
            bazi_male: "Male",
            bazi_female: "Female",
            col_year: "YEAR", col_month: "MONTH", col_day: "DAY", col_hour: "HOUR",
            label_5_elements: "5 Elements",
            wx_wood: "Wood", wx_fire: "Fire", wx_earth: "Earth", wx_metal: "Metal", wx_water: "Water",
            label_luck_cycle: "Luck Cycles (Da Yun)",
            label_start_luck: "Start Age",
            label_age: "",
            label_age_short: "y.o.",
            label_curr_year: "Current Year",
            label_curr_day: "Current Day",
            label_analysis_date: "Analysis Date"
        }
    };

    const terms = {
        zh: {},
        en: {
            '金': 'Metal', '木': 'Wood', '水': 'Water', '火': 'Fire', '土': 'Earth',
            '父母': 'Parent', '兄弟': 'Sibling', '子孙': 'Offspring', '妻财': 'Wealth', '官鬼': 'Official',
            '青龙': 'Dragon', '朱雀': 'Bird', '勾陈': 'Hook', '腾蛇': 'Snake', '白虎': 'Tiger', '玄武': 'Tortoise'
        }
    };

    const TRIGRAMS = { '111': {name:'乾',element:'金'}, '011': {name:'兑',element:'金'}, '101': {name:'离',element:'火'}, '001': {name:'震',element:'木'}, '110': {name:'巽',element:'木'}, '010': {name:'坎',element:'水'}, '100': {name:'艮',element:'土'}, '000': {name:'坤',element:'土'} };
    const PALACES = [['乾为天','天风姤','天山遁','天地否','风地观','山地剥','火地晋','火天大有'],['坎为水','水泽节','水雷屯','水火既济','泽火革','雷火丰','地火明夷','地水师'],['艮为山','山火贲','山天大畜','山泽损','火泽睽','天泽履','风泽中孚','风山渐'],['震为雷','雷地豫','雷水解','雷风恒','地风升','水风井','泽风大过','泽雷随'],['巽为风','风天小畜','风火家人','风雷益','天雷无妄','火雷噬嗑','山雷颐','山风蛊'],['离为火','火山旅','火风鼎','火水未济','山水蒙','风水涣','天水讼','天火同人'],['坤为地','地雷复','地泽临','地天泰','雷天大壮','泽天夬','水天需','水地比'],['兑为泽','泽水困','泽地萃','泽山咸','水山蹇','地山谦','雷山小过','雷泽归妹']];
    const NA_JIA = {'乾':['甲',['子','寅','辰'],'壬',['午','申','戌']],'震':['庚',['子','寅','辰'],'庚',['午','申','戌']],'坎':['戊',['寅','辰','午'],'戊',['申','戌','子']],'艮':['丙',['辰','午','申'],'丙',['戌','子','寅']],'坤':['乙',['未','巳','卯'],'癸',['丑','亥','酉']],'巽':['辛',['丑','亥','酉'],'辛',['未','巳','卯']],'离':['己',['卯','丑','亥'],'己',['酉','未','巳']],'兑':['丁',['巳','卯','丑'],'丁',['亥','酉','未']]};
    const WUXING_MAP = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    const LIU_SHEN_START = {'甲':0,'乙':0,'丙':1,'丁':1,'戊':2,'己':3,'庚':4,'辛':4,'壬':5,'癸':5};
    const LIU_SHEN_ORDER = ['青龙','朱雀','勾陈','腾蛇','白虎','玄武'];

    createApp({
        setup() {
            const currentLang = ref('zh');
            const mode = ref('liuyao'); // 'liuyao' or 'bazi'
            const step = ref(1); 
            const question = ref('');
            
            // 六爻 State
            const inputLines = ref([]);
            const isShaking = ref(false);
            const lastCoins = ref([2,2,2]);
            const statusText = ref('');
            const currentChart = ref(null);
            
            // 八字 State
            const baziInput = reactive({ gender: '1', date: '', time: '' });
            const baziChart = ref(null);
            const analysisDate = ref(new Date().toISOString().split('T')[0]); // Default today
            const selectedDaYunIndex = ref(-1);
            
            const lunarInfo = ref({});
            const toast = reactive({ show: false, message: '', type: 'info' });

            const t = (key) => messages[currentLang.value][key] || key;
            const translateTerm = (term) => (currentLang.value === 'zh' ? term : (terms.en[term] || term));

            const toggleLang = () => {
                currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh';
                if(step.value === 2 && mode.value === 'liuyao' && !isShaking.value && inputLines.value.length === 0) {
                    statusText.value = currentLang.value === 'zh' ? '点击按钮摇卦' : 'Tap button to shake';
                }
            };

            const switchMode = (m) => {
                mode.value = m;
                step.value = 1;
                question.value = '';
                if(m === 'bazi' && !baziInput.date) {
                    const now = new Date();
                    baziInput.date = now.toISOString().split('T')[0];
                    baziInput.time = now.toTimeString().split(' ')[0].substring(0,5);
                }
            };

            const canProceed = computed(() => {
                if(mode.value === 'liuyao') return question.value.trim().length > 0;
                if(mode.value === 'bazi') return baziInput.date && baziInput.time;
                return false;
            });

            const nextStep = () => {
                if(mode.value === 'liuyao') {
                    if(question.value.trim()) {
                        step.value = 2;
                        statusText.value = currentLang.value === 'zh' ? '点击按钮摇卦' : 'Tap button to shake';
                    }
                } else {
                    // BaZi Calculation
                    calcBaZi();
                    step.value = 3;
                }
            };

            const shake = () => {
                if(isShaking.value || inputLines.value.length >= 6) return;
                isShaking.value = true;
                statusText.value = currentLang.value === 'zh' ? '感应中...' : 'Divining...';
                
                setTimeout(() => {
                    const coins = [0,0,0].map(() => Math.random() > 0.5 ? 2 : 3);
                    const sum = coins.reduce((a,b)=>a+b, 0);
                    lastCoins.value = coins;
                    inputLines.value.push(sum);
                    
                    let txt = '';
                    if(sum===6) txt = currentLang.value==='zh' ? "老阴 X" : "Old Yin X"; 
                    if(sum===7) txt = currentLang.value==='zh' ? "少阳 |" : "Young Yang |";
                    if(sum===8) txt = currentLang.value==='zh' ? "少阴 ||" : "Young Yin ||"; 
                    if(sum===9) txt = currentLang.value==='zh' ? "老阳 O" : "Old Yang O";
                    
                    statusText.value = `${currentLang.value==='zh'?'第':'Line'} ${inputLines.value.length} ${currentLang.value==='zh'?'爻':''}: ${txt}`;
                    isShaking.value = false;

                    if(inputLines.value.length === 6) {
                        setTimeout(() => {
                            generateLiuYaoChart();
                            step.value = 3;
                        }, 600);
                    }
                }, 800);
            };

            const generateLiuYaoChart = () => {
                const now = new Date();
                const lunar = Lunar.fromDate(now);
                lunarInfo.value = {
                    dateStr: `${lunar.getYearInGanZhi()}年 ${lunar.getMonthInGanZhi()}月 ${lunar.getDayInGanZhi()}日 ${lunar.getTimeInGanZhi()}时`,
                    kongWang: lunar.getDayXunKong(),
                    solarTime: formatDate(now)
                };
                
                // ... (LiuYao logic same as before) ...
                const mainBits = [], changedBits = [], movingLines = [];
                inputLines.value.forEach((val, idx) => {
                    if (val === 6) { mainBits.push(0); changedBits.push(1); movingLines.push(idx); }
                    else if (val === 7) { mainBits.push(1); changedBits.push(1); }
                    else if (val === 8) { mainBits.push(0); changedBits.push(0); }
                    else if (val === 9) { mainBits.push(1); changedBits.push(0); movingLines.push(idx); }
                });
                const mainInfo = identifyHexagram(mainBits);
                const changedInfo = identifyHexagram(changedBits);
                const mainDetails = mountHexagram(mainBits, mainInfo, movingLines, true);
                const changedDetails = mountHexagram(changedBits, changedInfo, movingLines, false, mainInfo.element);
                const dayStem = lunar.getDayInGanZhi().substring(0,1);
                const startIdx = LIU_SHEN_START[dayStem] || 0;
                mainDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                changedDetails.lines.forEach((l,i) => l.beast = LIU_SHEN_ORDER[(startIdx+i)%6]);
                currentChart.value = {
                    main: { name: mainInfo.fullName, palace: mainInfo.palace, element: mainInfo.element, lines: [...mainDetails.lines].reverse() },
                    changed: { name: changedInfo.fullName, lines: [...changedDetails.lines].reverse() },
                    hasChange: movingLines.length > 0
                };
            };

            const calcBaZi = () => {
                // Initialize/Reset analysis date to today
                analysisDate.value = new Date().toISOString().split('T')[0];
                
                // Safe parsing for date inputs
                const dateParts = baziInput.date.split('-');
                if (dateParts.length !== 3) return; // Basic validation
                const timeParts = baziInput.time.split(':');
                if (timeParts.length !== 2) return;

                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);
                const h = parseInt(timeParts[0]);
                const min = parseInt(timeParts[1]);

                const solar = Solar.fromYmdHms(y, m, d, h, min, 0);
                const lunar = solar.getLunar();
                const eightChar = lunar.getEightChar();
                
                // 1. 四柱
                const wuxingCount = { 'gold':0, 'wood':0, 'water':0, 'fire':0, 'earth':0 };
                const pillars = [
                    {s: eightChar.getYearGan(), b: eightChar.getYearZhi()},
                    {s: eightChar.getMonthGan(), b: eightChar.getMonthZhi()},
                    {s: eightChar.getDayGan(), b: eightChar.getDayZhi()},
                    {s: eightChar.getTimeGan(), b: eightChar.getTimeZhi()}
                ];
                
                const getWx = (char) => {
                    if("甲乙寅卯".includes(char)) return 'wood';
                    if("丙丁巳午".includes(char)) return 'fire';
                    if("戊己辰戌丑未".includes(char)) return 'earth';
                    if("庚辛申酉".includes(char)) return 'metal';
                    if("壬癸亥子".includes(char)) return 'water';
                    return 'earth';
                };

                const processedPillars = pillars.map(p => {
                    const sWx = getWx(p.s);
                    const bWx = getWx(p.b);
                    wuxingCount[sWx === 'metal' ? 'gold' : sWx]++; 
                    return { stem: p.s, branch: p.b, stemWx: sWx, branchWx: bWx };
                });
                
                const counts = { 'wood':0, 'fire':0, 'earth':0, 'metal':0, 'water':0 };
                processedPillars.forEach(p => { counts[p.stemWx]++; counts[p.branchWx]++; });

                // 2. 大运 (安全计算)
                const gender = parseInt(baziInput.gender); 
                const yun = eightChar.getYun(gender);
                const daYunArr = yun.getDaYun();
                
                // Check if daYunArr is valid before accessing [0]
                const startAge = (daYunArr && daYunArr.length > 0) ? daYunArr[0].getStartAge() : 0;
                
                const currentAge = new Date().getFullYear() - y + 1; 

                const processedDaYun = daYunArr.slice(0, 8).map(dy => {
                    const age = dy.getStartAge();
                    const isActive = currentAge >= age && currentAge < (age + 10);
                    return { ganZhi: dy.getGanZhi(), startAge: age, isCurrent: isActive };
                });

                // Set default selected index to current age
                const currentIdx = processedDaYun.findIndex(d => d.isCurrent);
                selectedDaYunIndex.value = currentIdx !== -1 ? currentIdx : 0;

                baziChart.value = {
                    gender: baziInput.gender,
                    solarDate: `${y}-${m}-${d} ${h}:${min}`,
                    pillars: processedPillars,
                    wuxingCount: counts,
                    startAge: startAge,
                    dayun: processedDaYun,
                    currentAge: currentAge,
                    currentLiuNian: '', // Will be set by updateAnalysis
                    currentLiuRi: ''
                };
                
                // 3. Initial Liu Nian/Ri calculation
                updateAnalysis();
            };

            const updateAnalysis = () => {
                if(!baziChart.value) return;
                
                const dateParts = analysisDate.value.split('-');
                if (dateParts.length !== 3) return;

                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);

                const solar = Solar.fromYmd(y, m, d);
                const lunar = solar.getLunar();
                
                baziChart.value.currentLiuNian = lunar.getYearInGanZhi() + (currentLang.value==='zh'?'年':'');
                baziChart.value.currentLiuRi = lunar.getDayInGanZhi() + (currentLang.value==='zh'?'日':'');
            };

            const selectDaYun = (index) => {
                selectedDaYunIndex.value = index;
            };

            // Common Utilities
            const formatDate = (date) => date.toLocaleString('zh-CN', {hour12:false});
            const getWuXingColor = (wx) => `wx-${wx}`;
            const getWuXingHex = (wx) => {
                const map = { wood:'#166534', fire:'#dc2626', earth:'#854d0e', metal:'#525252', water:'#1e40af' };
                return map[wx];
            };

            // Copy Text Logic
            const getCopyText = () => {
                if(mode.value === 'liuyao') return getLiuYaoText();
                return getBaZiText();
            };

            const getLiuYaoText = () => {
                const c = currentChart.value;
                const isZh = currentLang.value === 'zh';
                const changeText = c.hasChange ? ` -> ${c.changed.name}` : '';
                let linesText = '';
                c.main.lines.forEach(line => {
                    const lineSymbol = line.isYang ? "====== " : "==  == ";
                    const movingMark = line.isMoving ? (line.isYang ? "O" : "X") : " "; 
                    const shiYing = line.shi ? (isZh?"(世)":"(Self)") : (line.ying ? (isZh?"(应)":"(Other)") : "    ");
                    linesText += `${lineSymbol}${movingMark} ${translateTerm(line.beast)} ${translateTerm(line.relation)} ${line.branch}${translateTerm(line.wuxing)} ${shiYing}\n`;
                });
                return `${t('msg_intro')}
${t('msg_q')} ${question.value}
${t('msg_t')} ${lunarInfo.value.dateStr}
${t('msg_g')} ${c.main.name} ${changeText}
------------------------
${linesText}------------------------
${t('msg_end')}`;
            };

            const getBaZiText = () => {
                const c = baziChart.value;
                const gender = c.gender === '1' ? t('bazi_male') : t('bazi_female');
                const p = c.pillars;
                const qText = question.value ? `\n${t('msg_q')} ${question.value}` : '';
                
                // Get Selected DaYun
                const selDy = c.dayun[selectedDaYunIndex.value];
                const dyText = selDy ? `${selDy.ganZhi} (${selDy.startAge}${t('label_age_short')})` : 'N/A';

                return `${t('msg_intro')}
${t('label_birth_date')}: ${c.solarDate}
${gender} (${c.currentAge}${t('label_age_short')})
${qText}

${t('msg_bazi')}
${t('col_year')}  ${t('col_month')}  ${t('col_day')}  ${t('col_hour')}
${p[0].stem}${p[0].branch}  ${p[1].stem}${p[1].branch}  ${p[2].stem}${p[2].branch}  ${p[3].stem}${p[3].branch}

${t('msg_yun')}
Focus: ${dyText}
${t('label_analysis_date')}: ${analysisDate.value}
${t('label_curr_year')}: ${c.currentLiuNian}
${t('label_curr_day')}: ${c.currentLiuRi}

${t('label_5_elements')}: 
${t('wx_metal')}:${c.wuxingCount.metal} ${t('wx_wood')}:${c.wuxingCount.wood} ${t('wx_water')}:${c.wuxingCount.water} ${t('wx_fire')}:${c.wuxingCount.fire} ${t('wx_earth')}:${c.wuxingCount.earth}

${t('msg_end')}`;
            };

            const contactWhatsApp = () => {
                const url = `https://wa.me/${MY_WHATSAPP_NUMBER}?text=${encodeURIComponent(getCopyText())}`;
                window.open(url, '_blank');
            };

            const contactWeChat = async () => {
                const text = getCopyText();
                copyToClipboard(text).then(() => {
                    showToast(t('toast_copy_success'), 'success');
                    setTimeout(() => window.location.href = 'weixin://', 1200);
                }).catch(() => showToast(t('toast_fail'), 'error'));
            };
            
            const copyToClipboard = (text) => {
                return new Promise((resolve, reject) => {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(resolve).catch(() => fallbackCopy(text, resolve, reject));
                    } else fallbackCopy(text, resolve, reject);
                });
            };
            const fallbackCopy = (text, resolve, reject) => {
                try {
                    const ta = document.createElement("textarea");
                    ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
                    document.body.appendChild(ta); ta.focus(); ta.select();
                    const s = document.execCommand('copy'); document.body.removeChild(ta);
                    if(s) resolve(); else reject();
                } catch(e) { reject(e); }
            };
            const copyWeChatIDOnly = () => {
                copyToClipboard(MY_WECHAT_ID).then(() => showToast(t('toast_wechat_copy'), 'success')).catch(() => showToast(t('toast_fail'), 'error'));
            };
            const showToast = (msg, type='info') => {
                toast.message = msg; toast.type = type; toast.show = true;
                setTimeout(() => toast.show = false, 3000);
            };
            const resetAll = () => {
                step.value = 1; inputLines.value = []; question.value = ''; statusText.value = '';
            };

            // Hardcoded Logic (Minified)
            const identifyHexagram=(bits)=>{const lKey=''+bits[2]+bits[1]+bits[0],uKey=''+bits[5]+bits[4]+bits[3];const tian=bits[5]===bits[2],ren=bits[4]===bits[1],di=bits[3]===bits[0];let shi=0,pName='',isYou=false,isGui=false;const uName=TRIGRAMS[uKey].name,lName=TRIGRAMS[lKey].name;const inv=(k)=>k.split('').map(x=>x==='1'?'0':'1').join('');if(tian&&ren&&di){shi=6;pName=uName;}else if(tian&&ren&&!di){shi=1;pName=uName;}else if(tian&&!ren&&!di){shi=2;pName=uName;}else if(!tian&&!ren&&!di){shi=3;pName=uName;}else if(!tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;}else if(!tian&&ren&&di){shi=5;pName=TRIGRAMS[inv(lKey)].name;}else if(tian&&!ren&&di){shi=4;pName=TRIGRAMS[inv(lKey)].name;isYou=true;}else if(!tian&&ren&&!di){shi=3;pName=lName;isGui=true;}const pEl=NA_JIA[pName]?TRIGRAMS[Object.keys(TRIGRAMS).find(k=>TRIGRAMS[k].name===pName)].element:'金';let oIdx=0;if(shi===6)oIdx=0;else if(shi===1)oIdx=1;else if(shi===2)oIdx=2;else if(shi===3&&!isGui)oIdx=3;else if(shi===4&&!isYou)oIdx=4;else if(shi===5)oIdx=5;else if(isYou)oIdx=6;else if(isGui)oIdx=7;let pIndex=['乾','坎','艮','震','巽','离','坤','兑'].indexOf(pName);if(pIndex===-1)pIndex=0;return{fullName:PALACES[pIndex][oIdx],palace:pName,palaceIndex:pIndex,element:pEl,shiIndex:shi-1,yingIndex:(shi-1+3)%6};};
            const mountHexagram=(bits,info,mov,isM,overrideEl)=>{const lName=TRIGRAMS[''+bits[2]+bits[1]+bits[0]].name,uName=TRIGRAMS[''+bits[5]+bits[4]+bits[3]].name;const lines=[],pEl=overrideEl||info.element;for(let i=0;i<6;i++){const isY=bits[i]===1,rule=i<3?NA_JIA[lName]:NA_JIA[uName];const st=i<3?rule[0]:rule[2],br=i<3?rule[1][i]:rule[3][i-3];const wx=WUXING_MAP[br],rel=getLiuQin(pEl,wx);lines.push({index:i,isYang:isY,stem:st,branch:br,wuxing:wx,relation:rel,shi:isM&&i===info.shiIndex,ying:isM&&i===info.yingIndex,isMoving:isM&&mov.includes(i),isMovingOrigin:!isM&&mov.includes(i)});}return{lines};};
            const getLiuQin=(p,l)=>{const gens={'木':'火','火':'土','土':'金','金':'水','水':'木'},cons={'木':'土','土':'水','水':'火','火':'金','金':'木'};if(p===l)return'兄弟';if(gens[l]===p)return'父母';if(gens[p]===l)return'子孙';if(cons[l]===p)return'官鬼';if(cons[p]===l)return'妻财';return'未知';};
            const getRelationClass = (r) => { if(r==='官鬼') return 'text-purple-700'; if(r==='妻财') return 'text-green-700'; if(r==='子孙') return 'text-blue-700'; if(r==='兄弟') return 'text-orange-700'; return 'text-stone-600'; };

            return { 
                mode, step, question, inputLines, isShaking, lastCoins, statusText, currentChart, lunarInfo, 
                baziInput, baziChart, analysisDate, selectedDaYunIndex, toast, 
                t, toggleLang, switchMode, nextStep, shake, resetAll, contactWhatsApp, contactWeChat, copyWeChatIDOnly, getRelationClass, translateTerm, getWuXingColor, getWuXingHex, canProceed, MY_WECHAT_ID,
                updateAnalysis, selectDaYun
            };
        }
    }).mount('#app');
</script>
</body>
</html>
